# Casbin RBAC 模型配置文件
# 文档: https://casbin.org/docs/syntax-for-models
#
# 本配置支持单一企业和多租户两种模式：
# 1. 支持通配符权限匹配 (例如: user.*, *.read, *)
# 2. 支持多租户扩展（通过配置开关控制）
# 3. super_admin 角色自动拥有所有权限（超级管理员）
#
# 当前模式：单一企业模式（MULTI_TENANT_MODE=false）
# 未来扩展：修改配置即可切换为多租户模式

# ============================================================
# [request_definition] 请求定义
# ============================================================
# 单一企业模式（当前）：
# - sub: 主体（subject），即发起请求的用户ID，格式: "user::{userId}"
# - obj: 对象（object），即要访问的资源，格式: "user.create", "device.read" 等
# - act: 动作（action），即操作类型，格式: "read", "write", "delete" 等
#
# 示例请求: ("user::1001", "user.create", "write")
# 含义: 用户1001 请求对 user.create 资源执行 write 操作
#
# 多租户模式（未来）：
# r = sub, dom, obj, act
# 示例: ("user::1001", "tenant::1", "user.create", "write")
[request_definition]
r = sub, obj, act

# ============================================================
# [policy_definition] 策略定义
# ============================================================
# 单一企业模式（当前）：
# - sub: 主体，可以是用户或角色，格式: "role::{roleKey}"
# - obj: 对象，即资源路径，支持通配符，例如: "user.*", "*.read", "*"
# - act: 动作，即操作类型，支持通配符，例如: "read", "write", "*"
#
# 示例策略:
# p, role::super_admin, *, * - super_admin角色拥有所有权限
# p, role::user_manager, user.*, write - user_manager角色拥有用户模块的写权限
# p, role::viewer, *.read, read - viewer角色拥有所有模块的读权限
#
# 多租户模式（未来）：
# p = sub, dom, obj, act
# 示例: p, role::admin, tenant::1, user.*, write
[policy_definition]
p = sub, obj, act

# ============================================================
# [role_definition] 角色定义
# ============================================================
# 单一企业模式（当前）：
# - 第1个参数: 用户，格式: "user::{userId}"
# - 第2个参数: 角色，格式: "role::{roleKey}"
#
# 示例:
# g, user::1001, role::super_admin - 用户1001拥有super_admin角色
#
# 多租户模式（未来）：
# g = _, _, _
# 示例: g, user::1001, role::admin, tenant::1
[role_definition]
g = _, _

# ============================================================
# [policy_effect] 策略效果
# ============================================================
# 定义多个策略匹配时的决策逻辑
# some(where (p.eft == allow)) - 只要有一条策略允许，就允许访问
# 这是最常用的配置，支持"白名单"模式
[policy_effect]
e = some(where (p.eft == allow))

# ============================================================
# [matchers] 匹配器
# ============================================================
# 单一企业模式（当前）：
# 匹配规则说明：
# 1. g(r.sub, p.sub) - 检查用户是否拥有策略中的角色
# 2. keyMatch2(r.obj, p.obj) - 使用通配符匹配资源路径
#    - keyMatch2 支持 * 通配符
#    - 例如: "user.create" 匹配 "user.*"
#    - 例如: "device.read" 匹配 "*.read"
#    - 例如: "anything" 匹配 "*"
# 3. keyMatch2(r.act, p.act) - 使用通配符匹配操作类型
# 4. p.sub == "role::super_admin" - 特殊规则：super_admin 角色自动拥有所有权限
#
# 完整逻辑：
# 如果用户拥有 super_admin 角色，或者用户的角色权限匹配请求，则允许访问
[matchers]
m = g(r.sub, p.sub) && keyMatch2(r.obj, p.obj) && keyMatch2(r.act, p.act) || p.sub == "role::super_admin" && g(r.sub, p.sub)

# 多租户模式（未来启用时取消注释）：
# m = g(r.sub, p.sub, r.dom) && r.dom == p.dom && keyMatch2(r.obj, p.obj) && keyMatch2(r.act, p.act) || p.sub == "role::super_admin" && g(r.sub, p.sub, r.dom) && r.dom == p.dom

# ============================================================
# 使用示例（单一企业模式）
# ============================================================
#
# 1. 创建角色权限策略:
#    p, role::super_admin, *, *
#    p, role::user_manager, user.*, write
#    p, role::viewer, *.read, read
#
# 2. 分配用户角色:
#    g, user::1001, role::super_admin
#    g, user::1002, role::user_manager
#
# 3. 权限检查:
#    Enforce("user::1001", "user.create", "write") -> true (super_admin拥有所有权限)
#    Enforce("user::1002", "user.delete", "write") -> true (匹配 user.*)
#    Enforce("user::1002", "device.read", "read") -> false (无device权限)
#
# 4. 通配符示例:
#    user.* - 用户模块所有操作 (user.create, user.read, user.update, user.delete)
#    *.read - 所有模块的读操作 (user.read, device.read, role.read)
#    * - 所有权限（超级管理员）
#
# ============================================================
# 多租户模式示例（未来启用时）
# ============================================================
#
# 1. 创建角色权限策略:
#    p, role::super_admin, tenant::1, *, *
#    p, role::user_manager, tenant::1, user.*, write
#
# 2. 分配用户角色:
#    g, user::1001, role::super_admin, tenant::1
#    g, user::1002, role::user_manager, tenant::1
#
# 3. 权限检查:
#    Enforce("user::1001", "tenant::1", "user.create", "write") -> true
