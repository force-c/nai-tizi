# 代码规范

## 1. 数据库表命名规范

### 1.1 表名前缀

| 类型 | 前缀 | 说明 | 示例 |
|------|------|------|------|
| 系统表 | `s_` | system | `s_user`, `s_role`, `s_org` |
| 业务表 | `biz_` | business | `biz_message_retry`, `biz_order` |

### 1.2 字段命名

**系统表字段：**
- 主键：`表名_id`（例如：`user_id`, `role_id`）
- 时间字段：`created_at`, `updated_at`, `deleted_at`
- 排序字段：`sort_order`
- 创建/更新者：`create_by`, `update_by`

**业务表字段：**
- 主键：`表名_id`（例如：`retry_id`, `order_id`）
- 时间字段：`create_time`, `update_time`
- 根据业务需求决定是否需要软删除

### 1.3 软删除

- 系统表：支持软删除（`deleted_at` 字段）
- 业务表：根据业务需求决定

## 2. 代码文件命名规范

### 2.1 Model 层（`internal/domain/model/`）

**规则：文件名必须与表名保持一致**

| 表名 | 文件名 | 结构体名 |
|------|--------|----------|
| `s_user` | `s_user.go` | `User` |
| `s_role` | `s_role.go` | `Role` |
| `s_auth_client` | `s_client.go` | `AuthClient` |
| `biz_message_retry` | `message_retry.go` | `BizMessageRetry` |

**说明：**
- 文件名包含表前缀（`s_`, `biz_`）
- 结构体名不包含前缀，使用业务语义命名
- 结构体通过 `TableName()` 方法指定实际表名

**示例：**

```go
// 文件：internal/domain/model/s_user.go
type User struct {
    UserId   int64  `gorm:"column:user_id;primaryKey"`
    UserName string `gorm:"column:user_name"`
    // ...
}

func (*User) TableName() string {
    return "s_user"
}
```

```go
// 文件：internal/domain/model/message_retry.go
type BizMessageRetry struct {
    RetryId   int64  `gorm:"column:retry_id;primaryKey"`
    MessageId string `gorm:"column:message_id"`
    // ...
}

func (*BizMessageRetry) TableName() string {
    return "biz_message_retry"
}
```

### 2.2 Service 层（`internal/service/`）

**规则：文件名不需要表前缀，使用业务语义**

| 业务模块 | 文件名 | 说明 |
|----------|--------|------|
| 用户服务 | `sys_user.go` | 系统用户相关业务 |
| 角色服务 | `s_role.go` | 角色管理业务 |
| 认证服务 | `auth.go` | 认证相关业务 |
| 客户端服务 | `sys_client.go` | 客户端配置业务 |
| 消息重试服务 | `message_retry.go` | 消息重试业务 |

**说明：**
- 文件名体现业务功能，不强制要求表前缀
- 接口和实现使用业务语义命名

**示例：**

```go
// 文件：internal/service/auth.go
type AuthService interface {
    Login(ctx context.Context, req *LoginRequest) (*LoginResponse, error)
    // ...
}

type authService struct {
    db *gorm.DB
    // ...
}
```

### 2.3 Controller 层（`internal/controller/`）

**规则：文件名使用业务模块名，不需要表前缀**

| 业务模块 | 文件名 | 说明 |
|----------|--------|------|
| 用户管理 | `sys_user.go` | 用户相关接口 |
| 角色管理 | `role.go` | 角色相关接口 |
| 认证 | `auth.go` | 登录/登出接口 |

**示例：**

```go
// 文件：internal/controller/auth.go
type AuthController struct {
    authService service.AuthService
}

func (c *AuthController) Login(ctx *gin.Context) {
    // ...
}
```

### 2.4 Request/Response 层（`internal/domain/request/`, `internal/domain/response/`）

**规则：文件名与 Controller 对应，使用业务模块名**

| 业务模块 | Request 文件 | Response 文件 |
|----------|--------------|---------------|
| 用户管理 | `sys_user.go` | `sys_user.go` |
| 角色管理 | `role.go` | `role.go` |
| 认证 | `auth.go` | `auth.go` |

## 3. 结构体命名规范

### 3.1 Model 结构体

- 不使用表前缀
- 使用业务语义的驼峰命名
- 通过 `TableName()` 方法映射到实际表名

**示例：**

```go
type User struct { ... }           // 对应表：s_user
type Role struct { ... }           // 对应表：s_role
type AuthClient struct { ... }     // 对应表：s_auth_client
type BizMessageRetry struct { ... } // 对应表：biz_message_retry
```

### 3.2 Service/Controller 结构体

- 使用业务语义命名
- 接口名：`XxxService`, `XxxController`
- 实现名：`xxxService`, `xxxController`（首字母小写）

## 4. 时间字段规范

### 4.1 系统表

使用 GORM 标准时间字段：

```go
CreatedAt time.Time      `gorm:"column:created_at;autoCreateTime"`
UpdatedAt time.Time      `gorm:"column:updated_at;autoUpdateTime"`
DeletedAt gorm.DeletedAt `gorm:"column:deleted_at;index"`
```

### 4.2 业务表

使用自定义时间字段：

```go
CreateTime time.Time `gorm:"column:create_time;autoCreateTime"`
UpdateTime time.Time `gorm:"column:update_time;autoUpdateTime"`
```

## 5. 数据库操作规范

### 5.1 禁用 GORM AutoMigrate

- 所有表结构通过 SQL 脚本手动创建
- 脚本位置：`scripts/sql/pgsql.sql`
- 初始化数据：`scripts/sql/insert.sql`

### 5.2 SQL 脚本规范

- 使用 `CREATE TABLE IF NOT EXISTS` 确保幂等性
- 使用 `ON CONFLICT DO NOTHING` 避免重复插入
- 添加必要的索引和注释

## 6. 快速参考

### 6.1 新增系统表

1. 在 `scripts/sql/pgsql.sql` 中添加建表语句（表名：`s_xxx`）
2. 在 `internal/domain/model/` 创建 `s_xxx.go` 文件
3. 定义结构体（不带 `s_` 前缀）
4. 实现 `TableName()` 方法返回 `s_xxx`
5. 在 `internal/service/` 创建对应服务（文件名可选前缀）
6. 在 `internal/controller/` 创建对应控制器（文件名不带前缀）

### 6.2 新增业务表

1. 在 `scripts/sql/pgsql.sql` 中添加建表语句（表名：`biz_xxx`）
2. 在 `internal/domain/model/` 创建 `xxx.go` 文件（不带 `biz_` 前缀）
3. 定义结构体（可选 `Biz` 前缀）
4. 实现 `TableName()` 方法返回 `biz_xxx`
5. 在 `internal/service/` 创建对应服务
6. 在 `internal/controller/` 创建对应控制器

## 7. 示例对照表

| 层级 | 系统表示例 | 业务表示例 |
|------|-----------|-----------|
| 数据库表名 | `s_user` | `biz_message_retry` |
| Model 文件 | `s_user.go` | `message_retry.go` |
| Model 结构体 | `User` | `BizMessageRetry` |
| Service 文件 | `sys_user.go` | `message_retry.go` |
| Controller 文件 | `sys_user.go` | `message_retry.go` |
| Request 文件 | `sys_user.go` | `message_retry.go` |
| Response 文件 | `sys_user.go` | `message_retry.go` |

---

**最后更新：** 2024-12-20
