# 参数校验优化规范

## 优化目标

1. **统一 Request 定义** - Controller 和 Service 共用 `domain/request` 包中的结构体
2. **减少重复代码** - 避免 Controller 和 Service 层重复定义相同的请求结构
3. **分层校验策略** - 根据参数来源选择合适的校验方式
4. **提高可维护性** - 集中管理校验规则，便于修改和扩展

---

## 参数传递规范

### 核心规则：参数数量决定传递方式

**规则 1：参数 ≤ 3 个**
- 可以使用 Query 参数、Form 参数或路径参数
- 适合简单的查询、筛选场景

**规则 2：参数 > 3 个**
- **强制使用 JSON Body 传参**
- 避免使用 multipart/form-data（除非必须上传文件）
- 提高可读性和可维护性

**规则 3：文件上传场景**
- 如果只上传文件 + ≤ 3 个参数：使用 multipart/form-data
- 如果上传文件 + > 3 个参数：考虑分两步（先上传文件获取 ID，再用 JSON 提交其他参数）

---

## 校验策略

### 策略 1：JSON Body 参数 → 结构体 + binding 标签

**适用场景：**
- POST/PUT 请求的 JSON Body
- **参数较多（> 3 个）- 强制使用**
- 需要复杂校验规则

**实现方式：**
```go
// 1. 在 domain/request 包定义结构体
type CreateUserRequest struct {
    UserName string `json:"userName" binding:"required,min=3,max=20"`
    Password string `json:"password" binding:"required,min=6"`
    Email    string `json:"email" binding:"omitempty,email"`
}

// 2. Controller 中使用
func (c *UserController) Create(ctx *gin.Context) {
    var req request.CreateUserRequest
    if err := ctx.ShouldBindJSON(&req); err != nil {
        response.BadRequest(ctx, "参数错误: "+err.Error())
        return
    }
    // 调用 Service，直接传递 req
    if err := c.userService.Create(ctx.Request.Context(), &req); err != nil {
        // ...
    }
}

// 3. Service 接收 request 结构体
func (s *userService) Create(ctx context.Context, req *request.CreateUserRequest) error {
    // 业务逻辑
}
```

---

### 策略 2：Multipart Form 参数 → 结构体 + binding 标签

**适用场景：**
- 文件上传（必须场景）
- **仅当参数 ≤ 3 个时使用**
- **参数 > 3 个时，考虑改用 JSON + 文件分离方案**

**⚠️ 注意：** `UploadAttachmentRequest` 当前有 7 个参数，不符合规范。建议优化为：
```go
// 方案 1：先上传文件，返回文件 ID，再用 JSON 绑定业务信息
POST /api/v1/attachments/upload-file  // 只上传文件，返回 fileId
POST /api/v1/attachments/bind         // JSON Body 绑定业务信息

// 方案 2：如果必须一次性上传，考虑将业务信息作为 JSON 字符串传递
type UploadAttachmentRequest struct {
    File     *multipart.FileHeader `form:"file" binding:"required"`
    Metadata string                `form:"metadata"` // JSON 字符串
}
```

**实现方式：**
```go
// 1. 定义支持文件上传的结构体
type UploadAttachmentRequest struct {
    File          *multipart.FileHeader `form:"file" binding:"required"`
    EnvCode       string                `form:"envCode"`
    BusinessType  string                `form:"businessType"`
    BusinessId    string                `form:"businessId"`
    IsPublic      bool                  `form:"isPublic"`
}

// 2. Controller 中使用
func (c *AttachmentController) Upload(ctx *gin.Context) {
    var req request.UploadAttachmentRequest
    if err := ctx.ShouldBind(&req); err != nil {
        response.BadRequest(ctx, "参数错误: "+err.Error())
        return
    }
    // 调用 Service
}
```

---

### 策略 3：Query 参数 → 结构体 + binding 标签

**适用场景：**
- GET 请求的查询参数
- 列表查询、筛选条件

**实现方式：**
```go
// 1. 定义 Query 参数结构体
type ListUsersRequest struct {
    PageNum     int    `form:"pageNum" binding:"omitempty,min=1"`
    PageSize    int    `form:"pageSize" binding:"omitempty,min=1,max=100"`
    UserName    string `form:"userName"`
    Status      string `form:"status" binding:"omitempty,oneof=0 1"`
}

// 2. Controller 中使用
func (c *UserController) List(ctx *gin.Context) {
    var req request.ListUsersRequest
    if err := ctx.ShouldBindQuery(&req); err != nil {
        response.BadRequest(ctx, "参数错误: "+err.Error())
        return
    }
    // 设置默认值
    if req.PageNum == 0 {
        req.PageNum = 1
    }
    if req.PageSize == 0 {
        req.PageSize = 10
    }
    // 调用 Service
}
```

---

### 策略 4：路径参数 → Validator API 校验

**适用场景：**
- RESTful 风格的路径参数（如 `/users/:id`）
- 单个简单参数

**实现方式：**
```go
// 1. 创建通用的路径参数解析和校验函数
func ParseInt64Param(ctx *gin.Context, paramName string) (int64, error) {
    paramStr := ctx.Param(paramName)
    if paramStr == "" {
        return 0, fmt.Errorf("%s不能为空", paramName)
    }
    
    value, err := strconv.ParseInt(paramStr, 10, 64)
    if err != nil {
        return 0, fmt.Errorf("%s格式错误", paramName)
    }
    
    // 使用 Validator API 校验
    validate := validator.New()
    if err := validate.Var(value, "required,gt=0"); err != nil {
        return 0, fmt.Errorf("%s必须大于0", paramName)
    }
    
    return value, nil
}

// 2. Controller 中使用
func (c *UserController) GetById(ctx *gin.Context) {
    userId, err := ParseInt64Param(ctx, "id")
    if err != nil {
        response.BadRequest(ctx, err.Error())
        return
    }
    // 调用 Service
}
```

---

## 优化清单

### 1. AttachmentController

| 方法 | 当前问题 | 优化方案 |
|------|---------|---------|
| UploadAttachment | 手动解析 Form 参数，Service 层重复定义 UploadRequest | 定义 `request.UploadAttachmentRequest`，使用 `ShouldBind` |
| DownloadAttachment | 手动解析路径参数 | 使用 `ParseInt64Param` 工具函数 |
| DeleteAttachment | 手动解析路径参数 | 使用 `ParseInt64Param` 工具函数 |
| GetAttachmentURL | 手动解析路径参数和 Query 参数 | 路径参数用工具函数，Query 参数定义结构体 |
| GetAttachment | 手动解析路径参数 | 使用 `ParseInt64Param` 工具函数 |
| ListAttachmentsByBusiness | 手动校验 Query 参数 | 定义 `request.ListAttachmentsByBusinessRequest` |
| BindAttachmentToBusiness | 手动解析和校验参数 | 定义 `request.BindAttachmentRequest` |

### 2. StorageEnvController

| 方法 | 当前问题 | 优化方案 |
|------|---------|---------|
| DeleteStorageEnv | 手动解析路径参数 | 使用 `ParseInt64Param` 工具函数 |
| GetStorageEnv | 手动解析路径参数 | 使用 `ParseInt64Param` 工具函数 |
| ListStorageEnvs | 手动解析 Query 参数 | 定义 `request.ListStorageEnvsRequest` |

### 3. UserController

| 方法 | 当前问题 | 优化方案 |
|------|---------|---------|
| Create | 匿名结构体，Service 接收 model.User | 定义 `request.CreateUserRequest`，Service 接收 Request |
| Update | 匿名结构体，Service 接收 model.User | 定义 `request.UpdateUserRequest`，Service 接收 Request |
| Delete | 手动解析路径参数 | 使用 `ParseInt64Param` 工具函数 |
| BatchDelete | 匿名结构体 | 定义 `request.BatchDeleteUsersRequest` |
| GetById | 手动解析路径参数 | 使用 `ParseInt64Param` 工具函数 |
| List | 手动解析 Query 参数 | 定义 `request.ListUsersRequest` |
| BatchImport | 匿名结构体 | 定义 `request.BatchImportUsersRequest` |
| ResetPassword | 匿名结构体 | 定义 `request.ResetPasswordRequest` |

### 4. AuthController

| 方法 | 当前问题 | 优化方案 |
|------|---------|---------|
| SendSmsCode | 匿名结构体 | 定义 `request.SendSmsCodeRequest` |
| SendEmailCode | 匿名结构体 | 定义 `request.SendEmailCodeRequest` |

---

## 实施步骤

### 阶段 1：创建工具函数（优先级：高）

1. 创建 `internal/utils/param_parser.go`
   - `ParseInt64Param` - 解析和校验 int64 路径参数
   - `ParseIntParam` - 解析和校验 int 路径参数
   - `ParseBoolParam` - 解析和校验 bool 参数

### 阶段 2：优化 Request 定义（优先级：高）

1. 完善 `internal/domain/request/attachment.go`
   - 添加 `UploadAttachmentRequest`（替换 Service 层的 UploadRequest）
   - 完善 `ListAttachmentsByBusinessRequest`
   - 完善 `BindAttachmentRequest`

2. 完善 `internal/domain/request/storage_env.go`
   - 添加 `ListStorageEnvsRequest`

3. 创建 `internal/domain/request/user.go`
   - 添加所有用户相关的 Request 结构体

4. 完善 `internal/domain/request/auth.go`
   - 添加 `SendSmsCodeRequest`
   - 添加 `SendEmailCodeRequest`

### 阶段 3：重构 Controller（优先级：中）

1. 重构 `AttachmentController`
2. 重构 `StorageEnvController`
3. 重构 `UserController`
4. 重构 `AuthController`

### 阶段 4：重构 Service（优先级：中）

1. 修改 `AttachmentService` - 接收 `request.UploadAttachmentRequest`
2. 修改 `UserService` - 接收 Request 结构体而非 Model

### 阶段 5：测试和验证（优先级：高）

1. 编译验证
2. 单元测试
3. 集成测试

---

## 注意事项

1. **参数数量规范** - **参数 > 3 个时强制使用 JSON Body**
2. **向后兼容** - 如果有外部调用，需要保持接口兼容
3. **渐进式重构** - 一次重构一个 Controller，避免大规模改动
4. **测试覆盖** - 每次重构后都要进行测试
5. **文档更新** - 更新 Swagger 文档
6. **团队沟通** - 确保团队成员了解新的规范
7. **文件上传优化** - 参数过多时考虑文件上传与业务信息分离

---

## 收益评估

### 代码质量提升
- ✅ 减少重复代码 30%+
- ✅ 提高类型安全性
- ✅ 统一错误处理

### 开发效率提升
- ✅ 新增接口开发时间减少 20%
- ✅ 参数校验错误减少 50%+
- ✅ 代码审查效率提升 30%

### 可维护性提升
- ✅ 校验规则集中管理
- ✅ 易于扩展和修改
- ✅ 便于生成文档

---

**最后更新：** 2024-12-20
**状态：** 规范制定完成，待实施
