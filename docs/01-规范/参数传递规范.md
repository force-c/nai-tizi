# 参数传递规范

## 核心原则

**当参数数量 > 3 个时，强制使用 JSON Body 传参**

这个规则旨在：
1. 提高代码可读性和可维护性
2. 避免 URL 过长或 Form 参数过多
3. 统一参数传递方式
4. 便于参数校验和文档生成

---

## 参数传递方式选择

### 1. 路径参数（Path Parameters）

**适用场景：**
- RESTful 风格的资源标识
- 单个必需参数
- 资源 ID、唯一标识符

**示例：**
```
GET  /api/v1/users/:id
GET  /api/v1/attachments/:attachmentId/download
DELETE /api/v1/storage-envs/:envId
```

**规范：**
- ✅ 只用于资源标识
- ✅ 参数数量：1 个
- ❌ 不要用于业务参数

---

### 2. Query 参数（Query Parameters）

**适用场景：**
- GET 请求的查询条件
- 列表筛选、分页、排序
- **参数数量 ≤ 3 个**

**示例：**
```go
// ✅ 好的示例（参数 ≤ 3）
GET /api/v1/users?pageNum=1&pageSize=10&status=0

type ListUsersRequest struct {
    PageNum  int    `form:"pageNum"`
    PageSize int    `form:"pageSize"`
    Status   string `form:"status"`
}

// ❌ 不好的示例（参数 > 3）
GET /api/v1/users?pageNum=1&pageSize=10&userName=xxx&phonenumber=xxx&email=xxx&status=0
// 应该改用 POST + JSON Body
```

**规范：**
- ✅ 用于 GET 请求
- ✅ 参数数量 ≤ 3 个
- ✅ 简单的筛选条件
- ❌ 参数 > 3 个时改用 JSON Body

---

### 3. JSON Body 参数

**适用场景：**
- POST/PUT/PATCH 请求
- **参数数量 > 3 个（强制）**
- 复杂的数据结构
- 需要嵌套对象或数组

**示例：**
```go
// ✅ 好的示例（参数 > 3）
POST /api/v1/users
Content-Type: application/json

{
  "userName": "admin",
  "nickName": "管理员",
  "password": "123456",
  "email": "admin@example.com",
  "phonenumber": "13800138000",
  "status": "0"
}

type CreateUserRequest struct {
    UserName    string `json:"userName" binding:"required"`
    NickName    string `json:"nickName" binding:"required"`
    Password    string `json:"password" binding:"required,min=6"`
    Email       string `json:"email" binding:"omitempty,email"`
    Phonenumber string `json:"phonenumber" binding:"omitempty,len=11"`
    Status      string `json:"status"`
}
```

**规范：**
- ✅ 参数 > 3 个时强制使用
- ✅ 用于 POST/PUT/PATCH 请求
- ✅ 支持复杂数据结构
- ✅ 便于参数校验和文档生成

---

### 4. Multipart Form 参数（文件上传）

**适用场景：**
- 必须上传文件的场景
- **仅当文件 + 其他参数 ≤ 3 个时使用**

**⚠️ 重要规则：**
- 如果文件 + 其他参数 > 3 个，考虑分两步：
  1. 先上传文件，返回文件 ID
  2. 再用 JSON Body 提交其他业务参数

**示例：**

#### ✅ 好的示例（参数 ≤ 3）
```go
POST /api/v1/attachments/upload
Content-Type: multipart/form-data

file: [binary]
envCode: default
isPublic: true

type SimpleUploadRequest struct {
    File     *multipart.FileHeader `form:"file" binding:"required"`
    EnvCode  string                `form:"envCode"`
    IsPublic bool                  `form:"isPublic"`
}
```

#### ❌ 不好的示例（参数 > 3）
```go
// 当前的 UploadAttachmentRequest 有 7 个参数
POST /api/v1/attachments/upload
Content-Type: multipart/form-data

file: [binary]
envCode: default
businessType: order
businessId: 123
businessField: invoice
isPublic: true
metadata: {"key": "value"}

type UploadAttachmentRequest struct {
    File          *multipart.FileHeader `form:"file" binding:"required"`
    EnvCode       string                `form:"envCode"`
    BusinessType  string                `form:"businessType"`
    BusinessId    string                `form:"businessId"`
    BusinessField string                `form:"businessField"`
    IsPublic      bool                  `form:"isPublic"`
    Metadata      string                `form:"metadata"`
}
```

#### ✅ 优化方案 1：分两步上传
```go
// 步骤 1：上传文件
POST /api/v1/attachments/upload-file
Content-Type: multipart/form-data

file: [binary]
envCode: default

type UploadFileRequest struct {
    File    *multipart.FileHeader `form:"file" binding:"required"`
    EnvCode string                `form:"envCode"`
}

// 返回：
{
  "fileId": "abc123",
  "fileName": "document.pdf",
  "fileSize": 1024000
}

// 步骤 2：绑定业务信息
POST /api/v1/attachments/:fileId/bind
Content-Type: application/json

{
  "businessType": "order",
  "businessId": "123",
  "businessField": "invoice",
  "isPublic": true,
  "metadata": {"key": "value"}
}

type BindAttachmentRequest struct {
    BusinessType  string                 `json:"businessType" binding:"required"`
    BusinessId    string                 `json:"businessId" binding:"required"`
    BusinessField string                 `json:"businessField"`
    IsPublic      bool                   `json:"isPublic"`
    Metadata      map[string]interface{} `json:"metadata"`
}
```

#### ✅ 优化方案 2：业务信息作为 JSON 字符串
```go
POST /api/v1/attachments/upload
Content-Type: multipart/form-data

file: [binary]
metadata: {"envCode":"default","businessType":"order","businessId":"123","isPublic":true}

type UploadAttachmentRequest struct {
    File     *multipart.FileHeader `form:"file" binding:"required"`
    Metadata string                `form:"metadata" binding:"required"` // JSON 字符串
}

// Controller 中解析 metadata
var metadata AttachmentMetadata
if err := json.Unmarshal([]byte(req.Metadata), &metadata); err != nil {
    return err
}
```

---

## 参数数量统计规则

### 计数规则

**包含在计数中：**
- ✅ 业务参数（如 userName、email、status）
- ✅ 文件参数（如 file）
- ✅ 可选参数（如 envCode）

**不包含在计数中：**
- ❌ 路径参数（如 `:id`）
- ❌ 认证 Token（如 Authorization header）
- ❌ 通用 Header（如 Content-Type、Accept）

### 示例

```go
// 示例 1：参数数量 = 3（符合规范）
GET /api/v1/users?pageNum=1&pageSize=10&status=0
// 计数：pageNum(1) + pageSize(2) + status(3) = 3 ✅

// 示例 2：参数数量 = 6（不符合规范）
POST /api/v1/users
{
  "userName": "admin",      // 1
  "nickName": "管理员",      // 2
  "password": "123456",     // 3
  "email": "admin@xx.com",  // 4
  "phonenumber": "138xxx",  // 5
  "status": "0"             // 6
}
// 计数：6 个参数，必须使用 JSON Body ✅

// 示例 3：参数数量 = 7（不符合规范）
POST /api/v1/attachments/upload
Content-Type: multipart/form-data

file: [binary]              // 1
envCode: default            // 2
businessType: order         // 3
businessId: 123             // 4
businessField: invoice      // 5
isPublic: true              // 6
metadata: {...}             // 7
// 计数：7 个参数，应该优化为分两步或 JSON 字符串 ❌
```

---

## 实施建议

### 新接口开发

1. **设计阶段** - 统计参数数量，选择合适的传递方式
2. **参数 ≤ 3** - 可以使用 Query/Form 参数
3. **参数 > 3** - 强制使用 JSON Body
4. **文件上传** - 评估是否需要分两步

### 现有接口优化

1. **识别问题接口** - 找出参数 > 3 但未使用 JSON 的接口
2. **评估影响** - 确认是否有外部调用
3. **制定方案** - 选择合适的优化方案
4. **渐进式重构** - 保持向后兼容或提供过渡期

### 当前需要优化的接口

目前所有接口均已符合参数传递规范。

---

## 常见问题

### Q1：为什么是 3 个参数作为分界线？

**A：** 基于以下考虑：
1. **可读性** - 3 个参数在 URL 或 Form 中仍然清晰可读
2. **维护性** - 超过 3 个参数后，维护成本显著增加
3. **行业实践** - 大多数 RESTful API 设计指南推荐类似规则
4. **用户体验** - 3 个参数在前端表单中也是合理的数量

### Q2：如果参数是可选的，也要计入数量吗？

**A：** 是的。可选参数也计入总数，因为：
1. 可选参数仍然需要校验和文档
2. 可选参数可能在未来变为必需
3. 统一规则更易于执行

### Q3：文件上传一定要分两步吗？

**A：** 不一定。根据实际情况选择：
- 如果文件 + 参数 ≤ 3：可以一次上传
- 如果文件 + 参数 > 3：推荐分两步，但也可以用 JSON 字符串方案
- 如果对性能要求高：可以考虑一次上传 + JSON 字符串

### Q4：现有接口不符合规范怎么办？

**A：** 渐进式优化：
1. **新接口** - 严格遵守规范
2. **现有接口** - 评估影响后逐步优化
3. **向后兼容** - 可以同时提供新旧两个接口
4. **文档标注** - 在文档中标注哪些接口不符合规范

---

## 检查清单

在开发新接口或优化现有接口时，使用以下检查清单：

- [ ] 统计参数数量（不包括路径参数和 Header）
- [ ] 参数 ≤ 3：可以使用 Query/Form 参数
- [ ] 参数 > 3：必须使用 JSON Body
- [ ] 文件上传 + 参数 > 3：考虑分两步或 JSON 字符串
- [ ] 定义 Request 结构体在 `domain/request` 包
- [ ] 添加 binding 标签进行参数校验
- [ ] 更新 Swagger 文档
- [ ] 编写单元测试

---

**制定时间：** 2024-12-20  
**适用范围：** 所有新开发接口和待优化接口  
**执行优先级：** 高
