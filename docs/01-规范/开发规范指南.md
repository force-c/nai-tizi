# 开发与架构规范指南

## 1. 架构概览

本项目采用 Go 语言开发，遵循现代化的后端架构设计，核心特点如下：

- **Web 框架**: 使用 [Gin](https://github.com/gin-gonic/gin) 处理 HTTP 请求
- **依赖注入**: 使用显式依赖注入（构造函数注入），避免容器注入带来的隐式依赖
- **分层架构**: Controller-Service-Model 三层架构，职责清晰
- **权限控制**: 使用 Casbin 实现 RBAC 权限管理，支持多租户隔离

## 2. 目录结构

```
github.com/force-c/nai-tizi/
├── cmd/api/                    # 程序入口和配置文件
│   ├── main.go                 # 程序入口
│   ├── conf.dev.yaml           # 开发环境配置
│   ├── casbin_model.conf       # Casbin 权限模型配置
│   └── zaplogger.*.yaml        # 日志配置
├── internal/
│   ├── config/                 # 配置管理
│   ├── container/              # 依赖注入容器（管理全局组件）
│   ├── controller/             # HTTP 接口层（参数解析、响应返回）
│   ├── domain/
│   │   ├── model/              # 数据模型（对应数据库表）
│   │   ├── request/            # 请求参数定义
│   │   └── response/           # 响应数据定义
│   ├── service/                # 业务逻辑层（业务编排、事务管理）
│   ├── repository/             # 数据访问层（可选，简单项目可省略）
│   ├── middleware/             # Gin 中间件（认证、日志、CORS 等）
│   ├── router/                 # 路由配置
│   ├── logger/                 # 日志封装
│   ├── infrastructure/         # 基础设施（MQTT、RabbitMQ、S3 等）
│   └── utils/                  # 通用工具函数
├── scripts/sql/                # 数据库脚本
│   ├── pgsql.sql               # 建表语句
│   └── insert.sql              # 初始化数据
└── docs/                       # 项目文档
    ├── 01-规范/                # 开发规范
    ├── 02-架构设计/            # 架构设计文档
    ├── 03-功能模块/            # 功能模块说明
    ├── 04-API文档/             # API 文档
    ├── 05-部署运维/            # 部署运维文档
    └── 06-测试报告/            # 测试报告
```

## 3. 核心开发规范

### 3.1 表命名规范

| 类型 | 前缀 | 说明 | 示例 |
|------|------|------|------|
| 系统表 | `s_` | system | `s_user`, `s_role`, `s_org` |
| 业务表 | `biz_` | business | `biz_message_retry`, `biz_order` |

**字段命名：**
- 系统表：`created_at`, `updated_at`, `deleted_at`, `sort_order`, `create_by`, `update_by`
- 业务表：`create_time`, `update_time`（根据需求决定是否软删除）
- 主键：`表名_id`（例如：`user_id`, `role_id`）

### 3.2 文件命名规范

#### Model 层（`internal/domain/model/`）

**规则：文件名必须与表名保持一致**

| 表名 | 文件名 | 结构体名 |
|------|--------|----------|
| `s_user` | `s_user.go` | `User` |
| `s_role` | `s_role.go` | `Role` |
| `biz_message_retry` | `message_retry.go` | `BizMessageRetry` |

**示例：**

```go
// 文件：internal/domain/model/s_user.go
type User struct {
    UserId    int64     `gorm:"column:user_id;primaryKey" json:"userId"`
    UserName  string    `gorm:"column:user_name" json:"userName"`
    OrgId     int64     `gorm:"column:org_id" json:"orgId"`
    Status    string    `gorm:"column:status" json:"status"`
    CreateBy  int64     `gorm:"column:create_by" json:"createBy"`
    CreatedAt time.Time `gorm:"column:created_at" json:"createdAt"`
    UpdateBy  int64     `gorm:"column:update_by" json:"updateBy"`
    UpdatedAt time.Time `gorm:"column:updated_at" json:"updatedAt"`
    DeletedAt gorm.DeletedAt `gorm:"column:deleted_at;index" json:"-"`
}

func (*User) TableName() string {
    return "s_user"
}
```

#### Service 层（`internal/service/`）

**规则：文件名使用业务语义，不强制要求表前缀**

| 业务模块 | 文件名 | 说明 |
|----------|--------|------|
| 用户服务 | `sys_user.go` | 系统用户相关业务 |
| 角色服务 | `role.go` | 角色管理业务 |
| 认证服务 | `auth.go` | 认证相关业务 |

#### Controller 层（`internal/controller/`）

**规则：文件名使用业务模块名，不需要表前缀**

| 业务模块 | 文件名 | 说明 |
|----------|--------|------|
| 用户管理 | `sys_user.go` | 用户相关接口 |
| 角色管理 | `role.go` | 角色相关接口 |
| 认证 | `auth.go` | 登录/登出接口 |

### 3.3 分层架构规范

#### Controller 层职责

Controller 只负责：
1. **参数解析和校验**：从 HTTP 请求中解析参数
2. **调用 Service**：调用对应的 Service 方法
3. **返回响应**：将 Service 返回的结果封装成 HTTP 响应

**不应该包含**：业务逻辑编排、多个 Service 的调用协调、事务管理、数据库操作

**示例：**

```go
func (c *RoleController) CreateRole(ctx *gin.Context) {
    // 1. 参数解析
    var req request.CreateRoleRequest
    if err := ctx.ShouldBindJSON(&req); err != nil {
        response.BadRequest(ctx, "参数错误: "+err.Error())
        return
    }

    // 2. 调用 Service
    role := &model.Role{
        RoleKey:   req.RoleKey,
        RoleName:  req.RoleName,
        // ...
    }
    if err := c.roleService.Create(ctx.Request.Context(), role); err != nil {
        response.InternalServerError(ctx, "创建角色失败: "+err.Error())
        return
    }

    // 3. 返回响应
    response.SuccessWithMsg(ctx, "创建角色成功", role)
}
```

#### Service 层职责

Service 负责：
1. **业务逻辑编排**：协调多个操作完成业务功能
2. **事务管理**：使用 `db.Transaction()` 确保数据一致性
3. **调用其他 Service**：Service 可以依赖其他 Service
4. **数据库操作**：通过 GORM 进行数据库操作
5. **错误处理和日志记录**

**示例：**

```go
func (s *roleService) AssignRoleToUser(ctx context.Context, userId, roleId, orgId int64) error {
    // 使用事务确保数据一致性
    return s.db.Transaction(func(tx *gorm.DB) error {
        // 1. 检查用户是否存在
        var user model.User
        if err := tx.Where("user_id = ?", userId).First(&user).Error; err != nil {
            return fmt.Errorf("用户不存在")
        }

        // 2. 检查角色是否存在
        var role model.Role
        if err := tx.Where("role_id = ?", roleId).First(&role).Error; err != nil {
            return fmt.Errorf("角色不存在")
        }

        // 3. 创建用户角色关联
        userRole := &model.SUserRole{
            UserId: userId,
            RoleId: roleId,
        }
        if err := tx.Create(userRole).Error; err != nil {
            return fmt.Errorf("分配用户角色失败: %w", err)
        }

        // 4. 同步到 Casbin
        if err := s.casbinService.AddRoleForUser(ctx, userId, role.RoleKey, orgId); err != nil {
            s.logger.Error("同步 Casbin 失败", zap.Error(err))
        }

        return nil
    })
}
```

### 3.4 依赖注入规范

**使用显式依赖注入（推荐）：**

```go
// Service 结构体
type roleService struct {
    db            *gorm.DB
    casbinService CasbinService  // 依赖其他 Service
    logger        logger.Logger
}

// 构造函数明确声明依赖
func NewRoleService(db *gorm.DB, casbinService CasbinService, logger logger.Logger) RoleService {
    return &roleService{
        db:            db,
        casbinService: casbinService,
        logger:        logger,
    }
}
```

**优点：**
- ✅ 依赖关系清晰可见
- ✅ 易于测试（Mock 单个 Service）
- ✅ 编译期检查依赖
- ✅ 符合依赖倒置原则

### 3.5 数据库操作规范

1. **禁用 GORM AutoMigrate**：所有表结构通过 SQL 脚本手动创建
2. **SQL 脚本位置**：
   - 建表语句：`scripts/sql/pgsql.sql`
   - 初始化数据：`scripts/sql/insert.sql`
3. **事务管理**：涉及多表操作或数据一致性要求高的场景必须使用事务

## 4. 认证与权限

### 4.1 双 Token 认证机制

- **AccessToken**：短期有效（默认 30 分钟），用于 API 访问
- **RefreshToken**：长期有效（默认 7 天），用于刷新 AccessToken
- **客户端配置**：通过 `s_auth_client` 表管理不同客户端的超时配置

详见：`docs/02-架构设计/双Token认证机制说明.md`

### 4.2 RBAC 权限控制

- **基于 Casbin**：实现灵活的 RBAC 权限控制
- **多租户隔离**：通过组织 ID（org_id）实现租户隔离
- **角色继承**：支持角色继承，子角色自动继承父角色权限
- **简化版 RBAC**：用户只属于一个组织，可以拥有多个角色

详见：`docs/02-架构设计/简化版RBAC方案.md`

## 5. 配置管理

### 5.1 配置文件位置

所有配置文件位于 `cmd/api/` 目录：
- `conf.dev.yaml` - 开发环境配置
- `conf.prod.yaml` - 生产环境配置（不提交到 Git）
- `casbin_model.conf` - Casbin 权限模型配置
- `zaplogger.dev.yaml` / `zaplogger.prod.yaml` - 日志配置

### 5.2 配置文件查找机制

程序启动时会按以下顺序查找配置文件：
1. 当前工作目录（支持 IDE 调试）
2. `cmd/api/` 目录（生产环境）
3. 可执行文件所在目录

## 6. 基础设施组件

### 6.1 日志 (Logger)
- 基于 Zap 封装，支持多级别、多输出（控制台/文件）
- 配置文件：`zaplogger.dev.yaml` / `zaplogger.prod.yaml`

### 6.2 数据库 (PostgreSQL)
- 使用 GORM 作为 ORM 框架
- 禁用 AutoMigrate，使用 SQL 脚本管理表结构
- 支持事务管理

### 6.3 缓存 (Redis)
- 用于 Token 存储、权限缓存等
- 支持分布式锁

### 6.4 消息队列
- **MQTT**：用于设备端通信，协议处理位于 `internal/infrastructure/mqtt`
- **RabbitMQ**：用于异步任务和解耦，封装位于 `internal/infrastructure/rabbitmq`

### 6.5 对象存储 (S3)
- 实现了通用的 S3 接口，可对接 MinIO、AWS S3 等

## 7. 相关文档

### 规范文档
- [代码规范](./代码规范.md) - 详细的命名规范和代码示例
- [Controller-Service分层重构说明](./Controller-Service分层重构说明.md) - 分层架构详细说明

### 架构设计
- [双Token认证机制说明](../02-架构设计/双Token认证机制说明.md)
- [简化版RBAC方案](../02-架构设计/简化版RBAC方案.md)
- [数据库主键配置说明](../02-架构设计/数据库主键配置说明.md)
- [数据模型规范化方案](../02-架构设计/数据模型规范化方案.md)

### 快速开始

1. **初始化数据库**：
   ```bash
   psql -U postgres -d your_database -f scripts/sql/pgsql.sql
   psql -U postgres -d your_database -f scripts/sql/insert.sql
   ```

2. **配置文件**：
   - 复制 `cmd/api/conf.dev.yaml` 为 `conf.prod.yaml`
   - 修改数据库、Redis、MQTT 等连接配置

3. **运行程序**：
   ```bash
   go run cmd/api/main.go
   # 或编译后运行
   go build -o bin/api cmd/api/main.go
   ./bin/api
   ```

4. **开发新功能**：
   - 在 `scripts/sql/pgsql.sql` 添加建表语句
   - 在 `internal/domain/model/` 创建对应的 Model
   - 在 `internal/service/` 实现业务逻辑
   - 在 `internal/controller/` 实现 HTTP 接口
   - 在 `internal/router/` 注册路由

---

**最后更新：** 2024-12-20
