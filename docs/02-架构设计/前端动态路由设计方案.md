# 前端动态路由设计方案

## 概述

本文档描述了前端动态路由系统的设计方案，支持通过后台管理系统配置菜单来动态生成前端路由和侧边栏菜单。

---

## 核心特性

### ✅ 已实现功能

1. **动态路由生成**
   - 从后端获取用户菜单树
   - 自动转换为 Vue Router 路由配置
   - 动态添加到路由表

2. **权限控制**
   - 基于菜单权限标识（perms）进行权限验证
   - 支持通配符权限（如 `user.*` 匹配 `user.create`, `user.read` 等）
   - 路由级别的权限控制

3. **菜单管理**
   - 支持三种菜单类型：目录(M)、菜单(C)、按钮(F)
   - 支持多级菜单嵌套
   - 支持菜单显示/隐藏控制

4. **组件懒加载**
   - 使用 Vite 的 glob import 实现组件懒加载
   - 自动匹配视图组件
   - 组件不存在时自动降级到 404 页面

5. **状态持久化**
   - 使用 sessionStorage 持久化权限和菜单数据
   - 关闭浏览器后自动清除
   - 避免重复请求后端接口

---

## 架构设计

### 1. 数据流

```
后端菜单表 (s_menu)
    ↓
后端 API (/api/v1/menus/user/tree)
    ↓
前端 Permission Store
    ↓
动态路由配置 (RouteRecordRaw[])
    ↓
Vue Router (router.addRoute)
    ↓
侧边栏菜单渲染
```

### 2. 核心模块

#### 2.1 类型定义 (`types/menu.d.ts`)

```typescript
// 菜单类型
export type MenuType = 'M' | 'C' | 'F';

// 菜单信息
export interface MenuInfo {
  menuId: number;
  menuName: string;
  parentId: number;
  sortOrder: number;
  path: string;
  component: string;
  menuType: MenuType;
  visible: string;
  status: string;
  perms: string;
  icon: string;
  children?: MenuInfo[];
}
```

#### 2.2 菜单 API (`api/menu/index.ts`)

```typescript
export const menuApi = {
  // 获取当前用户的菜单树
  getUserMenuTree: () => request.get<MenuInfo[]>('/api/v1/menus/user/tree'),
  
  // 其他菜单管理接口...
};
```

#### 2.3 权限 Store (`stores/permission.ts`)

核心方法：

- `generateRoutes()`: 生成动态路由
- `transformMenuToRoutes()`: 将菜单树转换为路由配置
- `createRoute()`: 创建单个路由
- `loadViewComponent()`: 加载视图组件
- `hasPermission()`: 检查权限

#### 2.4 路由守卫 (`router/guards/index.ts`)

在路由守卫中处理动态路由加载：

```typescript
if (!permissionStore.isRoutesGenerated) {
  // 生成动态路由
  const dynamicRoutes = await permissionStore.generateRoutes();
  
  // 添加到路由表
  dynamicRoutes.forEach((route) => {
    router.addRoute(route);
  });
  
  // 重新导航
  next({ ...to, replace: true });
}
```

---

## 菜单配置规范

### 1. 菜单类型

| 类型 | 说明 | 是否生成路由 | 示例 |
|------|------|-------------|------|
| M (目录) | 菜单目录，可以包含子菜单 | 是 | 系统管理 |
| C (菜单) | 具体的菜单页面 | 是 | 用户管理 |
| F (按钮) | 页面内的操作按钮 | 否 | 新增按钮 |

### 2. 组件配置

#### 目录类型 (M)

- `component`: 使用布局组件
  - `Layout`: 默认布局（带侧边栏）
  - `BlankLayout`: 空白布局（只渲染子路由）

示例：
```sql
INSERT INTO s_menu (menu_name, parent_id, path, component, menu_type, ...)
VALUES ('系统管理', 0, '/system', 'Layout', 'M', ...);
```

#### 菜单类型 (C)

- `component`: 视图组件路径（相对于 `src/views/`）

示例：
```sql
INSERT INTO s_menu (menu_name, parent_id, path, component, menu_type, ...)
VALUES ('用户管理', 1, 'user', 'system/user/index', 'C', ...);
```

最终会加载组件：`/src/views/system/user/index.vue`

### 3. 路径配置

#### 根路径（以 `/` 开头）

```sql
path = '/system'  -- 访问路径: /system
```

#### 相对路径（不以 `/` 开头）

```sql
parent_id = 1     -- 父菜单路径: /system
path = 'user'     -- 访问路径: /system/user
```

### 4. 权限标识 (perms)

支持以下格式：

- 精确匹配：`user.create`, `user.read`, `user.update`, `user.delete`
- 通配符匹配：`user.*` (匹配所有 user 开头的权限)
- 全局权限：`*` (超级管理员)

示例：
```sql
-- 用户管理菜单
perms = 'user.read'

-- 新增用户按钮
perms = 'user.create'

-- 用户管理所有权限
perms = 'user.*'
```

---

## 使用示例

### 1. 后端配置菜单

```sql
-- 1. 创建系统管理目录
INSERT INTO s_menu (menu_id, menu_name, parent_id, sort_order, path, component, menu_type, visible, status, perms, icon)
VALUES (1, '系统管理', 0, 1, '/system', 'Layout', 'M', '0', '0', '', 'setting');

-- 2. 创建用户管理菜单
INSERT INTO s_menu (menu_id, menu_name, parent_id, sort_order, path, component, menu_type, visible, status, perms, icon)
VALUES (101, '用户管理', 1, 1, 'user', 'system/user/index', 'C', '0', '0', 'user.read', 'user');

-- 3. 创建用户管理按钮
INSERT INTO s_menu (menu_id, menu_name, parent_id, sort_order, path, component, menu_type, visible, status, perms, icon)
VALUES (1011, '新增用户', 101, 1, '', '', 'F', '0', '0', 'user.create', '#');

-- 4. 为角色分配菜单权限
INSERT INTO s_role_menu (role_id, menu_id)
VALUES (1, 1), (1, 101), (1, 1011);
```

### 2. 前端创建视图组件

创建文件：`src/views/system/user/index.vue`

```vue
<template>
  <div class="user-page">
    <h1>用户管理</h1>
    
    <!-- 按钮权限控制 -->
    <a-button 
      v-if="hasPermission('user.create')" 
      type="primary"
      @click="handleCreate"
    >
      新增用户
    </a-button>
    
    <!-- 用户列表 -->
    <a-table :dataSource="userList" />
  </div>
</template>

<script setup lang="ts">
import { usePermissionStore } from '@/stores/permission';

const permissionStore = usePermissionStore();
const hasPermission = permissionStore.hasPermission;

// 页面逻辑...
</script>
```

### 3. 权限检查

#### 在模板中

```vue
<!-- 按钮级权限 -->
<a-button v-if="hasPermission('user.create')">新增</a-button>

<!-- 区域级权限 -->
<div v-if="hasPermission('user.update')">
  <!-- 编辑表单 -->
</div>
```

#### 在脚本中

```typescript
import { usePermissionStore } from '@/stores/permission';

const permissionStore = usePermissionStore();

if (permissionStore.hasPermission('user.delete')) {
  // 执行删除操作
}
```

---

## 路由配置示例

### 后端菜单配置

```sql
-- 系统管理（目录）
{
  menuId: 1,
  menuName: '系统管理',
  parentId: 0,
  path: '/system',
  component: 'Layout',
  menuType: 'M',
  icon: 'setting',
  children: [
    -- 用户管理（菜单）
    {
      menuId: 101,
      menuName: '用户管理',
      parentId: 1,
      path: 'user',
      component: 'system/user/index',
      menuType: 'C',
      perms: 'user.read',
      icon: 'user'
    }
  ]
}
```

### 生成的前端路由

```typescript
{
  path: '/system',
  name: 'System',
  component: () => import('@/layouts/default/index.vue'),
  meta: {
    title: '系统管理',
    icon: 'setting',
    requiresAuth: true
  },
  children: [
    {
      path: 'user',
      name: 'SystemUser',
      component: () => import('@/views/system/user/index.vue'),
      meta: {
        title: '用户管理',
        icon: 'user',
        permission: 'user.read',
        requiresAuth: true
      }
    }
  ]
}
```

---

## 开发流程

### 1. 新增业务模块

#### 步骤 1: 后端配置菜单

在数据库中添加菜单记录：

```sql
-- 添加存储管理目录
INSERT INTO s_menu (menu_name, parent_id, path, component, menu_type, icon, sort_order)
VALUES ('存储管理', 0, '/storage', 'Layout', 'M', 'cloud', 3);

-- 添加文件管理菜单
INSERT INTO s_menu (menu_name, parent_id, path, component, menu_type, perms, icon, sort_order)
VALUES ('文件管理', 3, 'file', 'storage/file/index', 'C', 'file.read', 'file', 1);
```

#### 步骤 2: 创建视图组件

创建文件：`src/views/storage/file/index.vue`

```vue
<template>
  <div class="file-page">
    <h1>文件管理</h1>
    <!-- 页面内容 -->
  </div>
</template>

<script setup lang="ts">
// 页面逻辑
</script>
```

#### 步骤 3: 分配权限

为角色分配菜单权限：

```sql
INSERT INTO s_role_menu (role_id, menu_id)
SELECT 1, menu_id FROM s_menu WHERE menu_name IN ('存储管理', '文件管理');
```

#### 步骤 4: 测试

1. 重新登录系统
2. 侧边栏会自动显示新菜单
3. 点击菜单可以访问新页面

### 2. 修改菜单配置

直接在数据库中修改菜单记录，用户重新登录后生效：

```sql
-- 修改菜单名称
UPDATE s_menu SET menu_name = '用户列表' WHERE menu_id = 101;

-- 修改菜单图标
UPDATE s_menu SET icon = 'team' WHERE menu_id = 101;

-- 修改菜单排序
UPDATE s_menu SET sort_order = 10 WHERE menu_id = 101;

-- 隐藏菜单
UPDATE s_menu SET visible = '1' WHERE menu_id = 101;
```

---

## 注意事项

### 1. 组件路径规范

- 组件路径相对于 `src/views/` 目录
- 不需要 `.vue` 后缀（会自动添加）
- 使用 `/` 分隔目录

正确示例：
```
system/user/index
storage/file/index
dashboard/index
```

错误示例：
```
/src/views/system/user/index.vue  ❌ (不要包含 /src/views/)
system/user/index.vue             ❌ (不要包含 .vue 后缀)
system\user\index                 ❌ (使用 / 而不是 \)
```

### 2. 路径配置规范

- 根路径以 `/` 开头
- 子路径不要以 `/` 开头
- 路径不要以 `/` 结尾

正确示例：
```sql
-- 根路径
path = '/system'

-- 子路径
parent_id = 1
path = 'user'  -- 最终路径: /system/user
```

错误示例：
```sql
path = 'system'   ❌ (根路径应该以 / 开头)
path = '/user'    ❌ (子路径不要以 / 开头)
path = '/system/' ❌ (不要以 / 结尾)
```

### 3. 权限标识规范

- 使用小写字母和点号
- 格式：`资源.操作`
- 支持通配符 `*`

正确示例：
```
user.read
user.create
user.*
*
```

错误示例：
```
User.Read     ❌ (不要使用大写)
user_read     ❌ (使用点号而不是下划线)
user read     ❌ (不要使用空格)
```

### 4. 菜单类型选择

| 场景 | 菜单类型 | 说明 |
|------|---------|------|
| 需要在侧边栏显示的目录 | M | 可以包含子菜单 |
| 需要在侧边栏显示的页面 | C | 具体的业务页面 |
| 页面内的操作按钮 | F | 不生成路由，只用于权限控制 |

### 5. 组件不存在的处理

如果配置的组件路径不存在，系统会：

1. 在控制台输出警告信息
2. 自动降级到 404 页面
3. 不会影响其他路由的加载

### 6. 刷新路由

如果修改了菜单配置，需要：

1. 清除浏览器 sessionStorage
2. 重新登录系统
3. 或者在开发环境中刷新页面

---

## 故障排查

### 问题 1: 菜单不显示

**可能原因：**
- 菜单的 `visible` 字段设置为 '1'（隐藏）
- 菜单的 `status` 字段设置为 '1'（停用）
- 角色没有分配该菜单权限
- 菜单类型设置为 'F'（按钮）

**解决方法：**
```sql
-- 检查菜单配置
SELECT * FROM s_menu WHERE menu_id = 101;

-- 检查角色权限
SELECT * FROM s_role_menu WHERE role_id = 1 AND menu_id = 101;

-- 修正配置
UPDATE s_menu SET visible = '0', status = '0' WHERE menu_id = 101;
```

### 问题 2: 点击菜单显示 404

**可能原因：**
- 组件路径配置错误
- 组件文件不存在
- 组件路径格式不正确

**解决方法：**
1. 检查组件路径配置
2. 确认组件文件存在
3. 查看浏览器控制台的警告信息

### 问题 3: 权限控制不生效

**可能原因：**
- 权限标识配置错误
- 角色没有分配权限
- 权限检查代码错误

**解决方法：**
```typescript
// 在浏览器控制台检查权限
import { usePermissionStore } from '@/stores/permission';
const permissionStore = usePermissionStore();
console.log(permissionStore.permissions);
console.log(permissionStore.hasPermission('user.create'));
```

---

## 性能优化

### 1. 组件懒加载

所有视图组件都使用懒加载，只有在访问时才会加载：

```typescript
component: () => import('@/views/system/user/index.vue')
```

### 2. 状态持久化

使用 sessionStorage 缓存菜单和权限数据，避免重复请求：

```typescript
persist: {
  key: 'permission',
  storage: sessionStorage,
  paths: ['permissions', 'menuTree', 'isRoutesGenerated'],
}
```

### 3. 路由懒加载

使用 Vite 的 glob import 实现按需加载：

```typescript
const viewModules = import.meta.glob('@/views/**/*.vue');
```

---

## 后续优化

### 1. 菜单管理界面

开发菜单管理页面，支持：
- 可视化配置菜单
- 拖拽排序
- 权限分配
- 实时预览

### 2. 路由缓存

实现路由级别的页面缓存（keep-alive）：

```typescript
meta: {
  keepAlive: true,  // 是否缓存页面
}
```

### 3. 面包屑导航

根据路由自动生成面包屑导航。

### 4. 标签页导航

实现多标签页导航，支持：
- 打开/关闭标签页
- 刷新当前标签页
- 关闭其他/所有标签页

---

## 相关文档

- [前端工程设计方案](./前端工程设计方案.md)
- [后端菜单管理 API 文档](../04-API文档/)
- [权限控制设计方案](./权限控制设计方案.md)

---

**文档版本：** v1.0.0  
**创建时间：** 2024-12-21  
**最后更新：** 2024-12-21
