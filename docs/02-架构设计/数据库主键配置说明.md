# 数据库主键配置说明

## 修改日期
2024-12-18

## 修改内容

为 `internal/domain/model` 目录下所有结构体的主键字段添加了 `primaryKey` 和 `autoIncrement` 标签，确保数据库表的主键正确配置为自增。

## 修改的文件

### 1. sys_user.go - 系统用户表
```go
// 修改前
UserId int64 `gorm:"column:user_id" json:"userId"`

// 修改后
UserId int64 `gorm:"column:user_id;primaryKey;autoIncrement" json:"userId"`
```

### 2. sys_dict.go - 字典数据表
```go
// 修改前
DictCode int64 `gorm:"column:dict_code" json:"dictCode"`

// 修改后
DictCode int64 `gorm:"column:dict_code;primaryKey;autoIncrement" json:"dictCode"`
```

### 3. sys_login_log.go - 登录日志表
```go
// 修改前
Id int64 `gorm:"column:info_id" json:"infoId"`

// 修改后
Id int64 `gorm:"column:info_id;primaryKey;autoIncrement" json:"infoId"`
```

### 4. sys_oper_log.go - 操作日志表
```go
// 修改前
Id int64 `gorm:"column:oper_id" json:"operId"`

// 修改后
Id int64 `gorm:"column:oper_id;primaryKey;autoIncrement" json:"operId"`
```

### 5. message_retry.go - 消息重试表
```go
// 已正确配置
RetryId int64 `gorm:"column:retry_id;primaryKey;autoIncrement" json:"retryId"`
LogId   int64 `gorm:"column:log_id;primaryKey;autoIncrement" json:"logId"`
```

### 6. sys_client.go - 客户端配置表
```go
// 特殊情况：使用字符串作为主键（MD5生成）
ClientId string `gorm:"column:client_id;type:varchar(64);primaryKey;comment:客户端ID" json:"clientId"`
```

**说明**: `sys_client` 表的主键是字符串类型，由 `MD5(clientKey + clientSecret)` 生成，不使用自增。

## GORM 标签说明

### primaryKey
- 标记字段为主键
- GORM 会在创建表时将该字段设置为 PRIMARY KEY

### autoIncrement
- 标记字段为自增
- PostgreSQL 会自动创建 SEQUENCE 并关联到该字段
- 插入数据时如果不指定该字段的值，数据库会自动生成

## PostgreSQL 自增实现

PostgreSQL 使用 SERIAL 或 BIGSERIAL 类型实现自增：

```sql
-- GORM 会生成类似以下的 DDL
CREATE TABLE sys_user (
    user_id BIGSERIAL PRIMARY KEY,
    user_name VARCHAR(255),
    ...
);

-- 等价于
CREATE SEQUENCE sys_user_user_id_seq;
CREATE TABLE sys_user (
    user_id BIGINT PRIMARY KEY DEFAULT nextval('sys_user_user_id_seq'),
    user_name VARCHAR(255),
    ...
);
```

## 使用示例

### 创建记录（自动生成ID）
```go
user := &model.SysUser{
    UserName: "admin",
    NickName: "管理员",
    // 不需要设置 UserId，数据库会自动生成
}
db.Create(user)
// user.UserId 会被自动填充为数据库生成的ID
```

### 更新记录（使用ID）
```go
db.Model(&model.SysUser{}).
    Where("user_id = ?", userId).
    Updates(map[string]interface{}{
        "nick_name": "新昵称",
    })
```

### 删除记录（使用ID）
```go
db.Where("user_id = ?", userId).Delete(&model.SysUser{})
```

## 注意事项

1. **不要手动设置自增ID**
   - 创建记录时不要设置主键字段的值
   - 让数据库自动生成ID

2. **ID冲突**
   - 如果手动设置ID，可能会与数据库自动生成的ID冲突
   - 建议始终让数据库自动生成ID

3. **批量插入**
   - 批量插入时，每条记录的ID都会自动生成
   - 插入后可以通过结构体获取生成的ID

4. **特殊主键**
   - `sys_client` 表使用字符串主键，不使用自增
   - 通过 `BeforeCreate` 钩子自动生成 `clientId`

## 数据库迁移

如果数据库已经存在，需要修改表结构：

```sql
-- 为现有表添加自增序列（如果还没有）
CREATE SEQUENCE sys_user_user_id_seq;
ALTER TABLE sys_user ALTER COLUMN user_id SET DEFAULT nextval('sys_user_user_id_seq');
ALTER SEQUENCE sys_user_user_id_seq OWNED BY sys_user.user_id;

-- 设置序列的当前值为表中最大ID + 1
SELECT setval('sys_user_user_id_seq', (SELECT MAX(user_id) FROM sys_user));
```

## 验证

编译通过，无错误：
```bash
go build -o bin/api ./cmd/api
# Exit Code: 0
```

代码诊断通过，无警告。

## 相关文档

- [PostgreSQL 兼容性检查](./PostgreSQL兼容性检查.md)
- [GORM 文档 - 声明模型](https://gorm.io/zh_CN/docs/models.html)
- [PostgreSQL 文档 - Serial Types](https://www.postgresql.org/docs/current/datatype-numeric.html#DATATYPE-SERIAL)
