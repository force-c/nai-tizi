# 动态路由使用示例

本文档展示如何通过后台配置菜单来实现前端动态路由。

---

## 核心概念

### 什么是动态路由？

动态路由是指前端路由不是写死在代码中，而是从后端API动态获取并生成。

**优势：**
- ✅ 无需修改前端路由配置
- ✅ 只需在后台配置菜单
- ✅ 支持权限控制
- ✅ 灵活可扩展

### 工作流程

```
1. 用户登录成功
   ↓
2. 前端调用 GET /api/v1/menu/user/tree
   ↓
3. 后端根据用户角色返回菜单树
   ↓
4. 前端将菜单树转换为路由配置
   ↓
5. 动态添加路由到 Vue Router
   ↓
6. 生成侧边栏菜单
```

---

## 完整示例：添加用户管理模块

### 步骤1：后端配置菜单

在数据库 `s_menu` 表中添加菜单配置：

```sql
-- 1. 添加系统管理目录
INSERT INTO s_menu (
  menu_name, parent_id, sort, path, component, 
  menu_type, visible, status, perms, icon
) VALUES (
  '系统管理',  -- 菜单名称
  0,           -- 父菜单ID（0表示根菜单）
  1,           -- 排序
  'system',    -- 路由路径
  'LAYOUT',    -- 组件（目录固定为LAYOUT）
  0,           -- 菜单类型（0:目录 1:菜单 2:按钮）
  0,           -- 是否可见（0:显示 1:隐藏）
  0,           -- 状态（0:正常 1:停用）
  '',          -- 权限标识（目录可为空）
  'setting'    -- 图标
);

-- 2. 添加用户管理菜单
INSERT INTO s_menu (
  menu_name, parent_id, sort, path, component, 
  menu_type, visible, status, perms, icon
) VALUES (
  '用户管理',
  (SELECT id FROM s_menu WHERE menu_name = '系统管理'),  -- 父菜单ID
  1,
  'user',                    -- 路由路径
  'system/user/index',       -- 组件路径
  1,                         -- 菜单类型（1:菜单）
  0,
  0,
  'user.read',               -- 权限标识
  'user'
);

-- 3. 添加操作按钮
INSERT INTO s_menu (
  menu_name, parent_id, sort, path, component, 
  menu_type, visible, status, perms, icon
) VALUES 
  ('新增用户', (SELECT id FROM s_menu WHERE menu_name = '用户管理'), 1, '', '', 2, 0, 0, 'user.create', ''),
  ('编辑用户', (SELECT id FROM s_menu WHERE menu_name = '用户管理'), 2, '', '', 2, 0, 0, 'user.update', ''),
  ('删除用户', (SELECT id FROM s_menu WHERE menu_name = '用户管理'), 3, '', '', 2, 0, 0, 'user.delete', '');
```

### 步骤2：为角色分配菜单权限

```sql
-- 为角色分配菜单权限（假设角色ID为1）
INSERT INTO s_role_menu (role_id, menu_id)
SELECT 1, id FROM s_menu WHERE menu_name IN ('系统管理', '用户管理', '新增用户', '编辑用户', '删除用户');
```

### 步骤3：创建前端页面组件

创建文件：`src/views/system/user/index.vue`

```vue
<template>
  <div>
    <BasicTable @register="registerTable">
      <template #toolbar>
        <a-button 
          v-if="hasPermission('user.create')" 
          type="primary" 
          @click="handleCreate"
        >
          新增
        </a-button>
      </template>
      <template #bodyCell="{ column, record }">
        <template v-if="column.key === 'action'">
          <TableAction
            :actions="[
              {
                label: '编辑',
                ifShow: hasPermission('user.update'),
                onClick: handleEdit.bind(null, record),
              },
              {
                label: '删除',
                color: 'error',
                ifShow: hasPermission('user.delete'),
                popConfirm: {
                  title: '确定删除吗？',
                  confirm: handleDelete.bind(null, record),
                },
              },
            ]"
          />
        </template>
      </template>
    </BasicTable>
  </div>
</template>

<script setup lang="ts">
import { BasicTable, useTable, TableAction } from '@/components/Table';
import { usePermission } from '@/hooks/web/usePermission';
import { userApi } from '@/api/system/user';

const { hasPermission } = usePermission();

const [registerTable, { reload }] = useTable({
  title: '用户列表',
  api: userApi.page,
  columns: [
    { title: '用户ID', dataIndex: 'userId', width: 80 },
    { title: '用户名', dataIndex: 'userName' },
    { title: '昵称', dataIndex: 'nickName' },
    { title: '邮箱', dataIndex: 'email' },
    { title: '状态', dataIndex: 'status', width: 80 },
  ],
  actionColumn: {
    width: 150,
    title: '操作',
    dataIndex: 'action',
  },
});

function handleCreate() {
  // 新增逻辑
}

function handleEdit(record: any) {
  // 编辑逻辑
}

async function handleDelete(record: any) {
  await userApi.delete(record.userId);
  reload();
}
</script>
```

### 步骤4：重新登录测试

1. 退出当前登录
2. 重新登录
3. 系统自动加载菜单
4. 侧边栏显示"系统管理 > 用户管理"
5. 点击进入用户管理页面

**完成！无需修改任何路由配置代码！**

---

## 菜单类型说明

### 目录 (menu_type = 0)

**特点：**
- 不对应具体页面
- 用于组织菜单结构
- component 固定为 'LAYOUT'
- 可以有子菜单

**示例：**
```sql
INSERT INTO s_menu (
  menu_name, parent_id, path, component, menu_type, icon
) VALUES (
  '系统管理', 0, 'system', 'LAYOUT', 0, 'setting'
);
```

### 菜单 (menu_type = 1)

**特点：**
- 对应具体页面
- component 指向 Vue 组件路径
- 需要配置权限标识
- 显示在侧边栏

**示例：**
```sql
INSERT INTO s_menu (
  menu_name, parent_id, path, component, menu_type, perms, icon
) VALUES (
  '用户管理', 1, 'user', 'system/user/index', 1, 'user.read', 'user'
);
```

### 按钮 (menu_type = 2)

**特点：**
- 不生成路由
- 仅用于权限控制
- path 和 component 为空
- 不显示在侧边栏

**示例：**
```sql
INSERT INTO s_menu (
  menu_name, parent_id, menu_type, perms
) VALUES (
  '新增用户', 2, 2, 'user.create'
);
```

---

## 权限控制

### 路由级权限

路由级权限由后端菜单配置的 `perms` 字段控制，前端自动处理。

**后端配置：**
```sql
-- 菜单的 perms 字段
perms = 'user.read'
```

**前端效果：**
- 没有 `user.read` 权限的用户看不到该菜单
- 即使手动输入URL也会被路由守卫拦截

### 按钮级权限

按钮级权限需要在前端代码中使用 `hasPermission` 函数判断。

**示例：**
```vue
<template>
  <!-- 使用 v-if -->
  <a-button v-if="hasPermission('user.create')">
    新增
  </a-button>

  <!-- 使用 ifShow -->
  <TableAction
    :actions="[
      {
        label: '编辑',
        ifShow: hasPermission('user.update'),
        onClick: handleEdit,
      },
    ]"
  />
</template>

<script setup lang="ts">
import { usePermission } from '@/hooks/web/usePermission';

const { hasPermission } = usePermission();
</script>
```

---

## 组件路径映射

### 后端配置

```sql
component = 'system/user/index'
```

### 前端文件路径

```
src/views/system/user/index.vue
```

### 转换规则

后端的 `component` 字段会被转换为：

```typescript
() => import(`@/views/${component}.vue`)
```

---

## 常见问题

### Q1: 菜单配置后不显示？

**检查清单：**
1. ✅ 菜单的 `status` 是否为 0（正常）
2. ✅ 菜单的 `visible` 是否为 0（显示）
3. ✅ 角色是否已分配该菜单权限
4. ✅ 用户是否拥有该角色
5. ✅ 是否重新登录

### Q2: 点击菜单报404？

**检查清单：**
1. ✅ `component` 路径是否正确
2. ✅ Vue 组件文件是否存在
3. ✅ 文件路径是否匹配（区分大小写）

### Q3: 按钮权限不生效？

**检查清单：**
1. ✅ 按钮菜单的 `menu_type` 是否为 2
2. ✅ 按钮菜单的 `perms` 是否配置
3. ✅ 前端代码是否使用 `hasPermission` 判断
4. ✅ 角色是否已分配按钮权限

### Q4: 如何支持通配符权限？

后端 Casbin 已支持通配符，前端无需特殊处理。

**示例：**
- `user.*` - 匹配所有 user 开头的权限
- `*.read` - 匹配所有 read 结尾的权限
- `*` - 匹配所有权限（超级管理员）

---

## 最佳实践

### 1. 菜单命名规范

```
目录：系统管理、业务管理
菜单：用户管理、角色管理
按钮：新增用户、编辑用户、删除用户
```

### 2. 路径命名规范

```
目录：system、business
菜单：user、role、menu
```

### 3. 权限标识规范

```
模块.操作
user.read    - 查看用户
user.create  - 创建用户
user.update  - 更新用户
user.delete  - 删除用户
user.*       - 用户模块所有权限
```

### 4. 组件路径规范

```
system/user/index       - 用户列表
system/role/index       - 角色列表
system/menu/index       - 菜单列表
```

### 5. 图标选择

使用 Ant Design Icons：
- `user` - 用户
- `team` - 团队/角色
- `menu` - 菜单
- `setting` - 设置
- `dashboard` - 仪表盘

---

## 总结

通过动态路由系统，添加新功能模块只需：

1. ✅ 在数据库配置菜单（SQL）
2. ✅ 创建 Vue 组件文件
3. ✅ 重新登录测试

**无需修改路由配置，开发效率极高！**

---

**创建时间：** 2024-12-29  
**维护人员：** Kiro AI Assistant
