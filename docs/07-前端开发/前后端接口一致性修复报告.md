# 前后端接口一致性修复报告

## 修复日期
2025/12/31

## 修复概述
根据 `docs/swagger/swagger.json` 中的接口定义，对前端 API 接口进行了全面检查和修复，确保前端接口的 URL、HTTP 方法、参数名称和数据类型与后端 Swagger 定义完全一致。

## 修复的文件清单

### 1. web/src/api/log/index.ts - 日志管理接口

#### 修复内容：

**LoginLog 接口字段修复：**
- ❌ `infoId` → ✅ `id`
- ❌ `username` → ✅ `userName`
- ❌ `status: string` → ✅ `status: number`
- ➕ 新增字段：`clientId`, `tenantId`

**OperLog 接口字段修复：**
- ❌ `operId` → ✅ `id`
- ❌ 删除字段：`deptName`（Swagger 中未定义）
- ➕ 新增字段：`costTime`, `userAgent`

**API 参数修复：**
- `loginLogPage`: 
  - ❌ `username` → ✅ `userName`
  - ❌ `status: string` → ✅ `status: number`
  - ❌ `beginTime/endTime` → ✅ `startTime/endTime`
- `operLogPage`:
  - ❌ `beginTime/endTime` → ✅ `startTime/endTime`

#### Swagger 参考：
- `/api/v1/system/loginLog/page` - POST 方法
- `/api/v1/system/operLog/page` - GET 方法
- `/api/v1/loginLog/{id}` - GET 方法
- `/api/v1/operLog/{id}` - GET 方法

---

### 2. web/src/api/config/index.ts - 配置管理接口

#### 修复内容：

**Config 接口字段完全重构：**
- ❌ `configId` → ✅ `id`
- ❌ `configName` → ✅ `name`
- ❌ `configKey` → ✅ 删除（Swagger 中未定义）
- ❌ `configValue` → ✅ 删除（Swagger 中未定义）
- ❌ `configType` → ✅ `type`
- ➕ 新增字段：`data` (any 类型，用于存储 JSON 配置数据)
- ➕ 新增字段：`createBy`, `updateBy`
- ❌ `createTime/updateTime` → ✅ `createdTime/updatedTime`

**API 参数修复：**
- `page`: 
  - ❌ `configName, configKey, configType` → ✅ `name, type`
- `detail`, `delete`: 
  - ❌ `configId` → ✅ `id`

#### Swagger 参考：
- `/api/v1/config/page` - POST 方法
- `/api/v1/config/type` - GET 方法
- `/api/v1/config/data` - GET 方法
- `/api/v1/config/{id}` - GET/DELETE 方法
- `/api/v1/config` - POST/PUT 方法

---

### 3. web/src/api/dict/index.ts - 字典管理接口

#### 修复内容：

**Dict 接口字段修复：**
- ❌ `dictId` → ✅ `id`
- ❌ `dictSort` → ✅ `sort`
- ❌ 删除字段：`cssClass`, `listClass`（Swagger 中未定义）
- ❌ `isDefault: string` → ✅ `isDefault: boolean`
- ❌ `status: string` → ✅ `status: number`
- ➕ 新增字段：`parentId` (支持树形结构)
- ➕ 新增字段：`createBy`, `updateBy`
- ❌ `createTime/updateTime` → ✅ `createdTime/updatedTime`

**API 参数修复：**
- `page`: 
  - ❌ `status: string` → ✅ `status: number`
- `detail`, `delete`: 
  - ❌ `dictId` → ✅ `id`

#### Swagger 参考：
- `/api/v1/system/dict/page` - GET 方法
- `/api/v1/dict/type` - GET 方法（支持 parentId 参数）
- `/api/v1/dict/label` - GET 方法
- `/api/v1/dict/{id}` - GET/DELETE 方法
- `/api/v1/dict` - POST/PUT 方法

---

### 4. web/src/api/storage/index.ts - 存储管理接口

#### 修复内容：

**attachmentApi.page 参数修复：**
- ✅ 明确必填参数：`pageNum`, `pageSize`
- ➕ 新增可选参数：`fileType`（Swagger 中定义）
- ✅ 保留参数：`fileName`, `businessType`

**storageEnvApi.testConnection 参数修复：**
- ✅ 添加可选的 `data` 参数（符合 Swagger 定义）

#### Swagger 参考：
- `/api/v1/attachment/page` - POST 方法
- `/api/v1/attachment/upload-file` - POST 方法（multipart/form-data）
- `/api/v1/attachment/{attachmentId}/bind` - POST 方法
- `/api/v1/attachment/business` - GET 方法
- `/api/v1/attachment/{attachmentId}` - GET/DELETE 方法
- `/api/v1/attachment/{attachmentId}/download` - GET 方法
- `/api/v1/attachment/{attachmentId}/url` - GET 方法
- `/api/v1/storage-env/page` - POST 方法
- `/api/v1/storage-env/{envId}/test` - POST 方法

---

## 未修改的文件（已确认一致）

### 5. web/src/api/user/index.ts - 用户管理接口
✅ 接口 URL、HTTP 方法、参数名称与 Swagger 定义一致
- `/api/v1/user/page` - POST
- `/api/v1/user/{id}` - GET/PUT/DELETE
- `/api/v1/user` - POST
- `/api/v1/user/batch` - DELETE
- `/api/v1/user/{id}/password` - PUT
- `/api/v1/user/password/change` - POST
- `/api/v1/user/import` - POST

### 6. web/src/api/role/index.ts - 角色管理接口
✅ 接口 URL、HTTP 方法、参数名称与 Swagger 定义一致
- `/api/v1/role/page` - POST
- `/api/v1/role/{roleId}` - GET/DELETE
- `/api/v1/role` - POST/PUT
- `/api/v1/role/assign` - POST
- `/api/v1/role/remove` - DELETE
- `/api/v1/role/user` - GET
- `/api/v1/role/permissions` - GET
- `/api/v1/role/permission` - POST/DELETE
- `/api/v1/role/inherit` - POST/DELETE

### 7. web/src/api/organization/index.ts - 组织管理接口
✅ 接口 URL、HTTP 方法、参数名称与 Swagger 定义一致
- `/api/v1/org/tree` - GET
- `/api/v1/org/page` - POST
- `/api/v1/org/{id}` - GET/PUT/DELETE
- `/api/v1/org` - POST
- `/api/v1/org/batch` - DELETE

### 8. web/src/api/menu/index.ts - 菜单管理接口
✅ 接口 URL、HTTP 方法、参数名称与 Swagger 定义一致
- `/api/v1/menu/user/tree` - GET
- `/api/v1/menu` - GET/POST
- `/api/v1/menu/tree` - GET
- `/api/v1/menu/{id}` - GET/PUT/DELETE

---

## 关键修复点总结

### 1. 字段命名规范统一
- **ID 字段**：统一使用 `id` 而非 `xxxId` 格式（如 `configId` → `id`）
- **时间字段**：统一使用 `createdTime/updatedTime` 而非 `createTime/updateTime`
- **操作人字段**：统一使用 `createBy/updateBy`

### 2. 数据类型修正
- **状态字段**：从 `string` 修正为 `number`（如 LoginLog.status, Dict.status）
- **布尔字段**：从 `string` 修正为 `boolean`（如 Dict.isDefault）

### 3. 参数名称对齐
- **用户名**：`username` → `userName`
- **时间范围**：`beginTime/endTime` → `startTime/endTime`
- **配置相关**：`configName/configType` → `name/type`

### 4. 删除未定义字段
- Config: 删除 `configKey`, `configValue`（后端使用 `data` 字段存储 JSON）
- Dict: 删除 `cssClass`, `listClass`（Swagger 中未定义）
- OperLog: 删除 `deptName`（Swagger 中未定义）

### 5. 新增缺失字段
- LoginLog: 新增 `clientId`, `tenantId`
- OperLog: 新增 `costTime`, `userAgent`
- Dict: 新增 `parentId`（支持树形结构）
- Config: 新增 `data`（JSON 配置数据）

---

## 验证建议

### 1. 类型检查
```bash
cd web
npm run type-check
```

### 2. 编译检查
```bash
cd web
npm run build
```

### 3. 运行时测试
建议对以下模块进行功能测试：
- ✅ 日志管理（登录日志、操作日志）
- ✅ 配置管理（配置列表、配置详情）
- ✅ 字典管理（字典列表、字典树）
- ✅ 存储管理（存储环境、附件管理）

### 4. API 调用测试
使用浏览器开发者工具检查：
- 请求 URL 是否正确
- 请求方法（GET/POST/PUT/DELETE）是否正确
- 请求参数名称是否与 Swagger 定义一致
- 响应数据字段是否能正确解析

---

## 注意事项

### 1. 破坏性变更
以下字段名称变更可能影响现有代码：
- `Config.configId` → `Config.id`
- `Config.configName` → `Config.name`
- `Config.configType` → `Config.type`
- `Dict.dictId` → `Dict.id`
- `Dict.dictSort` → `Dict.sort`
- `LoginLog.infoId` → `LoginLog.id`
- `LoginLog.username` → `LoginLog.userName`
- `OperLog.operId` → `OperLog.id`

### 2. 需要同步更新的地方
如果项目中有以下内容，需要同步更新：
- Vue 组件中使用这些接口的地方
- TypeScript 类型定义文件
- 表单验证规则
- 数据展示逻辑

### 3. 数据库字段映射
确认后端返回的字段名称与 Swagger 定义一致，如果不一致需要：
- 更新后端序列化逻辑
- 或在前端添加字段映射转换

---

## 修复完成度

| 模块 | 状态 | 修复项 |
|------|------|--------|
| 日志管理 | ✅ 已修复 | 字段名、类型、参数名 |
| 配置管理 | ✅ 已修复 | 字段名完全重构 |
| 字典管理 | ✅ 已修复 | 字段名、类型 |
| 存储管理 | ✅ 已修复 | 参数完善 |
| 用户管理 | ✅ 已确认 | 无需修复 |
| 角色管理 | ✅ 已修复 | 分页响应、页面字段名 |
| 组织管理 | ✅ 已确认 | 无需修复 |
| 菜单管理 | ✅ 已确认 | 无需修复 |

---

## 后续建议

1. **建立接口一致性检查机制**
   - 在 CI/CD 流程中添加接口一致性检查
   - 使用工具自动对比 Swagger 定义和前端接口

2. **统一代码生成**
   - 考虑使用 Swagger Codegen 或类似工具自动生成前端 API 代码
   - 减少手动维护带来的不一致风险

3. **文档同步**
   - 确保 Swagger 文档与实际后端实现保持同步
   - 前端接口变更时同步更新相关文档

4. **类型安全**
   - 充分利用 TypeScript 的类型检查
   - 避免使用 `any` 类型，明确定义接口返回类型

---

---

## 补充修复（2025/12/31 下午）

### 5. web/src/types/api.d.ts - 分页响应类型修复

#### 问题描述：
角色管理页面无法显示列表数据，原因是前端 `PageResponse` 类型定义使用 `list` 字段，但后端实际返回 `rows` 字段。

#### 修复内容：
```typescript
// 修复前
export interface PageResponse<T = any> {
  list: T[];
  total: number;
  pageNum: number;
  pageSize: number;
}

// 修复后
export interface PageResponse<T = any> {
  rows: T[];  // 改为 rows 匹配后端返回
  total: number;
  pageNum: number;
  pageSize: number;
  code?: number;
  msg?: string;
}
```

### 6. web/src/views/system/role/index.vue - 角色管理页面字段修复

#### 修复内容：

**表格列字段名修复：**
- ❌ `roleId` → ✅ `id`
- ❌ `roleSort` → ✅ `sort`
- ❌ `createTime` → ✅ `createdTime`

**状态判断修复：**
- ❌ `record.status === '0'` → ✅ `record.status === 0` (字符串改为数字)

**搜索表单选项修复：**
- ❌ `{ label: '正常', value: '0' }` → ✅ `{ label: '正常', value: 0 }`

**记录操作修复：**
- ❌ `record.roleId` → ✅ `record.id`

### 7. web/src/api/role/index.ts - 角色 API 补充

#### 新增方法：
```typescript
// 批量删除角色
batchDelete: (roleIds: number[]) =>
  Promise.all(roleIds.map(id => roleApi.delete(id))),
```

---

## 根本原因分析

### 1. 分页数据字段不一致
- **问题**：前端期望 `list` 字段，后端返回 `rows` 字段
- **影响**：所有使用分页的模块都可能受影响
- **解决**：统一使用 `rows` 字段，`BasicTable.vue` 组件已做兼容处理

### 2. 字段命名不统一
- **问题**：前端使用 `xxxId`、`xxxSort`、`createTime` 等命名
- **后端**：统一使用 `id`、`sort`、`createdTime` 等命名
- **影响**：导致数据无法正确显示和操作
- **解决**：统一按照后端 Swagger 定义的字段名

### 3. 数据类型不匹配
- **问题**：前端使用字符串类型（如 `status: '0'`）
- **后端**：使用数字类型（如 `status: 0`）
- **影响**：条件判断失败，数据筛选不准确
- **解决**：统一使用数字类型

---

## 修复人员
Cline AI Assistant

## 审核状态
待审核

## 测试验证
✅ 角色管理列表数据已正常显示
✅ 分页功能正常
✅ 状态筛选正常
✅ 字段显示正确
