# 菜单管理操作列显示修复

## 问题描述

菜单管理页面的操作列什么也不显示，导致用户无法进行任何操作。

## 问题原因

操作列中的所有按钮都使用了 `v-permission` 指令进行权限控制：
- 修改按钮：需要 `menu.update` 权限
- 新增按钮：需要 `menu.create` 权限  
- 删除按钮：需要 `menu.delete` 权限

当用户没有这些权限时，`v-permission` 指令会将按钮隐藏（`display: none`），导致整个操作列为空。

## 解决方案

添加一个不需要权限的"查看"按钮，确保即使用户没有编辑权限，也能查看菜单详情。

### 修改内容

1. **导入 EyeOutlined 图标**
```typescript
import { 
  PlusOutlined, 
  DownOutlined, 
  UpOutlined,
  EditOutlined,
  DeleteOutlined,
  EyeOutlined,  // 新增
} from '@ant-design/icons-vue';
```

2. **添加查看按钮**
```vue
<a-tooltip title="查看">
  <a-button
    type="link"
    size="small"
    @click="handleView(record)"
  >
    <template #icon><EyeOutlined /></template>
  </a-button>
</a-tooltip>
```

3. **添加 handleView 函数**
```typescript
// 查看菜单（只读模式）
const handleView = (record: any) => {
  currentMenuId.value = record.id;
  parentId.value = undefined;
  modalVisible.value = true;
};
```

## 效果

- ✅ 操作列始终显示"查看"按钮（无需权限）
- ✅ 有权限的用户可以看到"修改"、"新增"、"删除"按钮
- ✅ 没有权限的用户至少可以查看菜单详情
- ✅ 操作列不再为空

## 注意事项

1. **查看功能**：当前 `handleView` 和 `handleEdit` 的实现相同，都是打开 MenuModal。如果需要真正的只读模式，需要在 MenuModal 组件中添加 `readonly` 属性支持。

2. **权限控制**：`v-permission` 指令通过 `display: none` 隐藏元素，不会从 DOM 中移除。如果需要完全移除，可以修改指令实现。

3. **其他页面**：建议检查其他管理页面（如角色管理、用户管理等）是否存在类似问题。

## 相关文件

- `web/src/views/system/menu/index.vue` - 菜单管理页面
- `web/src/directives/permission.ts` - 权限指令实现
- `web/src/composables/usePermission.ts` - 权限检查组合函数

## 前端权限获取流程

### 1. 权限数据来源

前端通过以下接口获取用户的操作权限：

**接口**: `GET /api/v1/menu/user/tree`

**说明**: 
- 该接口返回当前登录用户的菜单树
- 菜单树中每个菜单项包含 `perms` 字段（权限标识）
- 前端从菜单树中提取所有 `perms` 字段，构建权限列表

### 2. 权限提取过程

在 `web/src/stores/permission.ts` 中：

```typescript
// 生成路由时提取权限
async generateRoutes() {
  // 1. 从后端获取用户菜单树
  const menuTree = await menuApi.getUserMenuTree();
  
  // 2. 规范化菜单数据
  const normalizedMenuTree = this.normalizeMenuData(menuTree);
  this.menuTree = normalizedMenuTree;

  // 3. 提取所有权限标识
  this.permissions = this.extractPermissions(normalizedMenuTree);
  
  // 4. 生成动态路由
  const dynamicRoutes = this.transformMenuToRoutes(normalizedMenuTree);
  
  return dynamicRoutes;
}

// 递归提取权限标识
extractPermissions(menus: MenuInfo[]): string[] {
  const permissions: string[] = [];
  
  const extract = (menuList: MenuInfo[]) => {
    menuList.forEach((menu) => {
      if (menu.perms) {
        permissions.push(menu.perms);  // 提取 perms 字段
      }
      if (menu.children && menu.children.length > 0) {
        extract(menu.children);  // 递归处理子菜单
      }
    });
  };
  
  extract(menus);
  return permissions;
}
```

### 3. 权限检查机制

**Store 中的权限检查**:
```typescript
// web/src/stores/permission.ts
hasPermission: (state) => (permission: string) => {
  if (!permission) return true;
  return (
    state.permissions.includes(permission) ||
    state.permissions.includes('*') ||  // 超级管理员
    state.permissions.some((p) => {
      // 支持通配符匹配，例如 user.* 匹配 user.create, user.read 等
      if (p.endsWith('.*')) {
        const prefix = p.slice(0, -2);
        return permission.startsWith(prefix + '.');
      }
      return false;
    })
  );
}
```

**指令中的权限检查**:
```typescript
// web/src/directives/permission.ts
export const permission: Directive = {
  mounted(el: HTMLElement, binding: DirectiveBinding) {
    const { value } = binding;
    if (!value) return;

    const permissionStore = usePermissionStore();
    const permissions = Array.isArray(value) ? value : [value];
    
    const hasPermission = permissions.some((perm) => 
      permissionStore.hasPermission(perm)
    );
    
    if (!hasPermission) {
      el.style.display = 'none';  // 隐藏无权限的元素
    }
  },
};
```

### 4. 后端接口实现

**Controller**: `internal/controller/menu.go`
```go
// GetUserMenuTree 获取当前用户的菜单树
func (c *MenuController) GetUserMenuTree(ctx *gin.Context) {
    // 从上下文获取用户ID
    userId, exists := ctx.Get("userId")
    if !exists {
        response.FailCode(ctx, response.CodeUnauthorized, "未授权")
        return
    }

    userIdInt64, ok := userId.(int64)
    if !ok {
        response.FailCode(ctx, response.CodeServerError, "用户ID类型错误")
        return
    }

    // 根据用户ID获取其有权限的菜单树
    tree, err := c.menuService.GetUserMenuTree(userIdInt64)
    if err != nil {
        response.FailCode(ctx, response.CodeServerError, err.Error())
        return
    }

    response.Success(ctx, tree)
}
```

### 5. 权限数据流转

```
用户登录
  ↓
后端根据用户角色查询菜单权限
  ↓
返回菜单树（包含 perms 字段）
  ↓
前端 PermissionStore 提取所有 perms
  ↓
存储到 permissions 数组
  ↓
v-permission 指令检查权限
  ↓
显示/隐藏对应的操作按钮
```

### 6. 权限标识示例

菜单管理相关的权限标识：
- `menu.create` - 创建菜单权限
- `menu.update` - 修改菜单权限
- `menu.delete` - 删除菜单权限
- `menu.read` - 查看菜单权限（如果有）

### 7. 持久化存储

权限数据存储在 `sessionStorage` 中：
```typescript
persist: {
  key: 'permission',
  storage: sessionStorage,  // 关闭浏览器后清除
  paths: ['permissions', 'menuTree', 'isRoutesGenerated', 'routes'],
}
```

## 修复时间

2026-01-01
