# NAI-TIZI 前端项目开发指南

## 项目概述

基于 [vue-vben-admin](https://github.com/vbenjs/vue-vben-admin) 进行二次开发，构建 NAI-TIZI 后台管理系统前端。

**技术栈：**
- Vue 3.4+ (Composition API + `<script setup>`)
- TypeScript 5.0+
- Vite 5.0+
- Ant Design Vue 4.x
- Pinia (状态管理)
- Vue Router 4.x (动态路由)

---

## 快速开始

### 1. 克隆 vue-vben-admin

```bash
# 克隆项目
git clone https://github.com/vbenjs/vue-vben-admin.git nai-tizi-web

cd nai-tizi-web

# 安装依赖
pnpm install
```

### 2. 配置环境变量

创建 `.env.development` 文件：

```env
# 应用标题
VITE_APP_TITLE=NAI-TIZI 管理后台

# API 基础地址
VITE_API_BASE_URL=http://localhost:9009

# 客户端认证
VITE_CLIENT_KEY=web-admin
VITE_CLIENT_SECRET=web-secret-2024
```

### 3. 启动开发服务器

```bash
pnpm dev
```

访问：http://localhost:5173

---

## 后端 API 对接

### API 接口清单

根据 Swagger 文档，后端提供以下核心接口：

#### 认证模块
- `POST /login` - 用户登录
- `POST /logout` - 用户登出
- `POST /auth/refresh` - 刷新Token
- `GET /me` - 获取当前用户信息

#### 用户管理
- `POST /api/v1/user/page` - 分页查询用户
- `POST /api/v1/user` - 创建用户
- `GET /api/v1/user/:id` - 获取用户详情
- `PUT /api/v1/user/:id` - 更新用户
- `DELETE /api/v1/user/:id` - 删除用户
- `DELETE /api/v1/user/batch` - 批量删除用户
- `PUT /api/v1/user/:id/password` - 重置密码

#### 角色管理
- `POST /api/v1/role/page` - 分页查询角色
- `POST /api/v1/role` - 创建角色
- `PUT /api/v1/role` - 更新角色
- `GET /api/v1/role/:roleId` - 获取角色详情
- `DELETE /api/v1/role/:roleId` - 删除角色
- `POST /api/v1/role/assign` - 分配角色给用户
- `DELETE /api/v1/role/remove` - 移除用户角色
- `GET /api/v1/role/user` - 获取用户角色
- `POST /api/v1/role/permission` - 添加角色权限
- `DELETE /api/v1/role/permission` - 删除角色权限
- `GET /api/v1/role/permissions` - 获取角色权限列表
- `POST /api/v1/role/inherit` - 设置角色继承
- `DELETE /api/v1/role/inherit` - 删除角色继承

#### 组织管理
- `POST /api/v1/org/page` - 分页查询组织
- `GET /api/v1/org/tree` - 获取组织树
- `POST /api/v1/org` - 创建组织
- `GET /api/v1/org/:id` - 获取组织详情
- `PUT /api/v1/org/:id` - 更新组织
- `DELETE /api/v1/org/:id` - 删除组织
- `DELETE /api/v1/org/batch` - 批量删除组织

#### 菜单管理
- `GET /api/v1/menu` - 获取菜单列表
- `GET /api/v1/menu/tree` - 获取菜单树
- `GET /api/v1/menu/user/tree` - 获取用户菜单树（动态路由核心）⭐
- `GET /api/v1/menu/:id` - 获取菜单详情
- `POST /api/v1/menu` - 创建菜单
- `PUT /api/v1/menu/:id` - 更新菜单
- `DELETE /api/v1/menu/:id` - 删除菜单

#### 字典管理
- `POST /api/v1/dict/page` - 分页查询字典
- `GET /api/v1/dict/type` - 根据类型获取字典
- `GET /api/v1/dict/label` - 根据标签获取字典
- `POST /api/v1/dict` - 创建字典
- `PUT /api/v1/dict` - 更新字典
- `DELETE /api/v1/dict/:id` - 删除字典
- `DELETE /api/v1/dict/batch` - 批量删除字典

#### 配置管理
- `POST /api/v1/config/page` - 分页查询配置
- `GET /api/v1/config/type` - 根据类型获取配置
- `GET /api/v1/config/data` - 获取配置数据
- `POST /api/v1/config` - 创建配置
- `PUT /api/v1/config` - 更新配置
- `GET /api/v1/config/:id` - 获取配置详情
- `DELETE /api/v1/config/:id` - 删除配置
- `DELETE /api/v1/config/batch` - 批量删除配置

#### 日志管理
- `POST /api/v1/loginLog/page` - 分页查询登录日志
- `POST /api/v1/operLog/page` - 分页查询操作日志
- `POST /api/v1/loginLog/clean` - 清理登录日志
- `POST /api/v1/operLog/clean` - 清理操作日志

#### 存储管理
- `POST /api/v1/storage-env/page` - 分页查询存储环境
- `GET /api/v1/storage-env/default` - 获取默认存储环境
- `POST /api/v1/storage-env/default` - 设置默认存储环境
- `POST /api/v1/storage-env` - 创建存储环境
- `PUT /api/v1/storage-env` - 更新存储环境
- `GET /api/v1/storage-env/:envId` - 获取存储环境详情
- `DELETE /api/v1/storage-env/:envId` - 删除存储环境

#### 附件管理
- `POST /api/v1/attachment/upload-file` - 上传文件
- `POST /api/v1/attachment/:attachmentId/bind` - 绑定附件到业务
- `GET /api/v1/attachment/business` - 根据业务查询附件
- `GET /api/v1/attachment/:attachmentId` - 获取附件详情
- `GET /api/v1/attachment/:attachmentId/url` - 获取附件访问URL
- `GET /api/v1/attachment/:attachmentId/download` - 下载附件
- `DELETE /api/v1/attachment/:attachmentId` - 删除附件

---

## 核心功能实现

### 1. 认证系统

#### API 接口封装

创建 `src/api/auth/index.ts`：

```typescript
import { defHttp } from '@/utils/http/axios';

export interface LoginParams {
  grantType: 'password' | 'email' | 'xcx';
  username?: string;
  password?: string;
  email?: string;
  code?: string;
  clientKey: string;
  clientSecret: string;
  uuid?: string;
}

export interface LoginResponse {
  access_token: string;
  refresh_token: string;
  expires_in: number;
  refresh_expires_in: number;
  user_info: {
    userId: number;
    username: string;
    nickName: string;
    email: string;
    phonenumber: string;
    avatar: string;
    orgId: number;
    status: number;
  };
}

export const authApi = {
  // 登录
  login: (params: LoginParams) =>
    defHttp.post<LoginResponse>({ url: '/login', params }),

  // 登出
  logout: () =>
    defHttp.post({ url: '/logout' }),

  // 刷新Token
  refreshToken: (params: { refreshToken: string; clientKey: string; clientSecret: string }) =>
    defHttp.post<LoginResponse>({ url: '/auth/refresh', params }),

  // 获取当前用户信息
  me: () =>
    defHttp.get({ url: '/me' }),
};
```

#### 登录页面

修改 `src/views/sys/login/Login.vue`：

```vue
<template>
  <div class="login-container">
    <LoginForm @success="handleLoginSuccess" />
  </div>
</template>

<script setup lang="ts">
import { LoginForm } from './components';
import { useUserStore } from '@/store/modules/user';
import { useRouter } from 'vue-router';

const userStore = useUserStore();
const router = useRouter();

const handleLoginSuccess = async () => {
  // 登录成功后跳转
  await router.replace('/dashboard');
};
</script>
```

#### 用户Store

修改 `src/store/modules/user.ts`：

```typescript
import { defineStore } from 'pinia';
import { authApi } from '@/api/auth';
import type { LoginParams, LoginResponse } from '@/api/auth';

interface UserState {
  userInfo: LoginResponse['user_info'] | null;
  token: string;
  refreshToken: string;
}

export const useUserStore = defineStore('user', {
  state: (): UserState => ({
    userInfo: null,
    token: '',
    refreshToken: '',
  }),

  getters: {
    getUserInfo(): LoginResponse['user_info'] | null {
      return this.userInfo;
    },
    getToken(): string {
      return this.token;
    },
  },

  actions: {
    // 登录
    async login(params: LoginParams) {
      try {
        const res = await authApi.login({
          ...params,
          clientKey: import.meta.env.VITE_CLIENT_KEY,
          clientSecret: import.meta.env.VITE_CLIENT_SECRET,
        });
        
        this.token = res.access_token;
        this.refreshToken = res.refresh_token;
        this.userInfo = res.user_info;
        
        return res;
      } catch (error) {
        throw error;
      }
    },

    // 登出
    async logout() {
      try {
        await authApi.logout();
      } finally {
        this.token = '';
        this.refreshToken = '';
        this.userInfo = null;
      }
    },

    // 刷新Token
    async refreshAccessToken() {
      const res = await authApi.refreshToken({
        refreshToken: this.refreshToken,
        clientKey: import.meta.env.VITE_CLIENT_KEY,
        clientSecret: import.meta.env.VITE_CLIENT_SECRET,
      });
      
      this.token = res.access_token;
      this.refreshToken = res.refresh_token;
    },
  },

  persist: {
    key: 'user',
    storage: localStorage,
    paths: ['token', 'refreshToken', 'userInfo'],
  },
});
```

### 2. 动态路由系统 ⭐

这是本项目的核心特性！

#### 菜单API

创建 `src/api/menu/index.ts`：

```typescript
import { defHttp } from '@/utils/http/axios';

export interface Menu {
  id: number;
  menuName: string;
  parentId: number;
  sort: number;
  path: string;
  component: string;
  query: string;
  isFrame: number;
  isCache: number;
  menuType: number; // 0:目录 1:菜单 2:按钮
  visible: number;
  status: number;
  perms: string;
  icon: string;
  remark: string;
  children?: Menu[];
}

export const menuApi = {
  // 获取用户菜单树（用于动态路由）
  getUserMenuTree: () =>
    defHttp.get<Menu[]>({ url: '/api/v1/menu/user/tree' }),

  // 获取所有菜单树（用于菜单管理）
  getMenuTree: () =>
    defHttp.get<Menu[]>({ url: '/api/v1/menu/tree' }),

  // 获取菜单列表
  getMenuList: () =>
    defHttp.get<Menu[]>({ url: '/api/v1/menu' }),

  // 获取菜单详情
  getMenuDetail: (id: number) =>
    defHttp.get<Menu>({ url: `/api/v1/menu/${id}` }),

  // 创建菜单
  createMenu: (data: Partial<Menu>) =>
    defHttp.post({ url: '/api/v1/menu', data }),

  // 更新菜单
  updateMenu: (id: number, data: Partial<Menu>) =>
    defHttp.put({ url: `/api/v1/menu/${id}`, data }),

  // 删除菜单
  deleteMenu: (id: number) =>
    defHttp.delete({ url: `/api/v1/menu/${id}` }),
};
```

#### 权限Store

创建 `src/store/modules/permission.ts`：

```typescript
import { defineStore } from 'pinia';
import { menuApi, type Menu } from '@/api/menu';
import type { RouteRecordRaw } from 'vue-router';

interface PermissionState {
  routes: RouteRecordRaw[];
  dynamicRoutes: RouteRecordRaw[];
  menuList: Menu[];
}

export const usePermissionStore = defineStore('permission', {
  state: (): PermissionState => ({
    routes: [],
    dynamicRoutes: [],
    menuList: [],
  }),

  actions: {
    // 生成路由
    async generateRoutes() {
      try {
        // 从后端获取用户菜单树
        const menuTree = await menuApi.getUserMenuTree();
        this.menuList = menuTree;

        // 转换为路由配置
        const routes = this.transformMenuToRoutes(menuTree);
        this.dynamicRoutes = routes;

        return routes;
      } catch (error) {
        throw error;
      }
    },

    // 转换菜单为路由
    transformMenuToRoutes(menus: Menu[], parentPath = ''): RouteRecordRaw[] {
      const routes: RouteRecordRaw[] = [];

      menus.forEach((menu) => {
        // 只处理目录(0)和菜单(1)，按钮(2)不生成路由
        if (menu.menuType === 2) return;

        const route: RouteRecordRaw = {
          path: menu.path,
          name: menu.path.replace(/\//g, '-'),
          meta: {
            title: menu.menuName,
            icon: menu.icon,
            hideMenu: menu.visible === 1,
            orderNo: menu.sort,
            ignoreKeepAlive: menu.isCache === 0,
            permission: menu.perms,
          },
        };

        // 目录类型
        if (menu.menuType === 0) {
          route.component = 'LAYOUT'; // vben的布局组件标识
          if (menu.children && menu.children.length > 0) {
            route.children = this.transformMenuToRoutes(menu.children, menu.path);
          }
        }
        // 菜单类型
        else if (menu.menuType === 1) {
          // 组件路径转换
          // 后端: system/user/index
          // 前端: () => import('@/views/system/user/index.vue')
          route.component = menu.component;
        }

        routes.push(route);
      });

      return routes;
    },
  },
});
```

#### 路由守卫

修改 `src/router/guard/permissionGuard.ts`：

```typescript
import type { Router } from 'vue-router';
import { usePermissionStore } from '@/store/modules/permission';
import { useUserStore } from '@/store/modules/user';

export function createPermissionGuard(router: Router) {
  router.beforeEach(async (to, from, next) => {
    const userStore = useUserStore();
    const permissionStore = usePermissionStore();

    // 白名单路由
    const whiteList = ['/login'];
    if (whiteList.includes(to.path)) {
      next();
      return;
    }

    // 检查登录状态
    if (!userStore.getToken) {
      next({ path: '/login', query: { redirect: to.fullPath } });
      return;
    }

    // 如果已经生成过路由，直接放行
    if (permissionStore.dynamicRoutes.length > 0) {
      next();
      return;
    }

    // 生成动态路由
    try {
      const routes = await permissionStore.generateRoutes();
      
      // 添加路由到router
      routes.forEach((route) => {
        router.addRoute(route);
      });

      // 重新导航到目标路由
      next({ ...to, replace: true });
    } catch (error) {
      console.error('生成路由失败:', error);
      next({ path: '/login' });
    }
  });
}
```

### 3. 用户管理模块

#### API接口

创建 `src/api/system/user.ts`：

```typescript
import { defHttp } from '@/utils/http/axios';

export interface User {
  userId: number;
  orgId: number;
  userName: string;
  nickName: string;
  email: string;
  phonenumber: string;
  sex: number;
  avatar: string;
  password: string;
  status: number;
  userType: number;
  remark: string;
  createBy: number;
  updateBy: number;
  createdTime: string;
  updatedTime: string;
}

export interface PageParams {
  pageNum: number;
  pageSize: number;
  orderByColumn?: string;
  isAsc?: string;
}

export interface PageResponse<T> {
  list: T[];
  total: number;
}

export const userApi = {
  // 分页查询
  page: (params: PageParams & { username?: string; status?: number }) =>
    defHttp.post<PageResponse<User>>({ url: '/api/v1/user/page', params }),

  // 获取详情
  detail: (id: number) =>
    defHttp.get<User>({ url: `/api/v1/user/${id}` }),

  // 创建
  create: (data: Partial<User>) =>
    defHttp.post({ url: '/api/v1/user', data }),

  // 更新
  update: (id: number, data: Partial<User>) =>
    defHttp.put({ url: `/api/v1/user/${id}`, data }),

  // 删除
  delete: (id: number) =>
    defHttp.delete({ url: `/api/v1/user/${id}` }),

  // 批量删除
  batchDelete: (userIds: number[]) =>
    defHttp.delete({ url: '/api/v1/user/batch', data: { userIds } }),

  // 重置密码
  resetPassword: (id: number, data: { newPassword: string }) =>
    defHttp.put({ url: `/api/v1/user/${id}/password`, data }),
};
```

#### 页面组件

创建 `src/views/system/user/index.vue`：

```vue
<template>
  <div>
    <BasicTable @register="registerTable">
      <template #toolbar>
        <a-button type="primary" @click="handleCreate">
          <PlusOutlined />
          新增
        </a-button>
      </template>
      <template #bodyCell="{ column, record }">
        <template v-if="column.key === 'action'">
          <TableAction
            :actions="[
              {
                label: '编辑',
                onClick: handleEdit.bind(null, record),
              },
              {
                label: '删除',
                color: 'error',
                popConfirm: {
                  title: '确定删除吗？',
                  confirm: handleDelete.bind(null, record),
                },
              },
            ]"
          />
        </template>
      </template>
    </BasicTable>
    <UserModal @register="registerModal" @success="handleSuccess" />
  </div>
</template>

<script setup lang="ts">
import { BasicTable, useTable, TableAction } from '@/components/Table';
import { useModal } from '@/components/Modal';
import { userApi } from '@/api/system/user';
import UserModal from './UserModal.vue';
import { PlusOutlined } from '@ant-design/icons-vue';

const [registerModal, { openModal }] = useModal();

const [registerTable, { reload }] = useTable({
  title: '用户列表',
  api: userApi.page,
  columns: [
    { title: '用户ID', dataIndex: 'userId', width: 80 },
    { title: '用户名', dataIndex: 'userName' },
    { title: '昵称', dataIndex: 'nickName' },
    { title: '邮箱', dataIndex: 'email' },
    { title: '手机号', dataIndex: 'phonenumber' },
    { title: '状态', dataIndex: 'status', width: 80 },
    { title: '创建时间', dataIndex: 'createdTime', width: 180 },
  ],
  actionColumn: {
    width: 150,
    title: '操作',
    dataIndex: 'action',
  },
  useSearchForm: true,
  formConfig: {
    labelWidth: 80,
    schemas: [
      {
        field: 'username',
        label: '用户名',
        component: 'Input',
      },
      {
        field: 'status',
        label: '状态',
        component: 'Select',
        componentProps: {
          options: [
            { label: '正常', value: 0 },
            { label: '停用', value: 1 },
          ],
        },
      },
    ],
  },
});

function handleCreate() {
  openModal(true, { isUpdate: false });
}

function handleEdit(record: any) {
  openModal(true, { record, isUpdate: true });
}

async function handleDelete(record: any) {
  await userApi.delete(record.userId);
  reload();
}

function handleSuccess() {
  reload();
}
</script>
```

---

## 功能模块开发清单

### 系统管理
- [ ] 用户管理
- [ ] 角色管理
- [ ] 组织管理
- [ ] 菜单管理

### 系统配置
- [ ] 字典管理
- [ ] 配置管理

### 系统监控
- [ ] 登录日志
- [ ] 操作日志

### 存储管理
- [ ] 存储环境管理
- [ ] 文件管理

---

## 开发规范

### 文件命名
- 组件文件：PascalCase (UserList.vue)
- 工具文件：camelCase (formatDate.ts)
- 样式文件：kebab-case (user-list.less)

### 代码规范
- 使用 Composition API
- 使用 `<script setup>` 语法
- 使用 TypeScript 类型注解
- 遵循 ESLint 规则

### Git 提交规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式
refactor: 重构
perf: 性能优化
test: 测试
chore: 构建/工具
```

---

## 相关文档

- [vue-vben-admin 文档](https://doc.vben.pro/)
- [Ant Design Vue 文档](https://antdv.com/)
- [后端API文档](../04-API文档/)
- [动态路由设计方案](../02-架构设计/前端动态路由设计方案.md)

---

**创建时间：** 2024-12-29  
**维护人员：** Kiro AI Assistant
