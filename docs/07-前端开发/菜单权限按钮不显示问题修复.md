# 菜单权限按钮不显示问题修复

## 问题描述

菜单管理页面的操作列什么也不显示，即使是 `super_admin` 角色的用户也看不到任何操作按钮（修改、新增、删除）。

## 根本原因

后端 `GetUserMenuTree` 接口在返回菜单树时，**过滤掉了所有按钮类型（`menuType == 2`）的菜单**。

### 问题代码

在 `internal/service/menu.go` 的 `GetUserMenuTree` 方法中：

```go
// 4. 过滤掉按钮类型的菜单和停用/隐藏的菜单
var filteredMenus []model.Menu
for _, menu := range menus {
    // 只保留目录(0)和菜单(1)，且状态正常、可见
    if (menu.MenuType == 0 || menu.MenuType == 1) &&
        menu.Status == 0 && menu.Visible == 0 {
        filteredMenus = append(filteredMenus, menu)
    }
}
```

### 问题分析

1. **按钮类型菜单被过滤**：代码只保留了目录（0）和菜单（1），过滤掉了按钮（2）
2. **权限标识丢失**：按钮类型的菜单包含权限标识（`perms` 字段），如 `menu.create`、`menu.update`、`menu.delete`
3. **前端无法获取权限**：前端从菜单树中提取权限标识，但按钮被过滤后，这些权限标识无法传递到前端
4. **权限检查失败**：前端 `v-permission` 指令检查权限时，发现没有对应的权限标识，将按钮隐藏

### 数据流转

```
后端查询菜单（包含按钮类型）
  ↓
❌ 过滤掉按钮类型（menuType == 2）
  ↓
返回菜单树（缺少按钮的 perms）
  ↓
前端提取权限标识（缺少 menu.create 等）
  ↓
v-permission 检查失败
  ↓
操作按钮被隐藏
```

## 解决方案

修改 `GetUserMenuTree` 方法的过滤逻辑，**保留按钮类型的菜单**，因为前端需要这些按钮的权限标识来控制操作按钮的显示。

### 修复代码

```go
// 4. 过滤停用/隐藏的菜单，但保留按钮类型（前端需要按钮的权限标识）
var filteredMenus []model.Menu
for _, menu := range menus {
    // 保留所有状态正常的菜单（包括按钮类型）
    // 按钮类型的菜单虽然不生成路由，但其 perms 字段用于权限控制
    if menu.Status == 0 {
        filteredMenus = append(filteredMenus, menu)
    }
}
```

### 修改说明

1. **移除菜单类型过滤**：不再过滤按钮类型（`menuType == 2`）
2. **保留状态过滤**：只过滤掉停用的菜单（`status != 0`）
3. **移除可见性过滤**：按钮类型的菜单可能设置为隐藏（`visible == 1`），但仍需要其权限标识
4. **添加注释说明**：明确说明按钮类型菜单的作用

## 设计理念

### 菜单类型的不同用途

| 菜单类型 | 值 | 用途 | 是否生成路由 | 是否需要权限标识 |
|---------|---|------|------------|---------------|
| 目录 | 0 | 组织菜单结构 | ✅ 是 | ❌ 否 |
| 菜单 | 1 | 页面入口 | ✅ 是 | ✅ 是（页面访问权限） |
| 按钮 | 2 | 操作权限 | ❌ 否 | ✅ 是（操作权限） |

### 按钮类型菜单的作用

按钮类型的菜单虽然不生成前端路由，但其 `perms` 字段用于：
- 控制页面内操作按钮的显示/隐藏
- 控制 API 接口的访问权限
- 实现细粒度的权限控制

### 示例

菜单管理模块的权限结构：

```
系统管理（目录，menuType=0）
  └─ 菜单管理（菜单，menuType=1，perms="menu.list"）
      ├─ 新增菜单（按钮，menuType=2，perms="menu.create"）
      ├─ 修改菜单（按钮，menuType=2，perms="menu.update"）
      └─ 删除菜单（按钮，menuType=2，perms="menu.delete"）
```

前端需要获取所有权限标识：
- `menu.list` - 访问菜单管理页面
- `menu.create` - 显示"新增"按钮
- `menu.update` - 显示"修改"按钮
- `menu.delete` - 显示"删除"按钮

## 前端权限控制

### 权限提取

前端从菜单树中递归提取所有 `perms` 字段：

```typescript
// web/src/stores/permission.ts
extractPermissions(menus: MenuInfo[]): string[] {
  const permissions: string[] = [];
  
  const extract = (menuList: MenuInfo[]) => {
    menuList.forEach((menu) => {
      if (menu.perms) {
        permissions.push(menu.perms);  // 提取所有 perms，包括按钮的
      }
      if (menu.children && menu.children.length > 0) {
        extract(menu.children);
      }
    });
  };
  
  extract(menus);
  return permissions;
}
```

### 权限检查

使用 `v-permission` 指令控制按钮显示：

```vue
<a-button v-permission="'menu.create'" type="primary">
  新增菜单
</a-button>

<a-button v-permission="'menu.update'" type="link">
  修改
</a-button>

<a-button v-permission="'menu.delete'" type="link" danger>
  删除
</a-button>
```

## 修改文件

- `internal/service/menu.go` - 修改 `GetUserMenuTree` 方法的过滤逻辑

## 测试验证

### 验证步骤

1. **重启后端服务**
   ```bash
   make run
   ```

2. **清除前端缓存**
   - 清除浏览器的 sessionStorage
   - 或者退出登录后重新登录

3. **检查权限数据**
   - 打开浏览器开发者工具
   - 查看 sessionStorage 中的 `permission` 数据
   - 确认 `permissions` 数组包含 `menu.create`、`menu.update`、`menu.delete`

4. **验证按钮显示**
   - 访问菜单管理页面
   - 确认操作列显示"查看"、"修改"、"新增"、"删除"按钮

### 预期结果

- ✅ `super_admin` 角色可以看到所有操作按钮
- ✅ 普通用户根据角色权限显示对应的按钮
- ✅ 没有任何权限的用户至少可以看到"查看"按钮

## 相关问题

如果仍然看不到按钮，请检查：

1. **数据库中是否有按钮类型的菜单**
   ```sql
   SELECT * FROM s_menu WHERE menu_type = 2 AND status = 0;
   ```

2. **角色是否关联了这些菜单**
   ```sql
   SELECT * FROM s_role_menu WHERE menu_id IN (
     SELECT id FROM s_menu WHERE menu_type = 2
   );
   ```

3. **前端是否正确提取了权限**
   - 检查浏览器 sessionStorage
   - 查看 `permission.permissions` 数组

## 修复时间

2026-01-01
