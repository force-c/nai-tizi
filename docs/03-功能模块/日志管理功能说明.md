# 日志管理功能说明

## 功能概述

日志管理模块包含两个子模块：
1. **登录日志（LoginLog）** - 记录用户登录行为
2. **操作日志（OperLog）** - 记录用户操作行为

两个模块都提供完整的CRUD功能，支持分页查询、条件筛选和日志清理。

## 一、登录日志（LoginLog）

### 数据库表：s_login_log

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键（分布式ID） |
| user_name | VARCHAR(100) | 用户名 |
| ipaddr | VARCHAR(50) | 登录IP |
| login_location | VARCHAR(255) | 登录地点 |
| browser | VARCHAR(100) | 浏览器类型 |
| os | VARCHAR(100) | 操作系统 |
| status | INTEGER | 登录状态：0成功 1失败 |
| msg | VARCHAR(500) | 提示消息 |
| login_time | TIMESTAMP | 登录时间 |
| tenant_id | VARCHAR(64) | 租户ID |
| client_id | VARCHAR(64) | 客户端ID |

### API接口

#### 1. 创建登录日志
```
POST /api/v1/loginLog
```

#### 2. 更新登录日志
```
PUT /api/v1/loginLog
```

#### 3. 删除登录日志
```
DELETE /api/v1/loginLog/{id}
```

#### 4. 批量删除登录日志
```
DELETE /api/v1/loginLog/batch
```

#### 5. 查询登录日志详情
```
GET /api/v1/loginLog/{id}
```

#### 6. 分页查询登录日志列表
```
GET /api/v1/loginLog/list?pageNum=1&pageSize=10&userName=admin&status=0
```

**查询参数**：
- pageNum: 页码（必填）
- pageSize: 每页数量（必填）
- userName: 用户名（可选，模糊查询）
- ipaddr: 登录IP（可选，模糊查询）
- status: 登录状态（可选，0成功 1失败 -1全部）
- startTime: 开始时间（可选）
- endTime: 结束时间（可选）

#### 7. 清理登录日志
```
POST /api/v1/loginLog/clean
{
  "days": 30
}
```

清理指定天数之前的登录日志。

## 二、操作日志（OperLog）

### 数据库表：s_oper_log

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键（分布式ID） |
| title | VARCHAR(100) | 模块标题 |
| business_type | VARCHAR(50) | 业务类型 |
| method | VARCHAR(200) | 调用方法 |
| request_method | VARCHAR(10) | 请求方式：GET/POST |
| operator_type | VARCHAR(20) | 操作类别：web/app |
| oper_name | VARCHAR(100) | 操作者 |
| oper_url | VARCHAR(500) | 请求URL |
| oper_ip | VARCHAR(50) | 操作IP |
| oper_location | VARCHAR(255) | 操作地点 |
| oper_param | TEXT | 请求参数 |
| json_result | TEXT | 返回结果 |
| status | CHAR(1) | 操作状态：0成功 1失败 |
| error_msg | TEXT | 错误信息 |
| oper_time | TIMESTAMP | 操作时间 |
| cost_time | BIGINT | 耗时（毫秒） |
| user_agent | VARCHAR(500) | UA |

### API接口

#### 1. 创建操作日志
```
POST /api/v1/operLog
```

#### 2. 更新操作日志
```
PUT /api/v1/operLog
```

#### 3. 删除操作日志
```
DELETE /api/v1/operLog/{id}
```

#### 4. 批量删除操作日志
```
DELETE /api/v1/operLog/batch
```

#### 5. 查询操作日志详情
```
GET /api/v1/operLog/{id}
```

#### 6. 分页查询操作日志列表
```
GET /api/v1/operLog/list?pageNum=1&pageSize=10&title=用户管理&status=0
```

**查询参数**：
- pageNum: 页码（必填）
- pageSize: 每页数量（必填）
- title: 模块标题（可选，模糊查询）
- operName: 操作者（可选，模糊查询）
- businessType: 业务类型（可选）
- status: 操作状态（可选，0成功 1失败 -1全部）
- startTime: 开始时间（可选）
- endTime: 结束时间（可选）

#### 7. 清理操作日志
```
POST /api/v1/operLog/clean
{
  "days": 30
}
```

清理指定天数之前的操作日志。

## 充血模型设计

### Model层
- **查询方法**: FindByID
- **CRUD方法**: Create, Update, Delete, BatchDelete, List
- **工具方法**: IsSuccess, CleanOldLogs

### Service层
- 业务编排
- 参数校验
- 日志记录

### Controller层
- HTTP接口处理
- 请求参数绑定
- 统一响应格式
- 完善的Swagger注释

## 使用场景

### 登录日志
- 记录用户登录成功/失败
- 安全审计
- 异常登录检测
- 用户行为分析

### 操作日志
- 记录用户操作行为
- 审计追踪
- 问题排查
- 性能分析（通过cost_time）

## 性能优化

1. **索引优化**
   - 登录日志：user_name, login_time
   - 操作日志：oper_time

2. **物理删除**
   - 日志表使用物理删除，不占用存储空间

3. **异步记录**
   - 登录日志和操作日志都支持异步记录，不影响主流程性能

4. **定期清理**
   - 提供清理接口，定期清理历史日志

## 注意事项

1. **日志保留策略**: 建议定期清理历史日志，避免表过大影响性能
2. **敏感信息**: 操作日志的请求参数和返回结果可能包含敏感信息，需要脱敏处理
3. **存储空间**: 日志表增长较快，需要监控存储空间
4. **查询性能**: 大数据量时，建议使用时间范围筛选

## 集成说明

### 登录日志自动记录
登录日志已集成到认证控制器（auth.go）中，用户登录时自动记录。

### 操作日志自动记录
操作日志已集成到中间件（operation_log.go）中，可以通过中间件自动记录用户操作。

## 测试建议

1. 测试创建、更新、删除、查询功能
2. 测试分页查询和条件筛选
3. 测试批量删除功能
4. 测试日志清理功能
5. 测试时间范围查询
6. 测试大数据量下的查询性能
