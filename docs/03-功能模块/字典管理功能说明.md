# 字典管理功能说明

## 功能概述

字典管理模块提供了完整的字典数据CRUD功能，支持树形结构，主要用于：
- 前端下拉框选项配置（如性别、状态等）
- 动态参数配置
- 多级联动数据（如省市区三级联动）

## 数据库设计

### 表结构：s_dict_data

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGINT | 主键 | 使用分布式ID |
| parent_id | BIGINT | 父字典ID | 0表示根节点，支持树形结构 |
| sort | BIGINT | 排序 | 数值越小越靠前 |
| dict_label | VARCHAR(100) | 字典标签 | 显示给用户看的文本 |
| dict_value | VARCHAR(100) | 字典键值 | 实际存储的值 |
| dict_type | VARCHAR(100) | 字典类型 | 用于分类，如：sys_user_sex |
| is_default | BOOLEAN | 是否默认 | 标记默认选项 |
| status | INTEGER | 状态 | 0正常 1停用 |
| remark | VARCHAR(500) | 备注 | 说明信息 |
| create_by | BIGINT | 创建者 | 用户ID |
| created_time | TIMESTAMP | 创建时间 | 自动生成 |
| update_by | BIGINT | 更新者 | 用户ID |
| updated_time | TIMESTAMP | 更新时间 | 自动更新 |
| deleted_at | TIMESTAMP | 删除时间 | 软删除标记 |

### 索引

- PRIMARY KEY: id
- INDEX: parent_id（提升树形查询性能）
- INDEX: dict_type（提升类型查询性能）
- INDEX: deleted_at（软删除查询）

## 数据库迁移

### 执行迁移脚本

如果数据库中已存在 s_dict_data 表但缺少 parent_id 字段，执行以下迁移脚本：

```bash
# PostgreSQL
psql -U your_username -d your_database -f scripts/sql/migration_add_dict_parent_id.sql
```

迁移脚本会：
1. 添加 parent_id 字段（默认值为0）
2. 创建 parent_id 索引
3. 添加字段注释
4. 验证字段是否添加成功

## API接口

### 1. 创建字典

**接口**: `POST /api/v1/dict`

**请求体**:
```json
{
  "parentId": 0,
  "dictType": "sys_user_sex",
  "dictLabel": "男",
  "dictValue": "0",
  "sort": 1,
  "isDefault": false,
  "status": 0,
  "remark": "性别-男",
  "createBy": 1,
  "updateBy": 1
}
```

**响应**:
```json
{
  "code": 200,
  "msg": "创建字典成功",
  "data": null
}
```

### 2. 更新字典

**接口**: `PUT /api/v1/dict`

**请求体**:
```json
{
  "id": 1,
  "parentId": 0,
  "dictType": "sys_user_sex",
  "dictLabel": "男性",
  "dictValue": "0",
  "sort": 1,
  "isDefault": true,
  "status": 0,
  "remark": "性别-男性",
  "updateBy": 1
}
```

### 3. 删除字典

**接口**: `DELETE /api/v1/dict/{id}`

**说明**: 如果字典有子字典，则无法删除

### 4. 批量删除字典

**接口**: `DELETE /api/v1/dict/batch`

**请求体**:
```json
{
  "ids": [1, 2, 3]
}
```

### 5. 查询字典详情

**接口**: `GET /api/v1/dict/{id}`

**响应**:
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "id": 1,
    "parentId": 0,
    "dictType": "sys_user_sex",
    "dictLabel": "男",
    "dictValue": "0",
    "sort": 1,
    "isDefault": false,
    "status": 0,
    "remark": "性别-男",
    "createBy": 1,
    "createdTime": "2024-01-01 12:00:00",
    "updateBy": 1,
    "updatedTime": "2024-01-01 12:00:00"
  }
}
```

### 6. 分页查询字典列表

**接口**: `GET /api/v1/dict/list`

**查询参数**:
- pageNum: 页码（必填）
- pageSize: 每页数量（必填）
- dictType: 字典类型（可选）
- dictLabel: 字典标签，支持模糊查询（可选）
- status: 状态，0正常 1停用 -1全部（可选）

**示例**: `GET /api/v1/dict/list?pageNum=1&pageSize=10&dictType=sys_user_sex&status=0`

**响应**:
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "parentId": 0,
        "dictType": "sys_user_sex",
        "dictLabel": "男",
        "dictValue": "0",
        "sort": 1,
        "isDefault": false,
        "status": 0
      }
    ],
    "total": 1
  }
}
```

### 7. 根据类型获取字典列表（前端常用）

**接口**: `GET /api/v1/dict/type`

**查询参数**:
- dictType: 字典类型（必填）
- parentId: 父字典ID（可选，用于获取子字典）

**示例1 - 获取所有性别选项**:
```
GET /api/v1/dict/type?dictType=sys_user_sex
```

**示例2 - 获取某个省份下的城市列表**:
```
GET /api/v1/dict/type?dictType=region&parentId=110000
```

**响应**:
```json
{
  "code": 200,
  "msg": "success",
  "data": [
    {
      "id": 1,
      "parentId": 0,
      "dictType": "sys_user_sex",
      "dictLabel": "男",
      "dictValue": "0",
      "sort": 1,
      "status": 0
    },
    {
      "id": 2,
      "parentId": 0,
      "dictType": "sys_user_sex",
      "dictLabel": "女",
      "dictValue": "1",
      "sort": 2,
      "status": 0
    }
  ]
}
```

### 8. 根据类型和键值获取标签

**接口**: `GET /api/v1/dict/label`

**查询参数**:
- dictType: 字典类型（必填）
- dictValue: 字典键值（必填）

**示例**: `GET /api/v1/dict/label?dictType=sys_user_sex&dictValue=0`

**响应**:
```json
{
  "code": 200,
  "msg": "success",
  "data": "男"
}
```

**使用场景**: 数据展示时，将存储的值转换为用户可读的标签

## 使用场景示例

### 场景1：性别下拉框

**配置字典数据**:
```json
[
  {
    "dictType": "sys_user_sex",
    "dictLabel": "男",
    "dictValue": "0",
    "sort": 1
  },
  {
    "dictType": "sys_user_sex",
    "dictLabel": "女",
    "dictValue": "1",
    "sort": 2
  },
  {
    "dictType": "sys_user_sex",
    "dictLabel": "未知",
    "dictValue": "2",
    "sort": 3
  }
]
```

**前端调用**:
```javascript
// 获取性别选项
GET /api/v1/dict/type?dictType=sys_user_sex

// 显示时转换
GET /api/v1/dict/label?dictType=sys_user_sex&dictValue=0
// 返回: "男"
```

### 场景2：省市区三级联动

**配置字典数据**:
```json
[
  // 省份（parentId = 0）
  {
    "id": 110000,
    "parentId": 0,
    "dictType": "region",
    "dictLabel": "北京市",
    "dictValue": "110000",
    "sort": 1
  },
  // 城市（parentId = 省份ID）
  {
    "id": 110100,
    "parentId": 110000,
    "dictType": "region",
    "dictLabel": "北京市",
    "dictValue": "110100",
    "sort": 1
  },
  // 区县（parentId = 城市ID）
  {
    "id": 110101,
    "parentId": 110100,
    "dictType": "region",
    "dictLabel": "东城区",
    "dictValue": "110101",
    "sort": 1
  }
]
```

**前端调用**:
```javascript
// 1. 获取所有省份
GET /api/v1/dict/type?dictType=region&parentId=0

// 2. 选择省份后，获取该省的城市
GET /api/v1/dict/type?dictType=region&parentId=110000

// 3. 选择城市后，获取该市的区县
GET /api/v1/dict/type?dictType=region&parentId=110100
```

### 场景3：订单状态配置

**配置字典数据**:
```json
[
  {
    "dictType": "order_status",
    "dictLabel": "待支付",
    "dictValue": "0",
    "sort": 1,
    "isDefault": true
  },
  {
    "dictType": "order_status",
    "dictLabel": "已支付",
    "dictValue": "1",
    "sort": 2
  },
  {
    "dictType": "order_status",
    "dictLabel": "已发货",
    "dictValue": "2",
    "sort": 3
  },
  {
    "dictType": "order_status",
    "dictLabel": "已完成",
    "dictValue": "3",
    "sort": 4
  },
  {
    "dictType": "order_status",
    "dictLabel": "已取消",
    "dictValue": "9",
    "sort": 5
  }
]
```

## 充血模型设计

### Model层（internal/domain/model/s_dict.go）

提供基础能力：
- **查询方法**: FindByID, FindByType, FindByTypeAndParent, FindChildren
- **统计方法**: CountChildren
- **校验方法**: CheckDictValueExists, CheckDictValueExistsExcludingSelf
- **CRUD方法**: Create, Update, Delete, BatchDelete, List
- **工具方法**: GetDictLabel, GetDictValue, GetDefaultDict
- **领域规则**: IsActive, IsDefaultDict, HasChildren

### Service层（internal/service/dict.go）

业务编排：
- 调用Model层方法组合业务流程
- 复杂参数校验（如父字典类型匹配）
- 业务规则判断（如删除前检查子字典）
- 事务管理

### Controller层（internal/controller/dict.go）

HTTP接口处理：
- 请求参数绑定和验证
- 调用Service层方法
- 统一响应格式
- 完善的Swagger注释

## 性能优化

1. **索引优化**: parent_id 和 dict_type 字段建立索引
2. **查询优化**: 一次查询多次校验，避免重复数据库访问
3. **软删除**: 使用 deleted_at 字段，支持数据恢复
4. **排序优化**: 使用 sort 字段控制显示顺序

## 注意事项

1. **字典值唯一性**: 同一 dictType 下，dictValue 必须唯一
2. **父子关系**: 父字典和子字典必须是同一 dictType
3. **删除限制**: 有子字典的字典无法删除
4. **循环引用**: 不能将自己设置为父字典
5. **状态控制**: status=1 的字典不会在前端接口中返回

## 测试建议

1. 创建基础字典类型（如性别、状态等）
2. 测试树形结构（创建父子关系）
3. 测试删除限制（尝试删除有子字典的字典）
4. 测试唯一性约束（创建重复的 dictValue）
5. 测试分页查询和筛选功能
6. 测试前端常用接口（GetByType）
