# Casbin RBAC æƒé™ç®¡ç†ç³»ç»Ÿ

## ğŸ‰ å®æ–½å®Œæˆ

åŸºäº Casbin çš„å®Œæ•´ RBAC æƒé™ç®¡ç†ç³»ç»Ÿå·²ç»å®æ–½å®Œæˆï¼

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### 1. é…ç½®æ–‡ä»¶
- âœ… `cmd/api/casbin_model.conf` - Casbin æ¨¡å‹é…ç½®ï¼ˆå«è¯¦ç»†æ³¨é‡Šï¼‰
  - æ³¨æ„ï¼šæ­¤æ–‡ä»¶éœ€è¦ä¸ç¼–è¯‘åçš„å¯æ‰§è¡Œæ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•

### 2. æ•°æ®åº“è„šæœ¬
- âœ… `scripts/sql/002_init_rbac_tables.sql` - æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬

### 3. æ•°æ®æ¨¡å‹
- âœ… `internal/domain/model/sys_role.go` - è§’è‰²æ¨¡å‹
- âœ… `internal/domain/model/sys_org.go` - ç»„ç»‡æ¨¡å‹
- âœ… `internal/domain/model/sys_menu.go` - èœå•æ¨¡å‹

### 4. è¯·æ±‚/å“åº”æ¨¡å‹
- âœ… `internal/domain/request/role.go` - è§’è‰²è¯·æ±‚æ¨¡å‹
- âœ… `internal/domain/response/role.go` - è§’è‰²å“åº”æ¨¡å‹

### 5. æœåŠ¡å±‚
- âœ… `internal/service/casbin_service.go` - Casbin æƒé™æœåŠ¡ï¼ˆå«è¯¦ç»†æ³¨é‡Šï¼‰
- âœ… `internal/service/role_service.go` - è§’è‰²ç®¡ç†æœåŠ¡

### 6. æ§åˆ¶å™¨
- âœ… `internal/controller/role.go` - è§’è‰²ç®¡ç†æ§åˆ¶å™¨ï¼ˆ14ä¸ªAPIï¼‰

### 7. ä¸­é—´ä»¶
- âœ… `internal/middleware/permission.go` - æƒé™æ£€æŸ¥ä¸­é—´ä»¶ï¼ˆå«è¯¦ç»†æ³¨é‡Šï¼‰

### 8. è·¯ç”±
- âœ… `internal/router/role.go` - è§’è‰²ç®¡ç†è·¯ç”±ï¼ˆå«æƒé™é…ç½®ç¤ºä¾‹ï¼‰

### 9. å®¹å™¨é›†æˆ
- âœ… `internal/container/container.go` - å·²é›†æˆ Casbin åˆå§‹åŒ–

### 10. æ–‡æ¡£
- âœ… `docs/Casbinæƒé™ç®¡ç†ä½¿ç”¨æŒ‡å—.md` - å®Œæ•´ä½¿ç”¨æŒ‡å—
- âœ… `docs/Casbinæƒé™æµ‹è¯•ç¤ºä¾‹.md` - æµ‹è¯•ç¤ºä¾‹
- âœ… `docs/Casbinå®æ–½æ€»ç»“.md` - å®æ–½æ€»ç»“
- âœ… `docs/README_Casbin.md` - æœ¬æ–‡æ¡£

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```bash
go get github.com/casbin/casbin/v2@latest
go get github.com/casbin/gorm-adapter/v3@latest
```

### 2. åˆå§‹åŒ–æ•°æ®åº“
```bash
psql -U postgres -d nai-tizi -f scripts/sql/002_init_rbac_tables.sql
```

### 3. å¯åŠ¨æœåŠ¡
```bash
cd cmd/api
go run main.go
```

### 4. æµ‹è¯•æƒé™
```bash
# ç™»å½•è·å– Token
curl -X POST http://localhost:9009/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "clientKey": "web_client",
    "clientSecret": "web_secret_2024",
    "username": "admin",
    "password": "admin123"
  }'

# è®¿é—®è§’è‰²åˆ—è¡¨
curl -X GET "http://localhost:9009/api/v1/roles?pageNum=1&pageSize=10" \
  -H "Authorization: Bearer {your_access_token}"
```

---

## â­ æ ¸å¿ƒç‰¹æ€§

### 1. é€šé…ç¬¦æƒé™
```bash
# ç”¨æˆ·æ¨¡å—æ‰€æœ‰æƒé™
user.*

# æ‰€æœ‰æ¨¡å—çš„è¯»æƒé™
*.read

# æ‰€æœ‰æƒé™ï¼ˆè¶…çº§ç®¡ç†å‘˜ï¼‰
*
```

### 2. admin è¶…çº§ç®¡ç†å‘˜
- admin è§’è‰²è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™
- æ— éœ€æ‰‹åŠ¨é…ç½®ä»»ä½•æƒé™
- åœ¨ Casbin æ¨¡å‹ä¸­é…ç½®äº†ç‰¹æ®Šè§„åˆ™

### 3. å¤šç§Ÿæˆ·éš”ç¦»
- ç”¨æˆ·åœ¨ä¸åŒç»„ç»‡å¯ä»¥æœ‰ä¸åŒè§’è‰²
- æƒé™å®Œå…¨éš”ç¦»
- é€šè¿‡ç»„ç»‡IDï¼ˆorgIdï¼‰å®ç°

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### æ–°æ‰‹å…¥é—¨
1. é˜…è¯» [Casbinæƒé™ç®¡ç†ä½¿ç”¨æŒ‡å—.md](./Casbinæƒé™ç®¡ç†ä½¿ç”¨æŒ‡å—.md)
2. æ‰§è¡Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
3. å‚è€ƒ [Casbinæƒé™æµ‹è¯•ç¤ºä¾‹.md](./Casbinæƒé™æµ‹è¯•ç¤ºä¾‹.md) è¿›è¡Œæµ‹è¯•

### å¼€å‘è€…
1. æŸ¥çœ‹ `cmd/api/casbin_model.conf` äº†è§£æƒé™æ¨¡å‹
2. æŸ¥çœ‹ `internal/service/casbin_service.go` äº†è§£æœåŠ¡æ¥å£
3. æŸ¥çœ‹ `internal/middleware/permission.go` äº†è§£ä¸­é—´ä»¶ä½¿ç”¨
4. æŸ¥çœ‹ `internal/router/role.go` äº†è§£è·¯ç”±é…ç½®

### è¿ç»´äººå‘˜
1. æŸ¥çœ‹ `scripts/sql/002_init_rbac_tables.sql` äº†è§£æ•°æ®åº“ç»“æ„
2. æŸ¥çœ‹ [Casbinå®æ–½æ€»ç»“.md](./Casbinå®æ–½æ€»ç»“.md) äº†è§£ç³»ç»Ÿæ¶æ„

---

## ğŸ¯ API æ¥å£

### è§’è‰²ç®¡ç†
- `GET /api/v1/roles` - è·å–è§’è‰²åˆ—è¡¨
- `GET /api/v1/roles/:roleId` - è·å–è§’è‰²è¯¦æƒ…
- `POST /api/v1/roles` - åˆ›å»ºè§’è‰²
- `PUT /api/v1/roles` - æ›´æ–°è§’è‰²
- `DELETE /api/v1/roles/:roleId` - åˆ é™¤è§’è‰²

### ç”¨æˆ·è§’è‰²ç®¡ç†
- `POST /api/v1/roles/assign` - ä¸ºç”¨æˆ·åˆ†é…è§’è‰²
- `DELETE /api/v1/roles/remove` - ç§»é™¤ç”¨æˆ·è§’è‰²
- `GET /api/v1/roles/user` - è·å–ç”¨æˆ·è§’è‰²

### æƒé™ç®¡ç†
- `POST /api/v1/roles/permission` - ä¸ºè§’è‰²æ·»åŠ æƒé™
- `DELETE /api/v1/roles/permission` - åˆ é™¤è§’è‰²æƒé™
- `GET /api/v1/roles/permissions` - è·å–è§’è‰²æƒé™

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### åœ¨è·¯ç”±ä¸­ä½¿ç”¨æƒé™ä¸­é—´ä»¶
```go
import (
    "github.com/force-c/nai-tizi/internal/middleware"
    "github.com/gin-gonic/gin"
)

// å•ä¸ªæƒé™æ£€æŸ¥
router.GET("/users", 
    middleware.Auth(tokenManager, cfg),
    middleware.Permission(casbinService, "user.read", "read"),
    userController.ListUsers)

// é€šé…ç¬¦æƒé™
router.POST("/users", 
    middleware.Auth(tokenManager, cfg),
    middleware.Permission(casbinService, "user.*", "write"),
    userController.CreateUser)
```

### åœ¨ä»£ç ä¸­æ£€æŸ¥æƒé™
```go
// æ£€æŸ¥ç”¨æˆ·æƒé™
allowed, err := casbinService.CheckPermission(ctx, userId, orgId, "user.create", "write")
if !allowed {
    return errors.New("æ— æƒé™")
}
```

### ä¸ºè§’è‰²æ·»åŠ æƒé™
```go
// æ·»åŠ é€šé…ç¬¦æƒé™
err := casbinService.AddPermissionForRole(ctx, "user_manager", 1, "user.*", "write")

// æ·»åŠ åªè¯»æƒé™
err := casbinService.AddPermissionForRole(ctx, "viewer", 1, "*.read", "read")
```

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ Casbin ç­–ç•¥
```sql
-- æŸ¥çœ‹æ‰€æœ‰ç­–ç•¥
SELECT * FROM casbin_rule;

-- æŸ¥çœ‹è§’è‰²æƒé™
SELECT * FROM casbin_rule WHERE ptype = 'p';

-- æŸ¥çœ‹ç”¨æˆ·è§’è‰²å…³ç³»
SELECT * FROM casbin_rule WHERE ptype = 'g';
```

### 2. å¼€å¯ Casbin æ—¥å¿—
å¼€å‘ç¯å¢ƒé»˜è®¤å¼€å¯ï¼Œå¯ä»¥åœ¨æ—¥å¿—ä¸­çœ‹åˆ°æƒé™æ£€æŸ¥çš„è¯¦ç»†è¿‡ç¨‹ã€‚

### 3. ä½¿ç”¨ API è°ƒè¯•
```bash
# æŸ¥çœ‹ç”¨æˆ·è§’è‰²
GET /api/v1/roles/user?userId=1001&orgId=1

# æŸ¥çœ‹è§’è‰²æƒé™
GET /api/v1/roles/permissions?roleKey=admin&orgId=1
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç»„ç»‡IDä¼ é€’
æƒé™æ£€æŸ¥éœ€è¦ç»„ç»‡IDï¼Œæœ‰ä»¥ä¸‹å‡ ç§æ–¹å¼ï¼š
- è¯·æ±‚å¤´ï¼š`X-Org-Id: 1`
- æŸ¥è¯¢å‚æ•°ï¼š`?orgId=1`
- Contextï¼š`c.Set("orgId", 1)`

å¦‚æœéƒ½æ²¡æœ‰ï¼Œé»˜è®¤ä½¿ç”¨ç»„ç»‡ID=1ã€‚

### 2. admin è§’è‰²
- admin è§’è‰²åœ¨ Casbin æ¨¡å‹ä¸­æœ‰ç‰¹æ®Šè§„åˆ™
- æ— éœ€ä¸º admin è§’è‰²æ·»åŠ ä»»ä½•æƒé™
- è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™

### 3. æƒé™å‘½åè§„èŒƒ
æ¨èä½¿ç”¨ `æ¨¡å—.æ“ä½œ` æ ¼å¼ï¼š
- `user.create` - åˆ›å»ºç”¨æˆ·
- `user.read` - æŸ¥è¯¢ç”¨æˆ·
- `user.update` - æ›´æ–°ç”¨æˆ·
- `user.delete` - åˆ é™¤ç”¨æˆ·
- `user.*` - ç”¨æˆ·æ¨¡å—æ‰€æœ‰æƒé™

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Gin Router                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Auth Middleware (è®¤è¯)                          â”‚  â”‚
â”‚  â”‚  â†“                                                â”‚  â”‚
â”‚  â”‚  Permission Middleware (æƒé™æ£€æŸ¥)                 â”‚  â”‚
â”‚  â”‚  â†“                                                â”‚  â”‚
â”‚  â”‚  Controller (æ§åˆ¶å™¨)                              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Service Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ CasbinService    â”‚  â”‚ RoleService      â”‚           â”‚
â”‚  â”‚ - CheckPermissionâ”‚  â”‚ - Create         â”‚           â”‚
â”‚  â”‚ - AddRole        â”‚  â”‚ - Update         â”‚           â”‚
â”‚  â”‚ - AddPermission  â”‚  â”‚ - Delete         â”‚           â”‚
â”‚  â”‚                  â”‚  â”‚ - AssignRole     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Data Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ Casbin Enforcer  â”‚  â”‚ GORM Database    â”‚           â”‚
â”‚  â”‚ - casbin_rule    â”‚  â”‚ - sys_role       â”‚           â”‚
â”‚  â”‚                  â”‚  â”‚ - sys_user_role  â”‚           â”‚
â”‚  â”‚                  â”‚  â”‚ - sys_role_menu  â”‚           â”‚
â”‚  â”‚                  â”‚  â”‚ - sys_org        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… éªŒè¯æ¸…å•

- [x] Casbin æ¨¡å‹é…ç½®å®Œæˆ
- [x] æ•°æ®åº“è¡¨åˆ›å»ºå®Œæˆ
- [x] æ•°æ®æ¨¡å‹å®šä¹‰å®Œæˆ
- [x] æœåŠ¡å±‚å®ç°å®Œæˆ
- [x] æ§åˆ¶å™¨å®ç°å®Œæˆ
- [x] ä¸­é—´ä»¶å®ç°å®Œæˆ
- [x] è·¯ç”±é…ç½®å®Œæˆ
- [x] å®¹å™¨é›†æˆå®Œæˆ
- [x] æ–‡æ¡£ç¼–å†™å®Œæˆ
- [x] ç¼–è¯‘æµ‹è¯•é€šè¿‡

---

## ğŸŠ æ€»ç»“

Casbin RBAC æƒé™ç®¡ç†ç³»ç»Ÿå·²ç»å®Œå…¨å®æ–½å®Œæˆï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹æ€§ï¼š

1. âœ… **é€šé…ç¬¦æƒé™**ï¼šæ”¯æŒ `user.*`ã€`*.read`ã€`*` ç­‰é€šé…ç¬¦
2. âœ… **admin è¶…çº§ç®¡ç†å‘˜**ï¼šè‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™
3. âœ… **å¤šç§Ÿæˆ·éš”ç¦»**ï¼šä¸åŒç»„ç»‡æƒé™å®Œå…¨éš”ç¦»
4. âœ… **ç»†ç²’åº¦æ§åˆ¶**ï¼šå¯ç²¾ç¡®åˆ°æ¯ä¸ªæ¥å£çš„æƒé™æ§åˆ¶
5. âœ… **è¯¦ç»†æ³¨é‡Š**ï¼šæ‰€æœ‰æ ¸å¿ƒæ–‡ä»¶éƒ½æœ‰è¯¦ç»†çš„ä¸­æ–‡æ³¨é‡Š
6. âœ… **å®Œæ•´æ–‡æ¡£**ï¼šæä¾›äº†ä½¿ç”¨æŒ‡å—ã€æµ‹è¯•ç¤ºä¾‹ã€å®æ–½æ€»ç»“

ç³»ç»Ÿå·²ç»å¯ä»¥æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼ğŸš€

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- [Casbin å®˜æ–¹æ–‡æ¡£](https://casbin.org/docs/zh-CN/overview)
- [Casbinæƒé™ç®¡ç†ä½¿ç”¨æŒ‡å—.md](./Casbinæƒé™ç®¡ç†ä½¿ç”¨æŒ‡å—.md)
- [Casbinæƒé™æµ‹è¯•ç¤ºä¾‹.md](./Casbinæƒé™æµ‹è¯•ç¤ºä¾‹.md)
