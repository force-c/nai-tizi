# 操作日志中间件使用指南

## 概述

操作日志中间件 (`OperationLog`) 用于自动记录所有 API 接口的访问信息，包括请求参数、响应状态、执行时间等。中间件会智能推断业务类型和操作标题，也支持在 Controller 中自定义这些信息。

## 功能特性

### 1. 自动记录的信息

中间件会自动记录以下信息到 `s_oper_log` 表：

| 字段 | 说明 | 获取方式 |
|------|------|----------|
| `title` | 模块标题 | 自动从路径推断或从上下文获取 |
| `business_type` | 业务类型 | 自动从请求方法和路径推断或从上下文获取 |
| `method` | 调用方法 | Gin Handler 名称 |
| `request_method` | 请求方式 | GET/POST/PUT/DELETE 等 |
| `operator_type` | 终端类型 | 从 access_token 解析（web/ios/android/wechat 等） |
| `oper_name` | 操作者 | 格式为 "用户ID-用户名称" |
| `oper_url` | 请求 URL | 请求路径 |
| `oper_ip` | 操作 IP | 客户端 IP |
| `oper_param` | 请求参数 | POST/PUT 的 Body 或 GET 的 Query |
| `status` | 操作状态 | 0=成功, 1=失败 |
| `error_msg` | 错误信息 | 从 Gin Errors 获取 |
| `oper_time` | 操作时间 | 请求开始时间 |
| `cost_time` | 耗时(毫秒) | 请求处理时长 |
| `user_agent` | UA | 浏览器 User-Agent |

### 2. 业务类型自动推断

中间件会根据以下规则自动推断业务类型：

#### 特殊路径判断（优先级高）

| 路径特征 | 业务类型 | 说明 |
|---------|---------|------|
| 包含 `/export` | EXPORT | 导出操作 |
| 包含 `/import` | IMPORT | 导入操作 |
| 包含 `/grant` 或 `/permission` | GRANT | 授权操作 |
| 包含 `/clean` | CLEAN | 清空操作 |
| 包含 `/page` 或 `/list` | QUERY | 分页查询 |

#### HTTP 方法判断（优先级低）

| HTTP 方法 | 业务类型 | 说明 |
|----------|---------|------|
| GET | QUERY | 查询操作 |
| POST | CREATE | 创建操作 |
| PUT/PATCH | UPDATE | 更新操作 |
| DELETE | DELETE | 删除操作 |
| 其他 | OTHER | 其他操作 |

### 3. 标题自动生成

中间件会根据请求路径自动生成操作标题：

```
/api/v1/user/123      -> "用户"
/api/v1/role/page     -> "角色"
/api/v1/menu          -> "菜单"
/api/v1/org/1         -> "组织"
```

支持的资源映射：

| 路径资源 | 中文标题 |
|---------|---------|
| user | 用户 |
| role | 角色 |
| menu | 菜单 |
| org | 组织 |
| dict | 字典 |
| config | 配置 |
| loginLog | 登录日志 |
| operLog | 操作日志 |
| storageEnv | 存储环境 |
| attachment | 附件 |

## 使用方式

### 1. 基本使用（自动推断）

大多数情况下，中间件会自动推断业务类型和标题，无需额外配置：

```go
// 在路由中使用中间件
func registerUserRoutes(r *gin.Engine, ctx *RouterContext) {
    userController := controller.NewUserController(ctx.Container)
    
    v1 := r.Group("/api/v1")
    {
        user := v1.Group("/user")
        user.Use(ctx.AuthMiddleware)
        user.Use(middleware.OperationLog(ctx.Container.DB, ctx.Container.Logger)) // 添加操作日志中间件
        {
            user.GET("/:id", userController.GetUserById)        // 自动推断: QUERY, "用户"
            user.POST("", userController.CreateUser)            // 自动推断: CREATE, "用户"
            user.PUT("/:id", userController.UpdateUser)         // 自动推断: UPDATE, "用户"
            user.DELETE("/:id", userController.DeleteUser)      // 自动推断: DELETE, "用户"
            user.POST("/page", userController.PageUser)         // 自动推断: QUERY, "用户"
            user.POST("/export", userController.ExportUser)     // 自动推断: EXPORT, "用户"
        }
    }
}
```

### 2. 自定义标题和业务类型

如果需要自定义标题或业务类型，可以在 Controller 中设置上下文值：

```go
// 在 Controller 中自定义
func (ctrl *UserController) ResetPassword(c *gin.Context) {
    // 设置自定义标题
    c.Set(middleware.OperLogTitleKey, "重置密码")
    
    // 设置自定义业务类型
    c.Set(middleware.OperLogBusinessTypeKey, constants.BusinessTypeUpdate)
    
    // 业务逻辑...
    // ...
}

func (ctrl *RoleController) AssignPermissions(c *gin.Context) {
    // 设置自定义信息
    c.Set(middleware.OperLogTitleKey, "分配权限")
    c.Set(middleware.OperLogBusinessTypeKey, constants.BusinessTypeGrant)
    
    // 业务逻辑...
    // ...
}
```

### 3. 在全局路由中使用

可以在全局路由中添加中间件，对所有接口生效：

```go
func SetupRouter(container *container.Container) *gin.Engine {
    r := gin.New()
    
    // 全局中间件
    r.Use(gin.Recovery())
    r.Use(middleware.Cors())
    r.Use(middleware.OperationLog(container.DB, container.Logger)) // 全局操作日志
    
    // 注册路由...
    return r
}
```

### 4. 选择性使用

也可以只对特定路由组使用：

```go
// 只对需要记录日志的接口使用
v1 := r.Group("/api/v1")
{
    // 公开接口不记录日志
    auth := v1.Group("/auth")
    {
        auth.POST("/login", authController.Login)
        auth.POST("/logout", authController.Logout)
    }
    
    // 管理接口记录日志
    admin := v1.Group("/admin")
    admin.Use(middleware.OperationLog(db, logger)) // 只对管理接口记录
    {
        admin.GET("/users", userController.ListUsers)
        admin.POST("/users", userController.CreateUser)
    }
}
```

## 业务类型常量

在 `internal/constants/enums.go` 中定义了所有业务类型常量：

```go
const (
    BusinessTypeOther  = "OTHER"  // 其他
    BusinessTypeQuery  = "QUERY"  // 查询
    BusinessTypeCreate = "CREATE" // 新增
    BusinessTypeUpdate = "UPDATE" // 修改
    BusinessTypeDelete = "DELETE" // 删除
    BusinessTypeExport = "EXPORT" // 导出
    BusinessTypeImport = "IMPORT" // 导入
    BusinessTypeGrant  = "GRANT"  // 授权
    BusinessTypeClean  = "CLEAN"  // 清空
)
```

## 示例场景

### 场景 1：用户管理

```go
// 自动推断示例
POST /api/v1/user              -> CREATE, "用户"
GET  /api/v1/user/123          -> QUERY, "用户"
PUT  /api/v1/user/123          -> UPDATE, "用户"
DELETE /api/v1/user/123        -> DELETE, "用户"
POST /api/v1/user/page         -> QUERY, "用户"
POST /api/v1/user/export       -> EXPORT, "用户"
```

### 场景 2：角色权限

```go
// Controller 中自定义
func (ctrl *RoleController) AssignMenus(c *gin.Context) {
    c.Set(middleware.OperLogTitleKey, "分配菜单")
    c.Set(middleware.OperLogBusinessTypeKey, constants.BusinessTypeGrant)
    // ...
}

// 记录结果: GRANT, "分配菜单"
```

### 场景 3：数据清理

```go
// 自动推断
POST /api/v1/loginLog/clean    -> CLEAN, "登录日志"
POST /api/v1/operLog/clean     -> CLEAN, "操作日志"
```

## 字段获取详解

### 1. 操作者（oper_name）

格式：`用户ID-用户名称`

从认证中间件的上下文中获取：
- `userId`：用户ID
- `userName`：用户名称

示例：
- 完整信息：`123-张三`
- 只有用户名：`张三`
- 只有用户ID：`123`
- 都没有：`-`

### 2. 终端类型（operator_type）

从 access_token 中解析的 `deviceType` 字段获取，可能的值：
- `web`：Web 浏览器
- `ios`：iOS 应用
- `android`：Android 应用
- `wechat`：微信小程序
- `unknown`：未知终端（token 中未包含此信息）

认证中间件会自动将 token 中的 `deviceType` 设置到上下文中。

### 3. 业务类型（business_type）

优先级：
1. **自定义**：Controller 中通过 `c.Set(middleware.OperLogBusinessTypeKey, "XXX")` 设置
2. **路径推断**：根据路径特征判断（如 `/export`、`/import`、`/clean` 等）
3. **方法推断**：根据 HTTP 方法判断（GET→QUERY、POST→CREATE 等）

### 4. 标题（title）

优先级：
1. **自定义**：Controller 中通过 `c.Set(middleware.OperLogTitleKey, "XXX")` 设置
2. **路径映射**：从路径中提取资源名称并映射为中文（如 `/user` → "用户"）

## 注意事项

1. **异步记录**：日志记录是异步的，不会阻塞请求处理
2. **参数截断**：请求参数最多记录 2000 字符，错误信息最多 1000 字符
3. **Body 读取**：只对 POST/PUT/PATCH 请求读取 Body，GET/DELETE 记录 Query 参数
4. **依赖认证中间件**：需要在认证中间件之后使用，以获取用户信息和终端类型
5. **性能影响**：由于是异步记录，对接口性能影响极小

## 查询操作日志

可以通过操作日志接口查询记录：

```bash
# 分页查询
POST /api/v1/operLog/page
{
  "pageNum": 1,
  "pageSize": 10,
  "title": "用户",
  "businessType": "CREATE",
  "status": "0"
}

# 查询详情
GET /api/v1/operLog/{id}

# 清空日志
POST /api/v1/operLog/clean
{
  "days": 30
}
```

## 扩展建议

如果需要扩展功能，可以考虑：

1. **添加更多资源映射**：在 `generateTitleFromPath` 函数中添加
2. **自定义业务类型**：在 `constants/enums.go` 中添加新的业务类型
3. **增强推断逻辑**：在 `inferBusinessType` 函数中添加更多规则
4. **记录响应结果**：可以在中间件中添加响应拦截，记录返回数据
5. **IP 地址解析**：集成 IP 地址库，解析操作地点

## 总结

操作日志中间件提供了智能的自动记录功能，大多数场景下无需额外配置。对于特殊场景，可以通过上下文设置自定义标题和业务类型。这种设计既保证了易用性，又提供了足够的灵活性。
