# S3 Manager 使用指南

## 概述

S3 Manager 是一个统一的对象存储管理器，支持 MinIO、AWS S3、阿里云 OSS（S3兼容）、RustFS 等所有 S3 兼容的对象存储服务。

## 配置

### 配置文件 (conf.dev.yaml)

```yaml
s3:
  enabled: true                        # 是否启用S3存储
  endpoint: "localhost:9000"           # MinIO/S3服务器地址
  accessKeyId: "minioadmin"            # 访问密钥ID
  secretAccessKey: "minioadmin"        # 访问密钥
  region: "us-east-1"                  # 区域
  bucket: "NTZ"                   # 默认存储桶名称
  useSSL: false                        # 是否使用SSL
  forcePathStyle: true                 # 强制路径样式（MinIO需要）
```

### 配置说明

- **enabled**: 是否启用 S3 存储，设置为 false 时所有操作将返回错误
- **endpoint**:
  - MinIO: `localhost:9000`
  - AWS S3: 留空（使用默认endpoint）
  - 阿里云OSS: `oss-cn-hangzhou.aliyuncs.com`
- **forcePathStyle**:
  - MinIO 必须设置为 `true`
  - AWS S3 设置为 `false`

## 使用示例

### 在 Controller 中使用

```go
package controller

import (
    "context"
    "io"
    "net/http"
    "time"

    "github.com/force-c/nai-ti-zi/internal/container"
    "github.com/force-c/nai-ti-zi/internal/domain/response"
    "github.com/gin-gonic/gin"
)

type FileController struct {
    ctr container.Container
}

func NewFileController(c container.Container) *FileController {
    return &FileController{ctr: c}
}

// UploadFile 上传文件
// POST /NTZ/file/upload
func (h *FileController) UploadFile(c *gin.Context) {
    ctx := context.Background()
    s3 := h.ctr.GetS3()

    // 获取上传的文件
    file, header, err := c.Request.FormFile("file")
    if err != nil {
        response.FailWithMsg(c, "文件上传失败")
        return
    }
    defer file.Close()

    // 构建存储路径
    key := fmt.Sprintf("uploads/%s/%s",
        time.Now().Format("2006-01-02"),
        header.Filename)

    // 上传到S3
    err = s3.UploadFile(ctx, key, file, header.Header.Get("Content-Type"))
    if err != nil {
        h.ctr.GetLogger().Error("failed to upload file", zap.Error(err))
        response.FailWithMsg(c, "文件上传失败")
        return
    }

    response.Success(c, gin.H{
        "key": key,
        "url": fmt.Sprintf("/NTZ/file/download/%s", key),
    })
}

// DownloadFile 下载文件
// GET /NTZ/file/download/:key
func (h *FileController) DownloadFile(c *gin.Context) {
    ctx := context.Background()
    s3 := h.ctr.GetS3()

    key := c.Param("key")

    // 从S3下载文件
    reader, err := s3.DownloadFile(ctx, key)
    if err != nil {
        response.FailWithMsg(c, "文件不存在")
        return
    }
    defer reader.Close()

    // 返回文件流
    c.Header("Content-Disposition", fmt.Sprintf("attachment; filename=%s", filepath.Base(key)))
    c.Status(http.StatusOK)
    io.Copy(c.Writer, reader)
}

// GetPresignedURL 获取预签名URL
// GET /NTZ/file/presigned/:key
func (h *FileController) GetPresignedURL(c *gin.Context) {
    ctx := context.Background()
    s3 := h.ctr.GetS3()

    key := c.Param("key")

    // 生成1小时有效期的预签名URL
    url, err := s3.GetPresignedURL(ctx, key, 1*time.Hour)
    if err != nil {
        response.FailWithMsg(c, "生成URL失败")
        return
    }

    response.Success(c, gin.H{"url": url})
}

// DeleteFile 删除文件
// DELETE /NTZ/file/:key
func (h *FileController) DeleteFile(c *gin.Context) {
    ctx := context.Background()
    s3 := h.ctr.GetS3()

    key := c.Param("key")

    err := s3.DeleteFile(ctx, key)
    if err != nil {
        response.FailWithMsg(c, "删除失败")
        return
    }

    response.Success(c, "删除成功")
}

// ListFiles 列出文件
// GET /NTZ/file/list
func (h *FileController) ListFiles(c *gin.Context) {
    ctx := context.Background()
    s3 := h.ctr.GetS3()

    prefix := c.Query("prefix") // 例如: "uploads/2024-12-10/"

    files, err := s3.ListFiles(ctx, prefix, 100)
    if err != nil {
        response.FailWithMsg(c, "查询失败")
        return
    }

    response.Success(c, files)
}
```

### 在 Service 中使用

```go
package service

import (
    "context"
    "fmt"
    "time"

    "github.com/force-c/nai-ti-zi/internal/s3manager"
)

type AvatarService struct {
    s3 *s3manager.Manager
}

func NewAvatarService(s3 *s3manager.Manager) *AvatarService {
    return &AvatarService{s3: s3}
}

// SaveAvatar 保存用户头像
func (s *AvatarService) SaveAvatar(ctx context.Context, userId int64, avatarData io.Reader) (string, error) {
    key := fmt.Sprintf("avatars/%d/%d.jpg", userId, time.Now().Unix())

    err := s.s3.UploadFile(ctx, key, avatarData, "image/jpeg")
    if err != nil {
        return "", err
    }

    // 返回访问URL（预签名URL或CDN地址）
    url, err := s.s3.GetPresignedURL(ctx, key, 7*24*time.Hour)
    if err != nil {
        return "", err
    }

    return url, nil
}

// CopyAvatar 复制用户头像
func (s *AvatarService) CopyAvatar(ctx context.Context, fromUserId, toUserId int64) error {
    sourceKey := fmt.Sprintf("avatars/%d/current.jpg", fromUserId)
    destKey := fmt.Sprintf("avatars/%d/current.jpg", toUserId)

    return s.s3.CopyFile(ctx, sourceKey, destKey)
}
```

## API 方法说明

### UploadFile
上传文件到 S3

**参数:**
- `ctx`: 上下文
- `key`: 文件在 S3 中的路径（如 "images/avatar.jpg"）
- `reader`: 文件内容读取器
- `contentType`: MIME类型（如 "image/jpeg"）

### DownloadFile
从 S3 下载文件

**参数:**
- `ctx`: 上下文
- `key`: 文件路径

**返回:** `io.ReadCloser` (记得调用 Close())

### DeleteFile
删除文件

**参数:**
- `ctx`: 上下文
- `key`: 文件路径

### FileExists
检查文件是否存在

**参数:**
- `ctx`: 上下文
- `key`: 文件路径

**返回:** `bool, error`

### GetPresignedURL
获取预签名URL（临时访问链接）

**参数:**
- `ctx`: 上下文
- `key`: 文件路径
- `expiration`: 有效期（如 `1*time.Hour`）

**返回:** URL字符串

### ListFiles
列出文件

**参数:**
- `ctx`: 上下文
- `prefix`: 路径前缀（如 "uploads/"）
- `maxKeys`: 最大返回数量

**返回:** 文件路径列表

### CopyFile
复制文件

**参数:**
- `ctx`: 上下文
- `sourceKey`: 源文件路径
- `destKey`: 目标文件路径

### CreateBucket
创建存储桶

**参数:**
- `ctx`: 上下文
- `bucketName`: 存储桶名称

## MinIO 本地部署

### Docker 快速启动

```bash
docker run -d \
  -p 9000:9000 \
  -p 9001:9001 \
  --name minio \
  -e "MINIO_ROOT_USER=minioadmin" \
  -e "MINIO_ROOT_PASSWORD=minioadmin" \
  -v /data/minio:/data \
  minio/minio server /data --console-address ":9001"
```

访问 MinIO Console: http://localhost:9001

### 创建存储桶

1. 登录 MinIO Console
2. 点击 "Buckets" -> "Create Bucket"
3. 输入名称: `NTZ`
4. 点击 "Create Bucket"

## 最佳实践

1. **文件路径命名**
   ```
   uploads/2024-12-10/image.jpg       # 按日期分类
   avatars/user_123/avatar.jpg        # 按用户分类
   documents/order_456/invoice.pdf    # 按订单分类
   ```

2. **Content-Type 设置**
   - 图片: `image/jpeg`, `image/png`
   - PDF: `application/pdf`
   - 文本: `text/plain`

3. **错误处理**
   ```go
   if !s3.IsEnabled() {
       // S3未启用，使用本地存储或返回错误
   }
   ```

4. **预签名URL有效期**
   - 用户头像: 7天
   - 临时下载: 1小时
   - 分享链接: 24小时

## 常见问题

**Q: 如何在本地开发时禁用 S3？**
A: 在配置文件中设置 `enabled: false`

**Q: MinIO 连接报错？**
A: 检查 `forcePathStyle: true` 是否设置

**Q: 如何使用阿里云 OSS？**
A: 设置正确的 endpoint（如 `oss-cn-hangzhou.aliyuncs.com`）和凭证

**Q: 文件上传失败？**
A: 检查存储桶是否存在、权限是否正确
