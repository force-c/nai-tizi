# 配置管理功能说明

## 功能概述

配置管理模块提供了完整的配置数据CRUD功能，支持存储JSON格式的配置数据，主要用于：
- 系统配置参数管理
- 动态业务配置
- 功能开关配置
- 第三方服务配置（如API密钥、服务地址等）
- 前端动态配置

## 数据库设计

### 表结构：s_config

| 字段名 | 类型 | 说明 | 备注 |
|--------|------|------|------|
| id | BIGINT | 主键 | 使用分布式ID |
| name | VARCHAR(100) | 配置名称 | 唯一标识，不可重复 |
| type | VARCHAR(100) | 配置类型 | 用于分类，如：system、payment、email |
| data | JSONB | 配置数据 | JSON格式，灵活存储各种配置 |
| remark | VARCHAR(500) | 备注 | 说明信息 |
| create_by | BIGINT | 创建者 | 用户ID |
| created_time | TIMESTAMP | 创建时间 | 自动生成 |
| update_by | BIGINT | 更新者 | 用户ID |
| updated_time | TIMESTAMP | 更新时间 | 自动更新 |
| deleted_at | TIMESTAMP | 删除时间 | 软删除标记 |

### 索引

- PRIMARY KEY: id
- INDEX: type（提升类型查询性能）
- INDEX: name（提升名称查询性能）
- INDEX: deleted_at（软删除查询）

### 与字典表的区别

| 特性 | s_config（配置表） | s_dict_data（字典表） |
|------|-------------------|---------------------|
| 数据格式 | JSONB（灵活的JSON） | 固定字段（label/value） |
| 层级结构 | 不支持 | 支持树形结构（parent_id） |
| 使用场景 | 复杂配置、系统参数 | 下拉框选项、简单键值对 |
| 数据复杂度 | 高（可嵌套对象/数组） | 低（简单键值对） |

## 数据库迁移

### 执行迁移脚本

```bash
# PostgreSQL
psql -U your_username -d your_database -f scripts/sql/migration_add_config_table.sql
```

迁移脚本会：
1. 创建 s_config 表
2. 创建索引（type, name, deleted_at）
3. 添加表和字段注释
4. 验证表是否创建成功

## API接口

### 1. 创建配置

**接口**: `POST /api/v1/config`

**请求体**:
```json
{
  "name": "payment_config",
  "type": "payment",
  "data": {
    "provider": "stripe",
    "apiKey": "sk_test_xxxxx",
    "webhookSecret": "whsec_xxxxx",
    "currency": "USD",
    "features": {
      "refund": true,
      "subscription": true
    }
  },
  "remark": "支付配置",
  "createBy": 1,
  "updateBy": 1
}
```

**响应**:
```json
{
  "code": 200,
  "msg": "创建配置成功",
  "data": null
}
```

### 2. 更新配置

**接口**: `PUT /api/v1/config`

**请求体**:
```json
{
  "id": 1,
  "name": "payment_config",
  "type": "payment",
  "data": {
    "provider": "stripe",
    "apiKey": "sk_live_xxxxx",
    "webhookSecret": "whsec_xxxxx",
    "currency": "USD",
    "features": {
      "refund": true,
      "subscription": true,
      "invoice": true
    }
  },
  "remark": "支付配置（已更新为生产环境）",
  "updateBy": 1
}
```

### 3. 删除配置

**接口**: `DELETE /api/v1/config/{id}`

**示例**: `DELETE /api/v1/config/1`

### 4. 批量删除配置

**接口**: `DELETE /api/v1/config/batch`

**请求体**:
```json
{
  "ids": [1, 2, 3]
}
```

### 5. 查询配置详情

**接口**: `GET /api/v1/config/{id}`

**示例**: `GET /api/v1/config/1`

**响应**:
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "id": 1,
    "name": "payment_config",
    "type": "payment",
    "data": {
      "provider": "stripe",
      "apiKey": "sk_test_xxxxx",
      "webhookSecret": "whsec_xxxxx",
      "currency": "USD",
      "features": {
        "refund": true,
        "subscription": true
      }
    },
    "remark": "支付配置",
    "createBy": 1,
    "createdTime": "2024-01-01 12:00:00",
    "updateBy": 1,
    "updatedTime": "2024-01-01 12:00:00"
  }
}
```

### 6. 分页查询配置列表

**接口**: `GET /api/v1/config/list`

**查询参数**:
- pageNum: 页码（必填）
- pageSize: 每页数量（必填）
- type: 配置类型（可选）
- name: 配置名称，支持模糊查询（可选）

**示例**: `GET /api/v1/config/list?pageNum=1&pageSize=10&type=payment`

**响应**:
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "payment_config",
        "type": "payment",
        "data": {
          "provider": "stripe",
          "apiKey": "sk_test_xxxxx"
        },
        "remark": "支付配置",
        "createBy": 1,
        "createdTime": "2024-01-01 12:00:00"
      }
    ],
    "total": 1
  }
}
```

### 7. 根据类型获取配置列表

**接口**: `GET /api/v1/config/type`

**查询参数**:
- type: 配置类型（必填）

**示例**: `GET /api/v1/config/type?type=payment`

**响应**:
```json
{
  "code": 200,
  "msg": "success",
  "data": [
    {
      "id": 1,
      "name": "payment_config",
      "type": "payment",
      "data": {
        "provider": "stripe",
        "apiKey": "sk_test_xxxxx"
      },
      "remark": "支付配置"
    }
  ]
}
```

### 8. 根据类型获取配置数据（常用）

**接口**: `GET /api/v1/config/data`

**查询参数**:
- type: 配置类型（必填）

**示例**: `GET /api/v1/config/data?type=payment`

**响应**:
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "type": "payment",
    "data": {
      "provider": "stripe",
      "apiKey": "sk_test_xxxxx",
      "webhookSecret": "whsec_xxxxx",
      "currency": "USD",
      "features": {
        "refund": true,
        "subscription": true
      }
    }
  }
}
```

**使用场景**: 前端或后端服务直接获取配置数据，无需关心其他字段

## 使用场景示例

### 场景1：系统配置

**配置数据**:
```json
{
  "name": "system_config",
  "type": "system",
  "data": {
    "siteName": "我的网站",
    "logo": "https://example.com/logo.png",
    "copyright": "© 2024 My Company",
    "maintenance": false,
    "features": {
      "registration": true,
      "socialLogin": true,
      "emailVerification": true
    },
    "limits": {
      "maxUploadSize": 10485760,
      "maxFileCount": 10
    }
  }
}
```

**前端调用**:
```javascript
// 获取系统配置
GET /api/v1/config/data?type=system

// 使用配置
const config = response.data.data;
document.title = config.siteName;
```

### 场景2：支付配置

**配置数据**:
```json
{
  "name": "stripe_config",
  "type": "payment",
  "data": {
    "provider": "stripe",
    "mode": "test",
    "testKeys": {
      "publishableKey": "pk_test_xxxxx",
      "secretKey": "sk_test_xxxxx"
    },
    "liveKeys": {
      "publishableKey": "pk_live_xxxxx",
      "secretKey": "sk_live_xxxxx"
    },
    "webhookSecret": "whsec_xxxxx",
    "currency": "USD",
    "supportedMethods": ["card", "alipay", "wechat"]
  }
}
```

**后端调用**:
```go
// 获取支付配置
data, err := configService.GetDataByType(ctx, "payment")
if err != nil {
    return err
}

// 使用配置
mode := data["mode"].(string)
var apiKey string
if mode == "test" {
    apiKey = data["testKeys"].(map[string]interface{})["secretKey"].(string)
} else {
    apiKey = data["liveKeys"].(map[string]interface{})["secretKey"].(string)
}
```

### 场景3：邮件配置

**配置数据**:
```json
{
  "name": "email_config",
  "type": "email",
  "data": {
    "provider": "smtp",
    "host": "smtp.gmail.com",
    "port": 587,
    "username": "noreply@example.com",
    "password": "app_password_xxxxx",
    "from": {
      "name": "My Website",
      "email": "noreply@example.com"
    },
    "templates": {
      "welcome": "template_id_1",
      "resetPassword": "template_id_2",
      "orderConfirm": "template_id_3"
    }
  }
}
```

### 场景4：功能开关

**配置数据**:
```json
{
  "name": "feature_flags",
  "type": "feature",
  "data": {
    "newDashboard": {
      "enabled": true,
      "rolloutPercentage": 50,
      "allowedUsers": [1, 2, 3]
    },
    "aiAssistant": {
      "enabled": false,
      "betaUsers": [1]
    },
    "darkMode": {
      "enabled": true,
      "default": false
    }
  }
}
```

### 场景5：第三方服务配置

**配置数据**:
```json
{
  "name": "aws_config",
  "type": "cloud",
  "data": {
    "region": "us-east-1",
    "credentials": {
      "accessKeyId": "AKIAXXXXX",
      "secretAccessKey": "xxxxx"
    },
    "s3": {
      "bucket": "my-bucket",
      "publicUrl": "https://cdn.example.com"
    },
    "ses": {
      "fromEmail": "noreply@example.com",
      "replyToEmail": "support@example.com"
    }
  }
}
```

## 充血模型设计

### Model层（internal/domain/model/s_config.go）

提供基础能力：
- **JSON数据类型**: 使用标准库的 `json.RawMessage` 类型，支持JSON数据的存储和读取
- **查询方法**: FindByID, FindByType, FindByName
- **校验方法**: CheckNameExists, CheckNameExistsExcludingSelf
- **CRUD方法**: Create, Update, Delete, BatchDelete, List
- **工具方法**: GetDataByType

### Service层（internal/service/config.go）

业务编排：
- 调用Model层方法组合业务流程
- 配置名称唯一性校验
- 业务规则判断
- 事务管理

### Controller层（internal/controller/config.go）

HTTP接口处理：
- 请求参数绑定和验证
- 调用Service层方法
- 统一响应格式
- 完善的Swagger注释

## 性能优化

1. **索引优化**: type 和 name 字段建立索引
2. **JSONB优化**: PostgreSQL的JSONB类型支持高效的JSON查询和索引
3. **查询优化**: 一次查询多次使用，避免重复数据库访问
4. **软删除**: 使用 deleted_at 字段，支持数据恢复

## 注意事项

1. **配置名称唯一性**: name 字段必须唯一
2. **JSON格式**: data 字段必须是有效的JSON格式
3. **敏感信息**: 生产环境中的敏感配置（如API密钥）应加密存储
4. **配置缓存**: 建议在应用层添加缓存，减少数据库查询
5. **配置版本**: 可以通过 updated_time 字段追踪配置变更历史

## 安全建议

1. **权限控制**: 配置管理接口应严格限制访问权限
2. **敏感数据**: 敏感配置应加密存储，不要明文保存
3. **审计日志**: 记录配置的创建、修改、删除操作
4. **环境隔离**: 开发、测试、生产环境的配置应分离
5. **配置备份**: 定期备份重要配置数据

## 测试建议

1. 创建各种类型的配置（系统、支付、邮件等）
2. 测试JSON数据的存储和读取
3. 测试配置名称唯一性约束
4. 测试分页查询和筛选功能
5. 测试根据类型获取配置数据接口
6. 测试复杂JSON结构的存储（嵌套对象、数组等）

## 扩展建议

1. **配置版本管理**: 添加版本字段，支持配置回滚
2. **配置继承**: 支持配置的继承和覆盖
3. **配置加密**: 对敏感配置字段进行加密
4. **配置缓存**: 集成Redis缓存，提升读取性能
5. **配置变更通知**: 配置更新时通知相关服务
6. **配置校验**: 添加JSON Schema校验，确保配置格式正确
