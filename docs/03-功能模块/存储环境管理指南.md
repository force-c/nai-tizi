# 存储环境管理指南

## 1. 概述

存储环境管理提供了灵活的多存储配置能力，支持 S3、本地存储、阿里云 OSS 等多种存储类型。

## 2. 默认环境规则

### 2.1 核心约束

**系统必须保证有且仅有一个默认环境**

- ✅ **有且仅有一个**：任何时候都必须有一个默认环境，且只能有一个
- ✅ **自动使用**：上传附件时如果未指定环境，自动使用默认环境
- ✅ **自动切换**：设置新的默认环境时，自动取消原默认环境
- ✅ **删除保护**：不允许删除默认环境，必须先设置其他环境为默认

### 2.2 为什么需要默认环境？

```go
// ❌ 没有默认环境的问题
attachmentService.Upload(ctx, &UploadRequest{
    File:         file,
    EnvCode:      "",  // 未指定环境
    BusinessType: "user",
    BusinessId:   "123",
})
// 结果：报错 "未指定存储环境"

// ✅ 有默认环境的好处
attachmentService.Upload(ctx, &UploadRequest{
    File:         file,
    EnvCode:      "",  // 未指定环境
    BusinessType: "user",
    BusinessId:   "123",
})
// 结果：自动使用默认环境，上传成功
```

## 3. 环境管理操作

### 3.1 创建环境

```go
// 创建第一个环境（自动设为默认）
env1 := &StorageEnv{
    EnvName:     "默认存储",
    EnvCode:     "default",
    StorageType: "s3",
    IsDefault:   false,  // 会被自动设为 true（因为是第一个）
    Config: map[string]interface{}{
        "endpoint":  "http://localhost:9000",
        "accessKey": "minioadmin",
        "secretKey": "minioadmin",
        "bucket":    "default-bucket",
    },
}
storageEnvService.Create(ctx, env1)

// 创建第二个环境（不是默认）
env2 := &StorageEnv{
    EnvName:     "用户头像",
    EnvCode:     "user_avatar",
    StorageType: "s3",
    IsDefault:   false,  // 保持为 false
    Config: map[string]interface{}{
        "endpoint":  "http://localhost:9000",
        "accessKey": "minioadmin",
        "secretKey": "minioadmin",
        "bucket":    "avatars",
    },
}
storageEnvService.Create(ctx, env2)

// 创建第三个环境并设为默认（会自动取消 env1 的默认状态）
env3 := &StorageEnv{
    EnvName:     "商品图片",
    EnvCode:     "product_image",
    StorageType: "local",
    IsDefault:   true,  // 设为默认，env1 会自动变为非默认
    Config: map[string]interface{}{
        "basePath":  "/data/products",
        "urlPrefix": "http://localhost:8080/files/products",
    },
}
storageEnvService.Create(ctx, env3)
```

### 3.2 设置默认环境

```go
// 方式 1：创建时设置
env := &StorageEnv{
    EnvName:   "新默认环境",
    EnvCode:   "new_default",
    IsDefault: true,  // 创建时设为默认
    // ...
}
storageEnvService.Create(ctx, env)

// 方式 2：单独设置
storageEnvService.SetDefault(ctx, envId)

// 结果：
// - 原默认环境的 is_default 变为 false
// - 新环境的 is_default 变为 true
```

### 3.3 删除环境

```go
// ❌ 尝试删除默认环境
err := storageEnvService.Delete(ctx, defaultEnvId)
// 结果：报错 "不能删除默认环境，请先设置其他环境为默认"

// ✅ 正确的删除流程
// 1. 先设置其他环境为默认
storageEnvService.SetDefault(ctx, otherEnvId)

// 2. 再删除原默认环境
err := storageEnvService.Delete(ctx, oldDefaultEnvId)
// 结果：删除成功

// ❌ 尝试删除有附件的环境
err := storageEnvService.Delete(ctx, envId)
// 结果：报错 "该环境下还有 100 个附件，无法删除"
```

### 3.4 查询默认环境

```go
// 获取默认环境
defaultEnv, err := storageEnvService.GetDefault(ctx)
if err != nil {
    // 错误：未配置默认存储环境
}

// 使用默认环境上传
storage, _ := storageManager.GetStorage(defaultEnv.EnvId)
storage.Upload(ctx, key, reader, size)
```

## 4. 上传附件时的环境选择

### 4.1 指定环境上传

```go
// 明确指定使用某个环境
attachmentService.Upload(ctx, &UploadRequest{
    File:         file,
    EnvCode:      "user_avatar",  // 使用用户头像环境
    BusinessType: "user",
    BusinessId:   "123",
})
```

### 4.2 使用默认环境上传

```go
// 不指定环境，自动使用默认环境
attachmentService.Upload(ctx, &UploadRequest{
    File:         file,
    EnvCode:      "",  // 空字符串或不传
    BusinessType: "user",
    BusinessId:   "123",
})

// Service 层会自动处理
func (s *attachmentService) Upload(ctx context.Context, req *UploadRequest) (*Attachment, error) {
    var env *StorageEnv
    var err error
    
    if req.EnvCode != "" {
        // 使用指定环境
        env, err = s.getEnvByCode(req.EnvCode)
    } else {
        // 使用默认环境
        env, err = s.storageEnvService.GetDefault(ctx)
    }
    
    // ...
}
```

## 5. 最佳实践

### 5.1 初始化配置

```sql
-- 系统初始化时创建默认环境
INSERT INTO s_storage_env (env_name, env_code, storage_type, is_default, config, status)
VALUES (
    '默认存储',
    'default',
    's3',
    true,  -- 设为默认
    '{"endpoint":"http://localhost:9000","accessKey":"minioadmin","secretKey":"minioadmin","bucket":"default"}',
    '0'
);
```

### 5.2 环境规划建议

```go
// 推荐的环境配置方案

// 1. 默认环境（通用文件）
env_code: "default"
storage_type: "s3"
bucket: "default-bucket"
is_default: true

// 2. 用户相关（头像、个人文件）
env_code: "user_files"
storage_type: "s3"
bucket: "user-files"
is_default: false

// 3. 商品图片（高频访问）
env_code: "product_images"
storage_type: "local"  // 使用本地存储，提高访问速度
basePath: "/data/products"
is_default: false

// 4. 临时文件（定期清理）
env_code: "temp_files"
storage_type: "local"
basePath: "/data/temp"
is_default: false

// 5. 归档文件（低频访问）
env_code: "archive"
storage_type: "s3"
bucket: "archive-bucket"
is_default: false
```

### 5.3 代码中的使用建议

```go
// ✅ 推荐：明确指定环境（业务清晰）
attachmentService.Upload(ctx, &UploadRequest{
    File:    file,
    EnvCode: "user_avatar",  // 明确指定
    // ...
})

// ✅ 可接受：使用默认环境（通用场景）
attachmentService.Upload(ctx, &UploadRequest{
    File:    file,
    EnvCode: "",  // 使用默认
    // ...
})

// ❌ 不推荐：硬编码环境 ID
storage := storageManager.GetStorage(1)  // 不要这样做
```

## 6. 常见问题

### Q1: 如何切换默认环境？

```go
// 直接调用 SetDefault 即可，会自动处理原默认环境
storageEnvService.SetDefault(ctx, newEnvId)
```

### Q2: 删除环境时提示有附件怎么办？

```go
// 方案 1：迁移附件到其他环境
attachmentService.MigrateEnv(ctx, oldEnvId, newEnvId)

// 方案 2：删除所有附件（谨慎操作）
attachmentService.DeleteByEnv(ctx, oldEnvId)

// 方案 3：只删除数据库记录，保留文件
// 手动清理数据库中的附件记录
```

### Q3: 如何确保系统始终有默认环境？

系统通过以下机制保证：

1. **创建第一个环境时自动设为默认**
2. **删除默认环境前必须先设置其他环境为默认**
3. **数据库约束确保 is_default 的唯一性**
4. **Service 层事务保证操作的原子性**

### Q4: 可以有多个默认环境吗？

**不可以！** 系统严格保证有且仅有一个默认环境。

```go
// ❌ 这样做会失败
env1.IsDefault = true
env2.IsDefault = true
// 结果：只有最后一个会是默认环境

// ✅ 正确做法
storageEnvService.SetDefault(ctx, env1.EnvId)  // env1 是默认
storageEnvService.SetDefault(ctx, env2.EnvId)  // env2 是默认，env1 自动变为非默认
```

### Q5: 未配置默认环境会怎样？

```go
// 如果数据库中没有默认环境
env, err := storageEnvService.GetDefault(ctx)
// 结果：err = "未配置默认存储环境"

// 上传时会报错
attachment, err := attachmentService.Upload(ctx, &UploadRequest{
    File:    file,
    EnvCode: "",  // 未指定环境
})
// 结果：err = "获取存储环境失败: 未配置默认存储环境"
```

## 7. API 接口示例

### 7.1 创建存储环境

```http
POST /api/v1/storage-envs
Content-Type: application/json

{
    "envName": "用户头像",
    "envCode": "user_avatar",
    "storageType": "s3",
    "isDefault": false,
    "config": {
        "endpoint": "http://localhost:9000",
        "accessKey": "minioadmin",
        "secretKey": "minioadmin",
        "bucket": "avatars"
    },
    "maxFileSize": 5242880,
    "allowedExtensions": "jpg,jpeg,png,gif"
}
```

### 7.2 设置默认环境

```http
PUT /api/v1/storage-envs/{envId}/set-default
```

### 7.3 获取默认环境

```http
GET /api/v1/storage-envs/default
```

### 7.4 删除环境

```http
DELETE /api/v1/storage-envs/{envId}
```

## 8. 总结

默认环境机制的核心价值：

1. **容错性**：避免未指定环境时报错
2. **易用性**：简化常见场景的使用
3. **灵活性**：支持动态切换默认环境
4. **安全性**：保护默认环境不被误删

**记住：系统必须保证有且仅有一个默认环境！**

---

**最后更新：** 2024-12-20  
**版本：** v1.0.0
