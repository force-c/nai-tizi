# 日志配置使用指南

## 概述

本项目使用 Zap 日志库，支持灵活的日志配置，包括：
- 多种输出模式：仅控制台、仅文件、同时输出
- 日志文件自动轮转（按大小和时间）
- 可配置的日志级别和格式
- 彩色控制台输出（开发环境）
- JSON格式输出（生产环境）

## 配置文件

### 开发环境配置
文件：`cmd/api/zaplogger.dev.yaml`

```yaml
level: debug          # 日志级别
output: both          # 同时输出到控制台和文件
encoding: console     # 控制台易读格式
file:
  path: ./logs
  filename: app
  maxSize: 100       # 单文件最大100MB
  maxBackups: 30     # 最多保留30个旧文件
  maxAge: 7          # 保留7天
  compress: true     # 压缩旧日志
console:
  colorful: true     # 启用彩色输出
caller: true         # 显示调用者信息
stacktrace: true     # 显示堆栈跟踪
```

### 生产环境配置
文件：`cmd/api/zaplogger.prod.yaml`

```yaml
level: info           # 生产环境使用info级别
output: file          # 仅输出到文件
encoding: json        # JSON格式便于日志分析
file:
  path: /var/log/NTZ
  filename: app
  maxSize: 200
  maxBackups: 100
  maxAge: 30
  compress: true
```

## 日志文件命名规则

日志文件会自动添加时间戳，格式为：
```
{filename}-{YYYY-MM-DD}.log
```

示例：
```
logs/app-2025-12-09.log
logs/app-2025-12-09.1.log  # 当第一个文件达到maxSize时创建
logs/app-2025-12-09.2.log.gz  # 旧文件被压缩
```

## 日志轮转策略

### 按大小轮转
当日志文件达到 `maxSize` 指定的大小（MB）时，会自动创建新文件。

### 按时间清理
- 保留天数：由 `maxAge` 配置
- 保留文件数：由 `maxBackups` 配置
- 超过限制的旧文件会被自动删除

### 压缩策略
如果 `compress: true`，旧的日志文件会被压缩为 `.gz` 格式以节省磁盘空间。

## 使用方法

### 基础用法

```go
logger := c.GetLogger()

// 不同级别的日志
logger.Debug("这是调试日志")
logger.Info("这是信息日志")
logger.Warn("这是警告日志")
logger.Error("这是错误日志")

// 带字段的结构化日志
logger.Info("用户登录",
    zap.String("username", "john"),
    zap.Int64("userId", 12345),
    zap.Duration("latency", time.Millisecond*100))

// 带错误的日志
if err != nil {
    logger.Error("操作失败", zap.Error(err))
}
```

### 创建子Logger

```go
// 创建带有固定字段的子logger
userLogger := logger.With(
    zap.String("module", "user"),
    zap.String("service", "auth"))

// 之后的所有日志都会包含这些字段
userLogger.Info("登录成功")  // 会自动包含 module=user, service=auth
```

## 输出模式说明

### console（仅控制台）
适用场景：本地开发、调试
- 日志仅输出到终端
- 不会创建日志文件
- 彩色输出便于阅读

### file（仅文件）
适用场景：生产环境
- 日志仅写入文件
- 不会输出到控制台
- 支持日志轮转和清理

### both（同时输出）
适用场景：开发/测试环境
- 同时输出到控制台和文件
- 便于实时查看和事后分析

## 日志级别说明

从低到高：
- **debug**: 详细的调试信息
- **info**: 一般信息（默认）
- **warn**: 警告信息
- **error**: 错误信息
- **fatal**: 致命错误（会终止程序）

## 环境切换

通过设置 `ADCS_APP_ENV` 环境变量切换配置：

```bash
# 开发环境（默认）
export ADCS_APP_ENV=dev

# 生产环境
export ADCS_APP_ENV=prod
```

对应的配置文件：
- `dev` → `zaplogger.dev.yaml`
- `prod` → `zaplogger.prod.yaml`

## 日志文件位置

### 开发环境
```
项目根目录/logs/
├── app-2025-12-09.log
├── app-2025-12-08.log.gz
└── app-2025-12-07.log.gz
```

### 生产环境
```
/var/log/NTZ/
├── app-2025-12-09.log
├── app-2025-12-08.log.gz
└── ...
```

## 最佳实践

1. **开发环境**：使用 `output: both` 和 `encoding: console`，启用彩色输出
2. **生产环境**：使用 `output: file` 和 `encoding: json`，便于日志收集
3. **日志级别**：开发环境使用 `debug`，生产环境使用 `info` 或 `warn`
4. **结构化日志**：尽量使用 `zap.Field` 而不是字符串拼接
5. **日志轮转**：根据业务量调整 `maxSize` 和 `maxAge`

## 示例日志输出

### 控制台格式（开发环境）
```
2025-12-09 11:30:45.123	INFO	用户登录成功	{"username": "john", "userId": 12345}
2025-12-09 11:30:46.456	ERROR	数据库连接失败	{"error": "connection timeout"}
```

### JSON格式（生产环境）
```json
{"level":"info","time":"2025-12-09 11:30:45.123","caller":"controller/user.go:45","msg":"用户登录成功","username":"john","userId":12345}
{"level":"error","time":"2025-12-09 11:30:46.456","caller":"database/db.go:78","msg":"数据库连接失败","error":"connection timeout"}
```

## 故障排查

### 日志文件未创建
1. 检查 `file.path` 目录是否有写权限
2. 查看控制台是否有错误输出
3. 确认 `output` 配置包含 `file` 或 `both`

### 日志文件过大
调整配置：
- 减小 `maxSize`
- 减少 `maxAge` 或 `maxBackups`
- 启用 `compress: true`

### 找不到旧日志
- 检查 `maxAge` 和 `maxBackups` 设置
- 确认日志清理策略是否过于激进
