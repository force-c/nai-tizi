# 部署说明

## 配置文件部署

### 统一的配置文件管理

程序启动时会自动获取可执行文件所在目录，并在该目录下查找所有配置文件。

**重要**：所有配置文件必须与编译后的可执行文件放在同一目录。

#### 开发环境
在项目根目录运行时，配置文件位于：
```
cmd/api/
├── casbin_model.conf        # Casbin 权限模型配置
├── conf.dev.yaml             # 开发环境配置
└── conf.prod.yaml            # 生产环境配置
```

#### 生产环境
编译后部署时，需要将所有配置文件复制到可执行文件同目录：

```bash
# 部署目录结构
/opt/myapp/
├── myapp                    # 可执行文件
├── casbin_model.conf        # Casbin 配置（从 cmd/api/ 复制）
├── conf.prod.yaml           # 应用配置（从 cmd/api/ 复制）
└── logs/                    # 日志目录
```

#### 部署脚本示例

```bash
#!/bin/bash

# 设置变量
APP_NAME="myapp"
BUILD_DIR="./build"
DEPLOY_DIR="/opt/myapp"

# 编译
echo "Building application..."
go build -o ${BUILD_DIR}/${APP_NAME} ./cmd/api

# 复制所有配置文件
echo "Copying configuration files..."
cp cmd/api/casbin_model.conf ${BUILD_DIR}/
cp cmd/api/conf.prod.yaml ${BUILD_DIR}/

# 部署
echo "Deploying to ${DEPLOY_DIR}..."
mkdir -p ${DEPLOY_DIR}
cp ${BUILD_DIR}/* ${DEPLOY_DIR}/

# 设置权限
chmod +x ${DEPLOY_DIR}/${APP_NAME}

echo "Deployment completed!"
```

### 环境配置切换

应用配置文件（`conf.*.yaml`）通过环境变量 `ADCS_APP_ENV` 指定：

```bash
# 开发环境（默认）
export ADCS_APP_ENV=dev
./myapp  # 加载 conf.dev.yaml

# 生产环境
export ADCS_APP_ENV=prod
./myapp  # 加载 conf.prod.yaml
```

## 工作原理

程序启动时会：
1. 获取可执行文件所在目录（通过 `os.Executable()`）
2. 查找配置文件，按以下优先级：
   - **优先**：当前工作目录（支持 IDE 调试）
   - **其次**：可执行文件所在目录（生产环境）
3. 使用找到的配置初始化系统

### 配置文件查找逻辑

对于 `conf.{env}.yaml` 和 `casbin_model.conf`，程序会按顺序尝试：

1. **当前工作目录**：`$(pwd)/conf.dev.yaml`
2. **可执行文件目录**：`/path/to/executable/conf.dev.yaml`

这样设计的好处：
- ✅ 支持 IDE 调试（GoLand、VSCode 等）
- ✅ 支持任意目录运行
- ✅ 便于容器化部署
- ✅ 避免路径依赖问题
- ✅ 统一的配置管理方式

## IDE 调试配置

### GoLand / IntelliJ IDEA

在 Run/Debug Configuration 中设置：

```
Working directory: /path/to/project/cmd/api
```

或者在项目根目录：

```
Working directory: /path/to/project
```

只要配置文件在工作目录下，程序就能正确加载。

### VSCode

在 `.vscode/launch.json` 中配置：

```json
{
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Launch API",
            "type": "go",
            "request": "launch",
            "mode": "auto",
            "program": "${workspaceFolder}/cmd/api",
            "cwd": "${workspaceFolder}/cmd/api",
            "env": {
                "ADCS_APP_ENV": "dev"
            }
        }
    ]
}
```

## Docker 部署示例

```dockerfile
FROM golang:1.21-alpine AS builder

WORKDIR /app
COPY . .
RUN go build -o myapp ./cmd/api

FROM alpine:latest

WORKDIR /app

# 复制可执行文件和所有配置
COPY --from=builder /app/myapp .
COPY cmd/api/casbin_model.conf .
COPY cmd/api/conf.prod.yaml .

# 设置环境变量
ENV ADCS_APP_ENV=prod

EXPOSE 9009

CMD ["./myapp"]
```

## 验证部署

启动应用后，查看日志确认配置加载成功：

```
INFO    loading config from /opt/myapp/conf.prod.yaml
INFO    loading casbin model    {"path": "/opt/myapp/casbin_model.conf"}
INFO    casbin enforcer initialized successfully
INFO    container initialized successfully
```

## 常见问题

### 1. 配置文件找不到

**错误信息**：
```
failed to read config from /opt/myapp/conf.prod.yaml: open /opt/myapp/conf.prod.yaml: no such file or directory
```

**解决方法**：
- 确保配置文件与可执行文件在同一目录
- 检查环境变量 `ADCS_APP_ENV` 是否正确设置
- 确认配置文件名格式为 `conf.{env}.yaml`

### 2. Casbin 配置文件找不到

**错误信息**：
```
failed to create casbin enforcer: open /opt/myapp/casbin_model.conf: no such file or directory
```

**解决方法**：
- 确保 `casbin_model.conf` 与可执行文件在同一目录
- 从 `cmd/api/casbin_model.conf` 复制该文件到部署目录

### 3. 开发环境配置文件路径问题

**问题**：在项目根目录或 IDE 中运行时找不到配置文件

**解决方法**：
程序会自动在以下位置查找配置文件：
1. 当前工作目录
2. 可执行文件所在目录

**推荐的开发方式**：

方式一：在 `cmd/api` 目录下运行
```bash
cd cmd/api
go run main.go
```

方式二：在项目根目录运行，将配置文件放在根目录
```bash
# 复制配置文件到根目录（可选）
cp cmd/api/conf.dev.yaml .
cp cmd/api/casbin_model.conf .

# 运行
go run ./cmd/api
```

方式三：使用 IDE，设置 Working Directory 为 `cmd/api`
