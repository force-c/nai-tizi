# å‰ç«¯éƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å‰ç«¯é¡¹ç›®çš„éƒ¨ç½²æ–¹æ¡ˆå’Œæ­¥éª¤ã€‚

---

## ğŸ“‹ éƒ¨ç½²æ–¹å¼

### æ–¹å¼ä¸€ï¼šNginx éƒ¨ç½²ï¼ˆæ¨èï¼‰

é€‚ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œæ€§èƒ½æœ€ä¼˜ã€‚

### æ–¹å¼äºŒï¼šDocker éƒ¨ç½²

é€‚ç”¨äºå®¹å™¨åŒ–éƒ¨ç½²ï¼Œæ˜“äºç®¡ç†ã€‚

### æ–¹å¼ä¸‰ï¼šDocker Compose éƒ¨ç½²

é€‚ç”¨äºå‰åç«¯ä¸€èµ·éƒ¨ç½²ï¼Œæœ€ç®€å•ã€‚

---

## ğŸš€ æ–¹å¼ä¸€ï¼šNginx éƒ¨ç½²

### æ­¥éª¤ 1: æ„å»ºé¡¹ç›®

```bash
cd web

# å®‰è£…ä¾èµ–
pnpm install

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
pnpm build
```

æ„å»ºå®Œæˆåï¼Œä¼šåœ¨ `dist/` ç›®å½•ç”Ÿæˆé™æ€æ–‡ä»¶ã€‚

### æ­¥éª¤ 2: ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨

```bash
# ä½¿ç”¨ scp ä¸Šä¼ 
scp -r dist/* user@your-server:/var/www/nai-tizi/

# æˆ–ä½¿ç”¨ rsync
rsync -avz dist/ user@your-server:/var/www/nai-tizi/
```

### æ­¥éª¤ 3: é…ç½® Nginx

åˆ›å»º Nginx é…ç½®æ–‡ä»¶ `/etc/nginx/conf.d/nai-tizi.conf`ï¼š

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # å‰ç«¯é™æ€æ–‡ä»¶ç›®å½•
    root /var/www/nai-tizi;
    index index.html;
    
    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/nai-tizi-access.log;
    error_log /var/log/nginx/nai-tizi-error.log;
    
    # SPA è·¯ç”±é…ç½®ï¼ˆé‡è¦ï¼ï¼‰
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API ä»£ç†åˆ°åç«¯
    location /api/ {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket æ”¯æŒ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # Gzip å‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

### æ­¥éª¤ 4: å¯åŠ¨ Nginx

```bash
# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½é…ç½®
sudo systemctl reload nginx

# æˆ–é‡å¯ Nginx
sudo systemctl restart nginx
```

### æ­¥éª¤ 5: é…ç½® HTTPSï¼ˆå¯é€‰ï¼‰

ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦ï¼š

```bash
# å®‰è£… certbot
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

---

## ğŸ³ æ–¹å¼äºŒï¼šDocker éƒ¨ç½²

### æ­¥éª¤ 1: åˆ›å»º Dockerfile

åœ¨ `web/` ç›®å½•ä¸‹åˆ›å»º `Dockerfile`ï¼š

```dockerfile
# æ„å»ºé˜¶æ®µ
FROM node:18-alpine as builder

WORKDIR /app

# å¤åˆ¶ package æ–‡ä»¶
COPY package*.json ./
COPY pnpm-lock.yaml ./

# å®‰è£… pnpm
RUN npm install -g pnpm

# å®‰è£…ä¾èµ–
RUN pnpm install --frozen-lockfile

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»º
RUN pnpm build

# ç”Ÿäº§é˜¶æ®µ
FROM nginx:alpine

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶ Nginx é…ç½®
COPY nginx.conf /etc/nginx/conf.d/default.conf

# æš´éœ²ç«¯å£
EXPOSE 80

# å¯åŠ¨ Nginx
CMD ["nginx", "-g", "daemon off;"]
```

### æ­¥éª¤ 2: åˆ›å»º nginx.conf

åœ¨ `web/` ç›®å½•ä¸‹åˆ›å»º `nginx.conf`ï¼š

```nginx
server {
    listen 80;
    server_name localhost;
    
    root /usr/share/nginx/html;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    location /api/ {
        proxy_pass http://backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
}
```

### æ­¥éª¤ 3: åˆ›å»º .dockerignore

åœ¨ `web/` ç›®å½•ä¸‹åˆ›å»º `.dockerignore`ï¼š

```
node_modules
dist
.git
.env.local
.DS_Store
*.log
```

### æ­¥éª¤ 4: æ„å»ºå’Œè¿è¡Œ

```bash
cd web

# æ„å»ºé•œåƒ
docker build -t nai-tizi-web:latest .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name nai-tizi-web \
  -p 80:80 \
  --network nai-tizi-network \
  nai-tizi-web:latest

# æŸ¥çœ‹æ—¥å¿—
docker logs -f nai-tizi-web
```

---

## ğŸ™ æ–¹å¼ä¸‰ï¼šDocker Compose éƒ¨ç½²

### æ­¥éª¤ 1: åˆ›å»º docker-compose.yml

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `docker-compose.yml`ï¼š

```yaml
version: '3.8'

services:
  # PostgreSQL æ•°æ®åº“
  postgres:
    image: postgres:14-alpine
    container_name: nai-tizi-postgres
    environment:
      POSTGRES_DB: nai_tizi
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: your_password
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/sql:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - nai-tizi-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # åç«¯æœåŠ¡
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nai-tizi-backend
    ports:
      - "8080:8080"
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASSWORD: your_password
      DB_NAME: nai_tizi
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - nai-tizi-network
    restart: unless-stopped

  # å‰ç«¯æœåŠ¡
  frontend:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: nai-tizi-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - nai-tizi-network
    restart: unless-stopped

networks:
  nai-tizi-network:
    driver: bridge

volumes:
  postgres-data:
```

### æ­¥éª¤ 2: å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f frontend
```

### æ­¥éª¤ 3: åœæ­¢æœåŠ¡

```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# åœæ­¢å¹¶åˆ é™¤æ•°æ®å·
docker-compose down -v
```

---

## ğŸ”§ ç¯å¢ƒå˜é‡é…ç½®

### å¼€å‘ç¯å¢ƒ (.env.development)

```env
# åº”ç”¨æ ‡é¢˜
VITE_APP_TITLE=NAI-TIZI ç®¡ç†åå° (å¼€å‘)

# API åŸºç¡€åœ°å€
VITE_API_BASE_URL=http://localhost:8080

# å®¢æˆ·ç«¯è®¤è¯ä¿¡æ¯
VITE_CLIENT_KEY=web_admin
VITE_CLIENT_SECRET=web_admin_secret

# æ˜¯å¦å¼€å¯ Mock
VITE_USE_MOCK=false
```

### ç”Ÿäº§ç¯å¢ƒ (.env.production)

```env
# åº”ç”¨æ ‡é¢˜
VITE_APP_TITLE=NAI-TIZI ç®¡ç†åå°

# API åŸºç¡€åœ°å€ï¼ˆä¿®æ”¹ä¸ºå®é™…çš„ç”Ÿäº§ç¯å¢ƒåœ°å€ï¼‰
VITE_API_BASE_URL=https://api.your-domain.com

# å®¢æˆ·ç«¯è®¤è¯ä¿¡æ¯
VITE_CLIENT_KEY=web_admin
VITE_CLIENT_SECRET=web_admin_secret

# æ˜¯å¦å¼€å¯ Mock
VITE_USE_MOCK=false
```

---

## ğŸ”’ å®‰å…¨é…ç½®

### 1. HTTPS é…ç½®

ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPSï¼š

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # å…¶ä»–é…ç½®...
}

# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name your-domain.com;
    return 301 https://$server_name$request_uri;
}
```

### 2. å®‰å…¨å¤´é…ç½®

åœ¨ Nginx é…ç½®ä¸­æ·»åŠ å®‰å…¨å¤´ï¼š

```nginx
# å®‰å…¨å¤´
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "no-referrer-when-downgrade" always;
add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
```

### 3. é™æµé…ç½®

```nginx
# é™æµé…ç½®
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

location /api/ {
    limit_req zone=api_limit burst=20 nodelay;
    proxy_pass http://localhost:8080;
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ„å»ºä¼˜åŒ–

åœ¨ `vite.config.ts` ä¸­é…ç½®ï¼š

```typescript
export default defineConfig({
  build: {
    // ä»£ç åˆ†å‰²
    rollupOptions: {
      output: {
        manualChunks: {
          vue: ['vue', 'vue-router', 'pinia'],
          antd: ['ant-design-vue'],
          utils: ['axios', 'dayjs', 'lodash-es'],
        },
      },
    },
    // å‹ç¼©
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true,
      },
    },
    // å…³é—­ sourcemap
    sourcemap: false,
  },
});
```

### 2. CDN åŠ é€Ÿ

ä½¿ç”¨ CDN åŠ é€Ÿé™æ€èµ„æºï¼š

```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    
    # ä½¿ç”¨ CDN
    # add_header X-CDN "hit";
}
```

### 3. å¯ç”¨ Brotli å‹ç¼©

```nginx
# å®‰è£… nginx-module-brotli
# ç„¶åé…ç½®
brotli on;
brotli_comp_level 6;
brotli_types text/plain text/css application/json application/javascript text/xml application/xml;
```

---

## ğŸ” ç›‘æ§å’Œæ—¥å¿—

### 1. Nginx è®¿é—®æ—¥å¿—

```bash
# æŸ¥çœ‹è®¿é—®æ—¥å¿—
tail -f /var/log/nginx/nai-tizi-access.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/nai-tizi-error.log
```

### 2. Docker æ—¥å¿—

```bash
# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs -f nai-tizi-web

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥å¿—
docker logs --tail 100 nai-tizi-web
```

### 3. æ—¥å¿—åˆ†æ

ä½¿ç”¨ GoAccess åˆ†æ Nginx æ—¥å¿—ï¼š

```bash
# å®‰è£… GoAccess
sudo apt install goaccess

# åˆ†ææ—¥å¿—
goaccess /var/log/nginx/nai-tizi-access.log -o report.html --log-format=COMBINED
```

---

## ğŸ”„ æ›´æ–°éƒ¨ç½²

### æ–¹å¼ä¸€ï¼šæ‰‹åŠ¨æ›´æ–°

```bash
# 1. æœ¬åœ°æ„å»º
cd web
pnpm build

# 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp -r dist/* user@server:/var/www/nai-tizi/

# 3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
# ç”¨æˆ·éœ€è¦å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ï¼ˆCtrl+F5ï¼‰
```

### æ–¹å¼äºŒï¼šè‡ªåŠ¨åŒ–éƒ¨ç½²

ä½¿ç”¨ GitHub Actions æˆ– GitLab CI/CDï¼š

```yaml
# .github/workflows/deploy.yml
name: Deploy Frontend

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install pnpm
        run: npm install -g pnpm
      
      - name: Install dependencies
        run: cd web && pnpm install
      
      - name: Build
        run: cd web && pnpm build
      
      - name: Deploy to server
        uses: easingthemes/ssh-deploy@v2
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          SOURCE: "web/dist/"
          TARGET: "/var/www/nai-tizi/"
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: é¡µé¢åˆ·æ–°å 404

**åŸå› ï¼š** Nginx æ²¡æœ‰é…ç½® SPA è·¯ç”±è§„åˆ™

**è§£å†³ï¼š**

```nginx
location / {
    try_files $uri $uri/ /index.html;
}
```

### é—®é¢˜ 2: API è¯·æ±‚å¤±è´¥

**åŸå› ï¼š** API ä»£ç†é…ç½®é”™è¯¯æˆ–åç«¯æœåŠ¡æœªå¯åŠ¨

**è§£å†³ï¼š**

1. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å¯åŠ¨
2. æ£€æŸ¥ Nginx ä»£ç†é…ç½®
3. æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—

### é—®é¢˜ 3: é™æ€èµ„æº 404

**åŸå› ï¼š** é™æ€èµ„æºè·¯å¾„é…ç½®é”™è¯¯

**è§£å†³ï¼š**

1. æ£€æŸ¥ `vite.config.ts` ä¸­çš„ `base` é…ç½®
2. æ£€æŸ¥ Nginx çš„ `root` é…ç½®
3. ç¡®ä¿æ„å»ºäº§ç‰©æ­£ç¡®ä¸Šä¼ 

### é—®é¢˜ 4: ç™½å±

**åŸå› ï¼š** JavaScript åŠ è½½å¤±è´¥æˆ–æ‰§è¡Œé”™è¯¯

**è§£å†³ï¼š**

1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯
2. æ£€æŸ¥é™æ€èµ„æºæ˜¯å¦æ­£ç¡®åŠ è½½
3. æ£€æŸ¥ API åŸºç¡€åœ°å€é…ç½®

---

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

### 1. ä½¿ç”¨ Lighthouse

```bash
# å®‰è£… Lighthouse
npm install -g lighthouse

# è¿è¡Œæµ‹è¯•
lighthouse https://your-domain.com --output html --output-path ./report.html
```

### 2. ä½¿ç”¨ WebPageTest

è®¿é—® https://www.webpagetest.org/ è¿›è¡Œæ€§èƒ½æµ‹è¯•ã€‚

### 3. ç›‘æ§æŒ‡æ ‡

å…³æ³¨ä»¥ä¸‹æŒ‡æ ‡ï¼š

- **FCP (First Contentful Paint)** - é¦–æ¬¡å†…å®¹ç»˜åˆ¶
- **LCP (Largest Contentful Paint)** - æœ€å¤§å†…å®¹ç»˜åˆ¶
- **TTI (Time to Interactive)** - å¯äº¤äº’æ—¶é—´
- **CLS (Cumulative Layout Shift)** - ç´¯ç§¯å¸ƒå±€åç§»

---

## ğŸ” å¤‡ä»½å’Œæ¢å¤

### å¤‡ä»½

```bash
# å¤‡ä»½å‰ç«¯æ–‡ä»¶
tar -czf nai-tizi-web-$(date +%Y%m%d).tar.gz /var/www/nai-tizi/

# å¤‡ä»½åˆ°è¿œç¨‹æœåŠ¡å™¨
scp nai-tizi-web-*.tar.gz backup@backup-server:/backups/
```

### æ¢å¤

```bash
# è§£å‹å¤‡ä»½æ–‡ä»¶
tar -xzf nai-tizi-web-20241221.tar.gz -C /var/www/

# é‡å¯ Nginx
sudo systemctl reload nginx
```

---

## ğŸ“ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰

- [ ] ä»£ç å·²æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
- [ ] å·²åœ¨æœ¬åœ°æµ‹è¯•é€šè¿‡
- [ ] å·²æ›´æ–°ç‰ˆæœ¬å·
- [ ] å·²æ›´æ–° CHANGELOG
- [ ] å·²é…ç½®ç”Ÿäº§ç¯å¢ƒå˜é‡

### éƒ¨ç½²ä¸­

- [ ] æ„å»ºæˆåŠŸ
- [ ] æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
- [ ] Nginx é…ç½®æ­£ç¡®
- [ ] æœåŠ¡å¯åŠ¨æˆåŠŸ

### éƒ¨ç½²å

- [ ] è®¿é—®é¦–é¡µæ­£å¸¸
- [ ] ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] API è¯·æ±‚æ­£å¸¸
- [ ] é™æ€èµ„æºåŠ è½½æ­£å¸¸
- [ ] è·¯ç”±è·³è½¬æ­£å¸¸
- [ ] æƒé™æ§åˆ¶æ­£å¸¸

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²è¯´æ˜](./éƒ¨ç½²è¯´æ˜.md) - åç«¯éƒ¨ç½²æŒ‡å—
- [é…ç½®ç®¡ç†è¯´æ˜](./é…ç½®ç®¡ç†è¯´æ˜.md) - é…ç½®æ–‡ä»¶è¯´æ˜
- [å‰ç«¯å¿«é€Ÿå¼€å§‹](../07-å‰ç«¯å¼€å‘/å‰ç«¯å¿«é€Ÿå¼€å§‹.md) - å¼€å‘ç¯å¢ƒå¯åŠ¨

---

**åˆ›å»ºæ—¶é—´ï¼š** 2024-12-21  
**æœ€åæ›´æ–°ï¼š** 2024-12-21
