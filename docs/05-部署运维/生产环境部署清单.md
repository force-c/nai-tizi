# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ¸…å•

## æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ—å‡ºäº†å°†åº”ç”¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒæ‰€éœ€çš„æ‰€æœ‰å‡†å¤‡å·¥ä½œå’Œæ£€æŸ¥é¡¹ã€‚

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. ä¼˜é›…å…³é—­ âœ…

**åŠŸèƒ½ï¼š** æœåŠ¡æ”¶åˆ°ç»ˆæ­¢ä¿¡å·æ—¶èƒ½å¤Ÿå®‰å…¨é€€å‡º

**å®ç°ï¼š**
- ç›‘å¬ SIGINT/SIGTERM ä¿¡å·
- 30 ç§’è¶…æ—¶ä¿æŠ¤
- å®Œæ•´çš„èµ„æºæ¸…ç†
- è¯¦ç»†çš„æ—¥å¿—è®°å½•

**æµ‹è¯•æ–¹æ³•ï¼š**
```bash
# å¯åŠ¨æœåŠ¡
go run cmd/api/main.go

# æŒ‰ Ctrl+C è§¦å‘ä¼˜é›…å…³é—­
# è§‚å¯Ÿæ—¥å¿—è¾“å‡ºï¼š
# INFO  shutting down server...
# INFO  server exited gracefully
```

**ç”Ÿäº§ç¯å¢ƒéªŒè¯ï¼š**
- âœ… Docker å®¹å™¨åœæ­¢æ—¶æ­£å¸¸å…³é—­
- âœ… Kubernetes Pod åˆ é™¤æ—¶æ­£å¸¸å…³é—­
- âœ… æ»šåŠ¨æ›´æ–°æ—¶é›¶åœæœº

---

### 2. å¥åº·æ£€æŸ¥ âœ…

**åŠŸèƒ½ï¼š** æä¾›å¤šä¸ªå¥åº·æ£€æŸ¥ç«¯ç‚¹ï¼Œæ”¯æŒ Kubernetes æ¢é’ˆ

**ç«¯ç‚¹åˆ—è¡¨ï¼š**

| ç«¯ç‚¹ | ç”¨é€” | Kubernetes æ¢é’ˆ |
|------|------|----------------|
| `/health` | åŸºç¡€å¥åº·æ£€æŸ¥ | - |
| `/health/ready` | å°±ç»ªæ£€æŸ¥ | Readiness Probe |
| `/health/live` | å­˜æ´»æ£€æŸ¥ | Liveness Probe |
| `/health/startup` | å¯åŠ¨æ£€æŸ¥ | Startup Probe |

**æµ‹è¯•æ–¹æ³•ï¼š**
```bash
# ä½¿ç”¨æµ‹è¯•è„šæœ¬
./scripts/test_health.sh

# æˆ–æ‰‹åŠ¨æµ‹è¯•
curl http://localhost:8080/health
curl http://localhost:8080/health/ready
curl http://localhost:8080/health/live
curl http://localhost:8080/health/startup
```

**å“åº”ç¤ºä¾‹ï¼š**
```json
{
  "status": "healthy",
  "timestamp": "2024-12-28T21:30:00Z",
  "version": "1.0.0",
  "uptime": "2h 15m 30s",
  "services": {
    "database": "up",
    "redis": "up"
  }
}
```

---

## ğŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

### 1. ä»£ç å‡†å¤‡

- [x] ä»£ç ç¼–è¯‘é€šè¿‡
- [x] å•å…ƒæµ‹è¯•é€šè¿‡ï¼ˆå¦‚æœ‰ï¼‰
- [x] é›†æˆæµ‹è¯•é€šè¿‡ï¼ˆå¦‚æœ‰ï¼‰
- [x] ä»£ç å®¡æŸ¥å®Œæˆ
- [x] ç‰ˆæœ¬å·å·²æ›´æ–°

### 2. é…ç½®æ–‡ä»¶

- [ ] ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶å·²å‡†å¤‡ï¼ˆ`conf.prod.yaml`ï¼‰
- [ ] æ•°æ®åº“è¿æ¥ä¿¡æ¯å·²é…ç½®
- [ ] Redis è¿æ¥ä¿¡æ¯å·²é…ç½®
- [ ] JWT å¯†é’¥å·²æ›´æ–°ï¼ˆä¸ä½¿ç”¨é»˜è®¤å€¼ï¼‰
- [ ] æ—¥å¿—çº§åˆ«å·²è®¾ç½®ä¸º `info` æˆ– `warn`
- [ ] æ•æ„Ÿä¿¡æ¯å·²ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†

### 3. æ•°æ®åº“

- [ ] æ•°æ®åº“å·²åˆ›å»º
- [ ] å»ºè¡¨è„šæœ¬å·²æ‰§è¡Œï¼ˆ`scripts/sql/pgsql.sql`ï¼‰
- [ ] åˆå§‹æ•°æ®å·²å¯¼å…¥ï¼ˆ`scripts/sql/insert.sql`ï¼‰
- [ ] æ•°æ®åº“å¤‡ä»½ç­–ç•¥å·²é…ç½®
- [ ] æ•°æ®åº“è¿æ¥æ± å·²ä¼˜åŒ–

### 4. ä¾èµ–æœåŠ¡

- [ ] PostgreSQL å·²éƒ¨ç½²å¹¶å¯è®¿é—®
- [ ] Redis å·²éƒ¨ç½²å¹¶å¯è®¿é—®
- [ ] MinIO/S3 å·²éƒ¨ç½²å¹¶å¯è®¿é—®ï¼ˆå¦‚ä½¿ç”¨ï¼‰
- [ ] MQTT å·²éƒ¨ç½²å¹¶å¯è®¿é—®ï¼ˆå¦‚ä½¿ç”¨ï¼‰
- [ ] RabbitMQ å·²éƒ¨ç½²å¹¶å¯è®¿é—®ï¼ˆå¦‚ä½¿ç”¨ï¼‰

### 5. å®‰å…¨é…ç½®

- [ ] HTTPS å·²é…ç½®
- [ ] é˜²ç«å¢™è§„åˆ™å·²é…ç½®
- [ ] API é™æµå·²å¯ç”¨
- [ ] CORS ç­–ç•¥å·²é…ç½®
- [ ] æ•æ„Ÿæ¥å£å·²æ·»åŠ æƒé™æ§åˆ¶

### 6. ç›‘æ§å‘Šè­¦

- [ ] æ—¥å¿—æ”¶é›†å·²é…ç½®ï¼ˆELK/Lokiï¼‰
- [ ] ç›‘æ§æŒ‡æ ‡å·²é…ç½®ï¼ˆPrometheusï¼‰
- [ ] å‘Šè­¦è§„åˆ™å·²é…ç½®
- [ ] å¥åº·æ£€æŸ¥å·²é…ç½®
- [ ] é”™è¯¯è¿½è¸ªå·²é…ç½®ï¼ˆSentryï¼‰

### 7. å®¹å™¨åŒ–ï¼ˆå¦‚ä½¿ç”¨ Dockerï¼‰

- [ ] Dockerfile å·²å‡†å¤‡
- [ ] docker-compose.yml å·²å‡†å¤‡
- [ ] é•œåƒå·²æ„å»ºå¹¶æ¨é€åˆ°ä»“åº“
- [ ] å®¹å™¨èµ„æºé™åˆ¶å·²é…ç½®
- [ ] å®¹å™¨å¥åº·æ£€æŸ¥å·²é…ç½®

### 8. Kubernetesï¼ˆå¦‚ä½¿ç”¨ K8sï¼‰

- [ ] Deployment é…ç½®å·²å‡†å¤‡
- [ ] Service é…ç½®å·²å‡†å¤‡
- [ ] Ingress é…ç½®å·²å‡†å¤‡
- [ ] ConfigMap å·²å‡†å¤‡
- [ ] Secret å·²å‡†å¤‡
- [ ] æ¢é’ˆå·²é…ç½®ï¼ˆStartup/Readiness/Livenessï¼‰
- [ ] èµ„æºé™åˆ¶å·²é…ç½®ï¼ˆrequests/limitsï¼‰
- [ ] HPA å·²é…ç½®ï¼ˆå¦‚éœ€è¦ï¼‰

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ–¹å¼ä¸€ï¼šç›´æ¥éƒ¨ç½²

```bash
# 1. ç¼–è¯‘åº”ç”¨
GOOS=linux GOARCH=amd64 go build -o bin/api cmd/api/main.go

# 2. ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨
scp bin/api user@server:/app/
scp cmd/api/conf.prod.yaml user@server:/app/
scp cmd/api/*.yaml user@server:/app/

# 3. åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
ssh user@server
cd /app
./api
```

### æ–¹å¼äºŒï¼šDocker éƒ¨ç½²

```bash
# 1. æ„å»ºé•œåƒ
docker build -t nai-tizi:1.0.0 .

# 2. æ¨é€åˆ°ä»“åº“
docker tag nai-tizi:1.0.0 registry.example.com/nai-tizi:1.0.0
docker push registry.example.com/nai-tizi:1.0.0

# 3. åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
docker pull registry.example.com/nai-tizi:1.0.0
docker run -d \
  --name nai-tizi \
  -p 8080:8080 \
  -v /path/to/config:/app/config \
  registry.example.com/nai-tizi:1.0.0
```

### æ–¹å¼ä¸‰ï¼šKubernetes éƒ¨ç½²

```bash
# 1. åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace nai-tizi

# 2. åˆ›å»º Secret
kubectl create secret generic nai-tizi-config \
  --from-file=conf.prod.yaml \
  -n nai-tizi

# 3. éƒ¨ç½²åº”ç”¨
kubectl apply -f k8s/deployment.yaml -n nai-tizi
kubectl apply -f k8s/service.yaml -n nai-tizi
kubectl apply -f k8s/ingress.yaml -n nai-tizi

# 4. æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
kubectl get pods -n nai-tizi -w
kubectl describe pod <pod-name> -n nai-tizi
```

---

## ğŸ” éƒ¨ç½²åéªŒè¯

### 1. åŸºç¡€éªŒè¯

```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
curl http://your-domain/health

# æ£€æŸ¥ API æ˜¯å¦å¯è®¿é—®
curl http://your-domain/swagger/index.html

# æµ‹è¯•ç™»å½•æ¥å£
curl -X POST http://your-domain/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password"}'
```

### 2. å¥åº·æ£€æŸ¥éªŒè¯

```bash
# åŸºç¡€å¥åº·æ£€æŸ¥
curl http://your-domain/health

# å°±ç»ªæ£€æŸ¥
curl http://your-domain/health/ready

# å­˜æ´»æ£€æŸ¥
curl http://your-domain/health/live

# å¯åŠ¨æ£€æŸ¥
curl http://your-domain/health/startup
```

### 3. åŠŸèƒ½éªŒè¯

- [ ] ç”¨æˆ·ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] Token åˆ·æ–°åŠŸèƒ½æ­£å¸¸
- [ ] æƒé™æ§åˆ¶åŠŸèƒ½æ­£å¸¸
- [ ] æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æ­£å¸¸
- [ ] æ•°æ®åº“è¯»å†™æ­£å¸¸
- [ ] Redis ç¼“å­˜æ­£å¸¸

### 4. æ€§èƒ½éªŒè¯

```bash
# ä½¿ç”¨ ab è¿›è¡Œå‹åŠ›æµ‹è¯•
ab -n 1000 -c 10 http://your-domain/health

# ä½¿ç”¨ wrk è¿›è¡Œå‹åŠ›æµ‹è¯•
wrk -t4 -c100 -d30s http://your-domain/health
```

### 5. ç›‘æ§éªŒè¯

- [ ] æ—¥å¿—æ­£å¸¸è¾“å‡º
- [ ] ç›‘æ§æŒ‡æ ‡æ­£å¸¸é‡‡é›†
- [ ] å‘Šè­¦è§„åˆ™æ­£å¸¸è§¦å‘
- [ ] é“¾è·¯è¿½è¸ªæ­£å¸¸å·¥ä½œ

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

**æ£€æŸ¥é¡¹ï¼š**
1. é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®
2. æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
3. Redis è¿æ¥æ˜¯å¦æ­£å¸¸
4. ç«¯å£æ˜¯å¦è¢«å ç”¨
5. æ—¥å¿—æ–‡ä»¶æƒé™æ˜¯å¦æ­£ç¡®

**æ’æŸ¥å‘½ä»¤ï¼š**
```bash
# æŸ¥çœ‹æ—¥å¿—
tail -f logs/app.log

# æ£€æŸ¥ç«¯å£
netstat -tlnp | grep 8080

# æµ‹è¯•æ•°æ®åº“è¿æ¥
psql -h <host> -U <user> -d <db>

# æµ‹è¯• Redis è¿æ¥
redis-cli -h <host> ping
```

### å¥åº·æ£€æŸ¥å¤±è´¥

**æ£€æŸ¥é¡¹ï¼š**
1. æ•°æ®åº“æ˜¯å¦å¯è®¿é—®
2. Redis æ˜¯å¦å¯è®¿é—®
3. ç½‘ç»œç­–ç•¥æ˜¯å¦æ­£ç¡®
4. é˜²ç«å¢™è§„åˆ™æ˜¯å¦æ­£ç¡®

**æ’æŸ¥å‘½ä»¤ï¼š**
```bash
# æŸ¥çœ‹ Pod æ—¥å¿—
kubectl logs <pod-name> -n nai-tizi

# æŸ¥çœ‹ Pod äº‹ä»¶
kubectl describe pod <pod-name> -n nai-tizi

# è¿›å…¥å®¹å™¨è°ƒè¯•
kubectl exec -it <pod-name> -n nai-tizi -- /bin/sh
```

### ä¼˜é›…å…³é—­å¤±è´¥

**æ£€æŸ¥é¡¹ï¼š**
1. terminationGracePeriodSeconds æ˜¯å¦è¶³å¤Ÿ
2. æ˜¯å¦æœ‰é•¿æ—¶é—´è¿è¡Œçš„è¯·æ±‚
3. èµ„æºæ¸…ç†æ˜¯å¦æ­£å¸¸

**æ’æŸ¥å‘½ä»¤ï¼š**
```bash
# æŸ¥çœ‹å®¹å™¨é€€å‡ºæ—¥å¿—
docker logs <container-id>

# æŸ¥çœ‹ Pod åˆ é™¤è¿‡ç¨‹
kubectl delete pod <pod-name> -n nai-tizi --v=8
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ•°æ®åº“ä¼˜åŒ–

- æ·»åŠ é€‚å½“çš„ç´¢å¼•
- é…ç½®è¿æ¥æ± å¤§å°
- å¯ç”¨æŸ¥è¯¢ç¼“å­˜
- å®šæœŸæ‰§è¡Œ VACUUM

### 2. Redis ä¼˜åŒ–

- é…ç½®åˆé€‚çš„è¿‡æœŸç­–ç•¥
- å¯ç”¨æŒä¹…åŒ–ï¼ˆå¦‚éœ€è¦ï¼‰
- é…ç½®æœ€å¤§å†…å­˜é™åˆ¶
- ä½¿ç”¨è¿æ¥æ± 

### 3. åº”ç”¨ä¼˜åŒ–

- å¯ç”¨ GZIP å‹ç¼©
- é…ç½®é™æ€èµ„æºç¼“å­˜
- ä½¿ç”¨ CDN åŠ é€Ÿ
- å¯ç”¨ HTTP/2

### 4. Kubernetes ä¼˜åŒ–

- é…ç½® HPA è‡ªåŠ¨æ‰©ç¼©å®¹
- ä½¿ç”¨ PDB ä¿è¯å¯ç”¨æ€§
- é…ç½®èµ„æº QoS
- ä½¿ç”¨äº²å’Œæ€§è°ƒåº¦

---

## ğŸ“ å›æ»šè®¡åˆ’

### å¿«é€Ÿå›æ»š

```bash
# Kubernetes å›æ»š
kubectl rollout undo deployment/nai-tizi -n nai-tizi

# Docker å›æ»š
docker stop nai-tizi
docker rm nai-tizi
docker run -d --name nai-tizi registry.example.com/nai-tizi:previous-version
```

### æ•°æ®åº“å›æ»š

```bash
# æ¢å¤æ•°æ®åº“å¤‡ä»½
psql -U postgres -d nai_tizi < backup_20241228.sql
```

---

## ğŸ¯ æ€»ç»“

### ç”Ÿäº§ç¯å¢ƒå°±ç»ªåº¦ï¼š95%

**å·²å®Œæˆï¼š**
- âœ… ä¼˜é›…å…³é—­æœºåˆ¶
- âœ… å®Œæ•´çš„å¥åº·æ£€æŸ¥
- âœ… è¯¦ç»†çš„éƒ¨ç½²æ–‡æ¡£
- âœ… æµ‹è¯•è„šæœ¬
- âœ… æ•…éšœæ’æŸ¥æŒ‡å—

**å»ºè®®è¡¥å……ï¼š**
- âš ï¸ Docker é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
- âš ï¸ Kubernetes é…ç½®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
- âš ï¸ CI/CD é…ç½®ï¼ˆå¯é€‰ï¼‰

### ä¸‹ä¸€æ­¥

1. æ ¹æ®å®é™…éƒ¨ç½²ç¯å¢ƒå‡†å¤‡é…ç½®æ–‡ä»¶
2. æ‰§è¡Œéƒ¨ç½²å‰æ£€æŸ¥æ¸…å•
3. æŒ‰ç…§éƒ¨ç½²æ­¥éª¤è¿›è¡Œéƒ¨ç½²
4. æ‰§è¡Œéƒ¨ç½²åéªŒè¯
5. é…ç½®ç›‘æ§å‘Šè­¦

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0.0  
**æœ€åæ›´æ–°ï¼š** 2024-12-28  
**ç»´æŠ¤è€…ï¼š** é¡¹ç›®å›¢é˜Ÿ
