# éƒ¨ç½²ä¸ç›‘æ§å®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æ±‡æ€»äº†é¡¹ç›®çš„å®Œæ•´éƒ¨ç½²ä¸ç›‘æ§è§£å†³æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æ‰€æœ‰é…ç½®æ–‡ä»¶ã€é›†æˆä»£ç å’Œä½¿ç”¨æŒ‡å—ã€‚

---

## ğŸ¯ å·²å®Œæˆçš„å·¥ä½œ

### 1. éƒ¨ç½²é…ç½®æ–‡ä»¶

#### Docker é…ç½®
- **Dockerfile** - å¤šé˜¶æ®µæ„å»ºï¼Œä¼˜åŒ–é•œåƒå¤§å°
- **.dockerignore** - æ’é™¤ä¸å¿…è¦æ–‡ä»¶
- **docker-compose.yml** - å¼€å‘ç¯å¢ƒå®Œæ•´é…ç½®
- **docker-compose.monitoring.yml** - ç›‘æ§ç³»ç»Ÿé…ç½®
- **.env.example** - ç¯å¢ƒå˜é‡æ¨¡æ¿

#### ç›‘æ§é…ç½®
- **monitoring/prometheus.yml** - Prometheus ä¸»é…ç½®
- **monitoring/alerts/api-alerts.yml** - å‘Šè­¦è§„åˆ™
- **monitoring/alertmanager/config.yml** - å‘Šè­¦è·¯ç”±é…ç½®

### 2. åº”ç”¨é›†æˆä»£ç 

#### Prometheus æŒ‡æ ‡æ”¶é›†
- **internal/infrastructure/metrics/prometheus.go** - æŒ‡æ ‡å®šä¹‰
- **internal/middleware/prometheus.go** - æŒ‡æ ‡æ”¶é›†ä¸­é—´ä»¶

### 3. æ–‡æ¡£

- **Dockeréƒ¨ç½²æŒ‡å—.md** - è¯¦ç»†çš„ Docker éƒ¨ç½²è¯´æ˜
- **ç›‘æ§ç³»ç»Ÿé…ç½®.md** - å®Œæ•´çš„ç›‘æ§ç³»ç»Ÿé…ç½®
- **å¿«é€Ÿéƒ¨ç½²æŒ‡å—.md** - å¿«é€Ÿå¯åŠ¨æŒ‡å—
- **åå°ç®¡ç†ç³»ç»Ÿè„šæ‰‹æ¶åŠŸèƒ½ç¼ºå¤±åˆ†æ.md** - åŠŸèƒ½è¯„ä¼°æŠ¥å‘Š

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æœ€å°åŒ–å¯åŠ¨ï¼ˆ5åˆ†é’Ÿï¼‰

```bash
# 1. åˆ›å»ºç½‘ç»œ
docker network create app-network

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env

# 3. å¯åŠ¨åº”ç”¨
docker-compose up -d

# 4. éªŒè¯æœåŠ¡
curl http://localhost:8080/health
```

### å®Œæ•´å¯åŠ¨ï¼ˆå«ç›‘æ§ï¼‰

```bash
# å¯åŠ¨åº”ç”¨æœåŠ¡
docker-compose up -d

# å¯åŠ¨ç›‘æ§æœåŠ¡
docker-compose -f docker-compose.monitoring.yml up -d

# è®¿é—®æœåŠ¡
open http://localhost:8080/swagger/index.html  # API æ–‡æ¡£
open http://localhost:3000                      # Grafana
open http://localhost:9090                      # Prometheus
open http://localhost:16686                     # Jaeger
```

---

## ğŸ“Š ç›‘æ§æ¶æ„

### ä¸‰æ”¯æŸ±å¯è§‚æµ‹æ€§

```
åº”ç”¨å±‚ (API)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡    â”‚ è¿½è¸ª    â”‚ æ—¥å¿—    â”‚
â”‚Prometheusâ”‚ Jaeger â”‚  ELK   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å¯è§†åŒ–å±‚ (Grafana)
```

### ç›‘æ§æŒ‡æ ‡

**HTTP æŒ‡æ ‡**
- `http_requests_total` - è¯·æ±‚æ€»æ•°ï¼ˆæŒ‰æ–¹æ³•ã€è·¯å¾„ã€çŠ¶æ€ç ï¼‰
- `http_request_duration_seconds` - è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ

**æ•°æ®åº“æŒ‡æ ‡**
- `db_query_duration_seconds` - æŸ¥è¯¢å»¶è¿Ÿ
- `db_connection_pool_size` - è¿æ¥æ± å¤§å°
- `db_connection_pool_idle` - ç©ºé—²è¿æ¥æ•°
- `db_connection_pool_in_use` - ä½¿ç”¨ä¸­è¿æ¥æ•°

**Redis æŒ‡æ ‡**
- `redis_operation_duration_seconds` - æ“ä½œå»¶è¿Ÿ

**ç³»ç»ŸæŒ‡æ ‡**
- `active_connections` - æ´»è·ƒè¿æ¥æ•°
- CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡ï¼ˆé€šè¿‡ node-exporterï¼‰

### å‘Šè­¦è§„åˆ™

**å…³é”®å‘Šè­¦**
- API æœåŠ¡ä¸å¯ç”¨ï¼ˆ1åˆ†é’Ÿï¼‰
- é«˜é”™è¯¯ç‡ï¼ˆ>5%ï¼ŒæŒç»­5åˆ†é’Ÿï¼‰
- é«˜å»¶è¿Ÿï¼ˆP95 >1ç§’ï¼ŒæŒç»­5åˆ†é’Ÿï¼‰

**èµ„æºå‘Šè­¦**
- CPU ä½¿ç”¨ç‡ >80%ï¼ˆæŒç»­10åˆ†é’Ÿï¼‰
- å†…å­˜ä½¿ç”¨ç‡ >85%ï¼ˆæŒç»­10åˆ†é’Ÿï¼‰
- ç£ç›˜ä½¿ç”¨ç‡ >85%ï¼ˆæŒç»­10åˆ†é’Ÿï¼‰

**æ•°æ®åº“å‘Šè­¦**
- è¿æ¥æ•° >80ï¼ˆæŒç»­5åˆ†é’Ÿï¼‰
- æ…¢æŸ¥è¯¢ï¼ˆå¹³å‡ >1ç§’ï¼ŒæŒç»­5åˆ†é’Ÿï¼‰

---

## ğŸ”§ é›†æˆæ­¥éª¤

### æ­¥éª¤ 1ï¼šå®‰è£…ä¾èµ–

Prometheus å®¢æˆ·ç«¯åº“å·²é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š

```bash
go get github.com/prometheus/client_golang/prometheus
go get github.com/prometheus/client_golang/prometheus/promauto
go get github.com/prometheus/client_golang/prometheus/promhttp
```

### æ­¥éª¤ 2ï¼šæ³¨å†Œä¸­é—´ä»¶

åœ¨ `internal/router/router.go` ä¸­æ·»åŠ ï¼š

```go
import (
    "github.com/force-c/nai-tizi/internal/middleware"
    "github.com/prometheus/client_golang/prometheus/promhttp"
)

func SetupRouter() *gin.Engine {
    r := gin.Default()
    
    // æ·»åŠ  Prometheus ä¸­é—´ä»¶
    r.Use(middleware.PrometheusMiddleware())
    
    // æš´éœ² metrics ç«¯ç‚¹
    r.GET("/metrics", gin.WrapH(promhttp.Handler()))
    
    // å…¶ä»–è·¯ç”±é…ç½®...
    
    return r
}
```

### æ­¥éª¤ 3ï¼šå¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨åº”ç”¨å’Œç›‘æ§
docker-compose up -d
docker-compose -f docker-compose.monitoring.yml up -d

# éªŒè¯ metrics ç«¯ç‚¹
curl http://localhost:8080/metrics
```

---

## ğŸ“ˆ Grafana Dashboard é…ç½®

### æ·»åŠ æ•°æ®æº

1. è®¿é—® http://localhost:3000
2. ç™»å½•ï¼ˆadmin/adminï¼‰
3. Configuration â†’ Data Sources â†’ Add data source
4. é€‰æ‹© Prometheus
5. URL: http://prometheus:9090
6. Save & Test

### å¯¼å…¥ Dashboard

æ¨èçš„ Dashboard IDï¼š
- **1860** - Node Exporter Full
- **7362** - PostgreSQL Database
- **763** - Redis Dashboard
- **6417** - Kubernetes Cluster Monitoring

æˆ–åˆ›å»ºè‡ªå®šä¹‰ Dashboardï¼š

**API æ€§èƒ½é¢æ¿**
```promql
# è¯·æ±‚é€Ÿç‡
rate(http_requests_total[5m])

# é”™è¯¯ç‡
rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m])

# P95 å»¶è¿Ÿ
histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))

# P99 å»¶è¿Ÿ
histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))
```

---

## ğŸ” é“¾è·¯è¿½è¸ªé›†æˆ

### Jaeger é›†æˆï¼ˆå¯é€‰ï¼‰

å¦‚éœ€å¯ç”¨é“¾è·¯è¿½è¸ªï¼Œéœ€è¦é¢å¤–é›†æˆï¼š

```bash
go get github.com/opentracing/opentracing-go
go get github.com/uber/jaeger-client-go
```

åœ¨ `cmd/api/main.go` ä¸­åˆå§‹åŒ–ï¼š

```go
import (
    "github.com/force-c/nai-tizi/internal/infrastructure/tracing"
)

func main() {
    // åˆå§‹åŒ– Jaeger
    tracer, closer, err := tracing.InitJaeger("nai-tizi-api")
    if err != nil {
        log.Fatal(err)
    }
    defer closer.Close()
    
    // å…¶ä»–åˆå§‹åŒ–ä»£ç ...
}
```

---

## ğŸ”’ ç”Ÿäº§ç¯å¢ƒæ¸…å•

### å®‰å…¨é…ç½®

- [ ] ä¿®æ”¹æ‰€æœ‰é»˜è®¤å¯†ç ï¼ˆæ•°æ®åº“ã€Redisã€MinIOã€Grafanaï¼‰
- [ ] é…ç½® JWT å¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨å¼ºå¯†é’¥ï¼‰
- [ ] å¯ç”¨ HTTPS/TLS
- [ ] é…ç½®é˜²ç«å¢™è§„åˆ™
- [ ] é™åˆ¶å®¹å™¨èµ„æºä½¿ç”¨
- [ ] é…ç½®æ—¥å¿—è½®è½¬
- [ ] å¯ç”¨è®¿é—®æ§åˆ¶

### ç›‘æ§é…ç½®

- [ ] é…ç½®å‘Šè­¦æ¥æ”¶å™¨ï¼ˆé‚®ä»¶ã€Webhookã€Slackï¼‰
- [ ] è®¾ç½®å‘Šè­¦é˜ˆå€¼
- [ ] é…ç½® Grafana Dashboard
- [ ] å¯ç”¨æ—¥å¿—èšåˆï¼ˆELK Stackï¼‰
- [ ] é…ç½®é“¾è·¯è¿½è¸ªï¼ˆJaegerï¼‰

### è¿ç»´é…ç½®

- [ ] é…ç½®è‡ªåŠ¨å¤‡ä»½ç­–ç•¥
- [ ] è®¾ç½®å¥åº·æ£€æŸ¥
- [ ] é…ç½®è‡ªåŠ¨é‡å¯ç­–ç•¥
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆ
- [ ] æ–‡æ¡£åŒ–è¿ç»´æµç¨‹

---

## ğŸ“ å¸¸ç”¨å‘½ä»¤

### Docker æ“ä½œ

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f api

# é‡å¯æœåŠ¡
docker-compose restart api

# é‡æ–°æ„å»º
docker-compose up -d --build

# åœæ­¢æ‰€æœ‰æœåŠ¡
docker-compose down

# åœæ­¢å¹¶åˆ é™¤æ•°æ®å·
docker-compose down -v
```

### ç›‘æ§æ“ä½œ

```bash
# æŸ¥çœ‹ Prometheus ç›®æ ‡çŠ¶æ€
curl http://localhost:9090/api/v1/targets

# æŸ¥çœ‹å‘Šè­¦çŠ¶æ€
curl http://localhost:9090/api/v1/alerts

# æµ‹è¯•å‘Šè­¦è§„åˆ™
promtool check rules monitoring/alerts/api-alerts.yml
```

### æ•°æ®åº“æ“ä½œ

```bash
# å¤‡ä»½æ•°æ®åº“
docker exec nai-tizi-postgres pg_dump -U postgres nai_tizi > backup.sql

# æ¢å¤æ•°æ®åº“
docker exec -i nai-tizi-postgres psql -U postgres -d nai_tizi < backup.sql

# æŸ¥çœ‹æ•°æ®åº“è¿æ¥
docker exec -it nai-tizi-postgres psql -U postgres -d nai_tizi -c "SELECT * FROM pg_stat_activity;"
```

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### åº”ç”¨å±‚

1. **å¯ç”¨è¿æ¥æ± **
   - æ•°æ®åº“è¿æ¥æ± ï¼šæœ€å¤§è¿æ¥æ•° 100
   - Redis è¿æ¥æ± ï¼šæœ€å¤§è¿æ¥æ•° 50

2. **å¯ç”¨ç¼“å­˜**
   - ä½¿ç”¨ Redis ç¼“å­˜çƒ­ç‚¹æ•°æ®
   - è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´

3. **å¼‚æ­¥å¤„ç†**
   - ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†è€—æ—¶ä»»åŠ¡
   - é¿å…é˜»å¡ä¸»çº¿ç¨‹

### æ•°æ®åº“å±‚

1. **ç´¢å¼•ä¼˜åŒ–**
   - ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
   - å®šæœŸåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—

2. **æŸ¥è¯¢ä¼˜åŒ–**
   - é¿å… N+1 æŸ¥è¯¢
   - ä½¿ç”¨æ‰¹é‡æ“ä½œ

3. **è¿æ¥ç®¡ç†**
   - åˆç†é…ç½®è¿æ¥æ± å¤§å°
   - åŠæ—¶é‡Šæ”¾è¿æ¥

### å®¹å™¨å±‚

1. **èµ„æºé™åˆ¶**
   ```yaml
   deploy:
     resources:
       limits:
         cpus: '1'
         memory: 1G
       reservations:
         cpus: '0.5'
         memory: 512M
   ```

2. **å¥åº·æ£€æŸ¥**
   ```yaml
   healthcheck:
     test: ["CMD", "wget", "--spider", "http://localhost:8080/health"]
     interval: 30s
     timeout: 3s
     retries: 3
   ```

---

## ğŸ†˜ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

**1. å®¹å™¨æ— æ³•å¯åŠ¨**
```bash
# æ£€æŸ¥æ—¥å¿—
docker-compose logs api

# æ£€æŸ¥ç«¯å£å ç”¨
lsof -i :8080

# æ¸…ç†å¹¶é‡å¯
docker-compose down && docker-compose up -d
```

**2. ç›‘æ§æ•°æ®ä¸æ˜¾ç¤º**
```bash
# æ£€æŸ¥ Prometheus ç›®æ ‡
curl http://localhost:9090/api/v1/targets

# æ£€æŸ¥ metrics ç«¯ç‚¹
curl http://localhost:8080/metrics

# é‡å¯ Prometheus
docker-compose -f docker-compose.monitoring.yml restart prometheus
```

**3. å‘Šè­¦ä¸è§¦å‘**
```bash
# æ£€æŸ¥å‘Šè­¦è§„åˆ™
promtool check rules monitoring/alerts/api-alerts.yml

# æŸ¥çœ‹å‘Šè­¦çŠ¶æ€
curl http://localhost:9090/api/v1/alerts

# æ£€æŸ¥ Alertmanager é…ç½®
docker-compose -f docker-compose.monitoring.yml logs alertmanager
```

---

## ğŸ“š ç›¸å…³èµ„æº

### å®˜æ–¹æ–‡æ¡£

- [Prometheus æ–‡æ¡£](https://prometheus.io/docs/)
- [Grafana æ–‡æ¡£](https://grafana.com/docs/)
- [Jaeger æ–‡æ¡£](https://www.jaegertracing.io/docs/)
- [Docker æ–‡æ¡£](https://docs.docker.com/)

### æ¨èé˜…è¯»

- [Google SRE Book](https://sre.google/books/)
- [The Twelve-Factor App](https://12factor.net/)
- [Prometheus æœ€ä½³å®è·µ](https://prometheus.io/docs/practices/)

---

## ğŸ“ æ€»ç»“

### å·²å®ç°çš„åŠŸèƒ½

âœ… **éƒ¨ç½²é…ç½®**
- Docker å®¹å™¨åŒ–
- docker-compose ç¼–æ’
- ç¯å¢ƒå˜é‡ç®¡ç†
- å¥åº·æ£€æŸ¥

âœ… **ç›‘æ§ç³»ç»Ÿ**
- Prometheus æŒ‡æ ‡æ”¶é›†
- Grafana å¯è§†åŒ–
- Alertmanager å‘Šè­¦
- ç³»ç»Ÿèµ„æºç›‘æ§

âœ… **å¯è§‚æµ‹æ€§**
- HTTP è¯·æ±‚ç›‘æ§
- æ•°æ®åº“æ€§èƒ½ç›‘æ§
- Redis æ€§èƒ½ç›‘æ§
- é“¾è·¯è¿½è¸ªæ”¯æŒï¼ˆé…ç½®å·²æä¾›ï¼‰

âœ… **æ–‡æ¡£**
- éƒ¨ç½²æŒ‡å—
- ç›‘æ§é…ç½®
- å¿«é€Ÿå¼€å§‹
- æ•…éšœæ’æŸ¥

### ä¸‹ä¸€æ­¥å»ºè®®

æ ¹æ®åŠŸèƒ½ç¼ºå¤±åˆ†æï¼Œå»ºè®®æŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§ç»§ç»­å®Œå–„ï¼š

**Phase 1ï¼ˆå·²å®Œæˆï¼‰**
- âœ… Docker é…ç½®
- âœ… ç›‘æ§ç³»ç»Ÿé…ç½®
- âœ… Prometheus é›†æˆ

**Phase 2ï¼ˆå»ºè®®å®æ–½ï¼‰**
- âš ï¸ CI/CD é…ç½®ï¼ˆGitHub Actions / GitLab CIï¼‰
- âš ï¸ Kubernetes éƒ¨ç½²é…ç½®
- âš ï¸ æ—¥å¿—èšåˆï¼ˆELK Stackï¼‰

**Phase 3ï¼ˆæŒ‰éœ€å®æ–½ï¼‰**
- âš ï¸ å®‰å…¨å¢å¼ºï¼ˆéªŒè¯ç ã€API ç­¾åï¼‰
- âš ï¸ æ€§èƒ½æµ‹è¯•
- âš ï¸ è‡ªåŠ¨åŒ–æµ‹è¯•

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2026-01-12  
**ç»´æŠ¤è€…ï¼š** é¡¹ç›®å›¢é˜Ÿ
