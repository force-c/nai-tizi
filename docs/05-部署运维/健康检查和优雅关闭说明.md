# 健康检查和优雅关闭说明

## 概述

本文档说明项目中实现的健康检查和优雅关闭功能，这些功能对于生产环境部署和 Kubernetes 集群部署至关重要。

---

## 1. 优雅关闭（Graceful Shutdown）

### 功能说明

优雅关闭确保服务在收到终止信号时能够：
1. 停止接收新的请求
2. 等待正在处理的请求完成
3. 清理资源（关闭数据库连接、Redis 连接等）
4. 安全退出

### 实现原理

```go
// 监听系统信号
quit := make(chan os.Signal, 1)
signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
<-quit

// 设置 30 秒超时
ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
defer cancel()

// 优雅关闭
srv.Shutdown(ctx)
```

### 支持的信号

- **SIGINT**：Ctrl+C 触发（开发环境）
- **SIGTERM**：Docker/Kubernetes 发送的终止信号（生产环境）

### 关闭流程

1. 收到终止信号
2. 停止接收新请求
3. 等待现有请求处理完成（最多 30 秒）
4. 关闭容器中的所有服务（数据库、Redis、调度器等）
5. 记录日志并退出

### 超时设置

- **HTTP 服务器关闭超时**：30 秒
- **读取超时**：30 秒
- **写入超时**：30 秒

如果 30 秒内请求未完成，服务器将强制关闭。

### 日志输出

```
INFO  shutting down server...
INFO  server exited gracefully
```

---

## 2. 健康检查（Health Check）

### 功能说明

提供多个健康检查端点，用于监控服务状态和 Kubernetes 探针。

### 健康检查端点

#### 2.1 基础健康检查

**端点：** `GET /health`

**用途：** 全面的健康状态检查，包含所有依赖服务

**响应示例：**

```json
{
  "status": "healthy",
  "timestamp": "2024-12-28T21:30:00Z",
  "version": "1.0.0",
  "uptime": "2h 15m 30s",
  "services": {
    "database": "up",
    "redis": "up"
  }
}
```

**状态码：**
- `200`：服务健康
- `503`：服务不健康（任一依赖服务异常）

**字段说明：**
- `status`：总体状态（healthy/unhealthy）
- `timestamp`：检查时间
- `version`：应用版本号
- `uptime`：服务运行时长
- `services`：各依赖服务状态

#### 2.2 就绪检查（Readiness Probe）

**端点：** `GET /health/ready`

**用途：** Kubernetes Readiness Probe，检查服务是否准备好接收流量

**响应示例：**

```json
{
  "status": "ready",
  "message": "service is ready to accept traffic"
}
```

**失败响应：**

```json
{
  "status": "not ready",
  "reason": "database connection failed",
  "message": "dial tcp: connection refused"
}
```

**状态码：**
- `200`：服务就绪
- `503`：服务未就绪

**检查项：**
- 数据库连接是否正常
- Redis 连接是否正常

#### 2.3 存活检查（Liveness Probe）

**端点：** `GET /health/live`

**用途：** Kubernetes Liveness Probe，检查服务进程是否存活

**响应示例：**

```json
{
  "status": "alive",
  "message": "service is alive",
  "uptime": "2h 15m 30s"
}
```

**状态码：**
- `200`：服务存活

**特点：**
- 不检查依赖服务
- 只确认进程还在运行
- 避免因依赖问题导致容器被重启

#### 2.4 启动检查（Startup Probe）

**端点：** `GET /health/startup`

**用途：** Kubernetes Startup Probe，检查服务是否已完成启动

**响应示例：**

```json
{
  "status": "started",
  "message": "service has started successfully"
}
```

**失败响应：**

```json
{
  "status": "starting",
  "message": "service is still starting up"
}
```

**状态码：**
- `200`：启动完成
- `503`：启动中

**检查逻辑：**
1. 服务运行时间 > 5 秒
2. 数据库连接正常

---

## 3. Kubernetes 配置示例

### 3.1 Deployment 配置

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nai-tizi-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nai-tizi-api
  template:
    metadata:
      labels:
        app: nai-tizi-api
    spec:
      containers:
      - name: api
        image: nai-tizi:latest
        ports:
        - containerPort: 8080
        
        # 启动探针：检查服务是否启动完成
        startupProbe:
          httpGet:
            path: /health/startup
            port: 8080
          initialDelaySeconds: 0
          periodSeconds: 5
          timeoutSeconds: 2
          failureThreshold: 30  # 最多等待 150 秒（5s * 30）
        
        # 就绪探针：检查服务是否准备好接收流量
        readinessProbe:
          httpGet:
            path: /health/ready
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
          timeoutSeconds: 2
          successThreshold: 1
          failureThreshold: 3
        
        # 存活探针：检查服务是否存活
        livenessProbe:
          httpGet:
            path: /health/live
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 30
          timeoutSeconds: 2
          failureThreshold: 3
        
        # 优雅关闭配置
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "sleep 15"]
        
        # 资源限制
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
```

### 3.2 探针配置说明

#### Startup Probe（启动探针）
- **作用**：保护慢启动容器
- **配置**：
  - `initialDelaySeconds: 0`：立即开始检查
  - `periodSeconds: 5`：每 5 秒检查一次
  - `failureThreshold: 30`：最多失败 30 次（150 秒）
- **建议**：启动探针成功后才会启用就绪和存活探针

#### Readiness Probe（就绪探针）
- **作用**：控制流量路由
- **配置**：
  - `initialDelaySeconds: 5`：启动 5 秒后开始检查
  - `periodSeconds: 10`：每 10 秒检查一次
  - `failureThreshold: 3`：连续失败 3 次标记为未就绪
- **效果**：未就绪的 Pod 不会接收流量

#### Liveness Probe（存活探针）
- **作用**：检测死锁或无响应
- **配置**：
  - `initialDelaySeconds: 30`：启动 30 秒后开始检查
  - `periodSeconds: 30`：每 30 秒检查一次
  - `failureThreshold: 3`：连续失败 3 次重启容器
- **注意**：不要设置太敏感，避免误杀

### 3.3 优雅关闭配置

```yaml
lifecycle:
  preStop:
    exec:
      command: ["/bin/sh", "-c", "sleep 15"]
```

**说明：**
1. Kubernetes 发送 SIGTERM 信号
2. 同时执行 preStop 钩子（sleep 15 秒）
3. 15 秒后，如果容器还未退出，发送 SIGKILL 强制终止
4. 应用收到 SIGTERM 后开始优雅关闭（30 秒超时）

**时间线：**
```
0s:  收到 SIGTERM，开始优雅关闭
15s: preStop 钩子结束
30s: 应用优雅关闭超时
45s: Kubernetes terminationGracePeriodSeconds 默认值
```

---

## 4. 监控告警

### 4.1 Prometheus 监控

可以使用 Prometheus 监控健康检查端点：

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'nai-tizi-health'
    metrics_path: '/health'
    scrape_interval: 30s
    static_configs:
      - targets: ['nai-tizi-api:8080']
```

### 4.2 告警规则

```yaml
# alert-rules.yml
groups:
  - name: nai-tizi-health
    rules:
      - alert: ServiceUnhealthy
        expr: up{job="nai-tizi-health"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Service is unhealthy"
          description: "{{ $labels.instance }} has been unhealthy for more than 1 minute"
```

---

## 5. 测试方法

### 5.1 本地测试

```bash
# 启动服务
go run cmd/api/main.go

# 测试健康检查
curl http://localhost:8080/health
curl http://localhost:8080/health/ready
curl http://localhost:8080/health/live
curl http://localhost:8080/health/startup

# 测试优雅关闭
# 按 Ctrl+C，观察日志输出
```

### 5.2 Docker 测试

```bash
# 构建镜像
docker build -t nai-tizi:test .

# 运行容器
docker run -p 8080:8080 nai-tizi:test

# 测试健康检查
curl http://localhost:8080/health

# 测试优雅关闭
docker stop <container_id>
# 观察容器日志
docker logs <container_id>
```

### 5.3 Kubernetes 测试

```bash
# 部署应用
kubectl apply -f deployment.yaml

# 查看 Pod 状态
kubectl get pods -w

# 查看探针状态
kubectl describe pod <pod-name>

# 测试优雅关闭
kubectl delete pod <pod-name>
# 观察 Pod 日志
kubectl logs <pod-name> -f
```

---

## 6. 最佳实践

### 6.1 探针配置建议

1. **启动探针**
   - 设置足够长的失败阈值
   - 适用于启动慢的应用

2. **就绪探针**
   - 检查所有依赖服务
   - 失败时停止接收流量
   - 不要太敏感

3. **存活探针**
   - 只检查进程是否存活
   - 不检查依赖服务
   - 避免误杀

### 6.2 优雅关闭建议

1. **超时时间**
   - HTTP 关闭超时：30 秒
   - preStop 钩子：15 秒
   - terminationGracePeriodSeconds：45 秒

2. **资源清理**
   - 关闭数据库连接
   - 关闭 Redis 连接
   - 停止定时任务
   - 清理临时文件

3. **日志记录**
   - 记录关闭开始
   - 记录关闭完成
   - 记录异常情况

---

## 7. 故障排查

### 7.1 健康检查失败

**问题：** `/health/ready` 返回 503

**排查步骤：**
1. 检查数据库连接：`psql -h <host> -U <user> -d <db>`
2. 检查 Redis 连接：`redis-cli -h <host> ping`
3. 查看应用日志：`kubectl logs <pod-name>`
4. 检查网络策略：`kubectl get networkpolicy`

### 7.2 优雅关闭超时

**问题：** 容器被强制终止

**排查步骤：**
1. 检查是否有长时间运行的请求
2. 增加 terminationGracePeriodSeconds
3. 优化请求处理时间
4. 检查数据库连接池配置

### 7.3 Pod 频繁重启

**问题：** 存活探针失败导致重启

**排查步骤：**
1. 检查探针配置是否太敏感
2. 增加 failureThreshold
3. 增加 periodSeconds
4. 检查应用是否真的死锁

---

## 8. 总结

### 已实现功能

✅ **优雅关闭**
- 监听 SIGINT/SIGTERM 信号
- 30 秒超时保护
- 完整的资源清理
- 详细的日志记录

✅ **健康检查**
- 基础健康检查（/health）
- Kubernetes 就绪探针（/health/ready）
- Kubernetes 存活探针（/health/live）
- Kubernetes 启动探针（/health/startup）

### 生产环境就绪

- ✅ 支持 Kubernetes 部署
- ✅ 支持滚动更新
- ✅ 支持零停机部署
- ✅ 支持监控告警
- ✅ 完整的日志记录

---

**文档版本：** v1.0.0  
**最后更新：** 2024-12-28  
**维护者：** 项目团队
