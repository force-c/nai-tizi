# 配置文件管理说明

## 配置文件结构

项目包含两类配置文件：

### 1. 应用主配置
- `conf.dev.yaml` - 开发环境配置
- `conf.prod.yaml` - 生产环境配置（需自行创建）
- `conf.staging.yaml` - 预发布环境配置（可选）

### 2. 日志配置
- `zaplogger.dev.yaml` - 开发环境日志配置
- `zaplogger.prod.yaml` - 生产环境日志配置
- `zaplogger.staging.yaml` - 预发布环境日志配置（可选）

## Git 版本控制策略

### ✅ 已纳入版本控制
- `conf.dev.yaml` - 开发环境配置（示例）
- `zaplogger.dev.yaml` - 开发日志配置（示例）

### ❌ 已忽略（不纳入版本控制）
- `conf.prod.yaml` - 生产环境配置（包含敏感信息）
- `conf.staging.yaml` - 预发布环境配置
- `zaplogger.prod.yaml` - 生产日志配置
- `zaplogger.staging.yaml` - 预发布日志配置

## 最佳实践

### 1. 开发环境
直接使用 `conf.dev.yaml` 和 `zaplogger.dev.yaml`，已包含在代码仓库中。

### 2. 生产环境

**第一步**：复制示例配置
```bash
# 复制主配置
cp cmd/api/conf.dev.yaml cmd/api/conf.prod.yaml

# 复制日志配置
cp cmd/api/zaplogger.dev.yaml cmd/api/zaplogger.prod.yaml
```

**第二步**：修改配置内容
编辑 `conf.prod.yaml`，修改为生产环境的实际配置：
- 数据库连接信息
- Redis 连接信息
- MQTT 服务器地址
- 微信小程序凭证
- 短信服务密钥
- 等等

编辑 `zaplogger.prod.yaml`，调整日志策略：
```yaml
level: info              # 生产环境使用 info 级别
output: file             # 仅输出到文件
encoding: json           # JSON 格式便于日志分析
file:
  path: /var/log/NTZ
  maxSize: 200
  maxAge: 30
```

### 3. 敏感信息保护

**⚠️ 重要提醒**：
- ✅ **DO**: 将包含敏感信息的配置文件添加到 `.gitignore`
- ❌ **DON'T**: 将生产环境配置提交到 Git 仓库
- ✅ **DO**: 使用环境变量或密钥管理系统（如 Vault）
- ❌ **DON'T**: 在代码中硬编码敏感信息

### 4. 配置文件模板

可以创建 `.example` 文件作为模板：

```bash
# 创建配置模板
cp cmd/api/conf.dev.yaml cmd/api/conf.prod.yaml.example
```

将 `conf.prod.yaml.example` 中的敏感信息替换为占位符：
```yaml
mysql:
  dsn: "root:PASSWORD@tcp(HOST:PORT)/DATABASE?parseTime=true&charset=utf8mb4&loc=Local"

redis:
  addr: "HOST:PORT"
  password: "PASSWORD"

jwt:
  secret: "CHANGE_THIS_TO_RANDOM_STRING"
```

然后将 `.example` 文件纳入版本控制，实际使用时复制并填写真实值。

## 环境变量

通过设置 `ADCS_APP_ENV` 环境变量切换配置：

```bash
# 开发环境（默认）
export ADCS_APP_ENV=dev
./bin/NTZ

# 生产环境
export ADCS_APP_ENV=prod
./bin/NTZ

# 预发布环境
export ADCS_APP_ENV=staging
./bin/NTZ
```

## Docker 部署

在 Docker 中使用配置文件：

```dockerfile
# Dockerfile 示例
COPY cmd/api/conf.prod.yaml /app/cmd/api/
COPY cmd/api/zaplogger.prod.yaml /app/cmd/api/

ENV ADCS_APP_ENV=prod
```

或使用 Docker 挂载：
```bash
docker run -v /path/to/conf.prod.yaml:/app/cmd/api/conf.prod.yaml \
           -v /path/to/zaplogger.prod.yaml:/app/cmd/api/zaplogger.prod.yaml \
           -e ADCS_APP_ENV=prod \
           NTZ:latest
```

## Kubernetes 部署

使用 ConfigMap 和 Secret：

```yaml
# ConfigMap for non-sensitive config
apiVersion: v1
kind: ConfigMap
metadata:
  name: NTZ-config
data:
  conf.prod.yaml: |
    server:
      port: 9000
    # ... 非敏感配置

---
# Secret for sensitive data
apiVersion: v1
kind: Secret
metadata:
  name: NTZ-secret
type: Opaque
stringData:
  mysql-dsn: "root:password@tcp(host:port)/db"
  redis-password: "password"
  jwt-secret: "secret"
```

## 配置验证

启动应用前验证配置文件：

```bash
# 检查配置文件语法
go run cmd/api/main.go --validate-config

# 或使用 YAML linter
yamllint cmd/api/conf.prod.yaml
```

## 故障排查

### 配置文件找不到
```
Error: failed to load config: open ./conf.prod.yaml: no such file or directory
```
**解决方案**：确保配置文件存在且路径正确。

### 配置格式错误
```
Error: failed to parse config file: yaml: line 10: mapping values are not allowed
```
**解决方案**：检查 YAML 格式，注意缩进和冒号后的空格。

### 环境变量未设置
默认使用 `dev` 环境，如需使用其他环境，必须设置 `ADCS_APP_ENV`。

## 安全建议

1. **定期轮换密钥**：定期更换 JWT secret、数据库密码等
2. **最小权限原则**：配置文件权限设为 `600`（仅所有者可读写）
3. **加密存储**：生产环境配置文件可考虑加密存储
4. **审计日志**：记录配置文件的修改历史
5. **备份配置**：定期备份生产环境配置（加密后存储）

## 参考

- [配置文件示例](cmd/api/conf.dev.yaml)
- [日志配置说明](docs/LOGGER_GUIDE.md)
